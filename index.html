<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Schedule</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root {
            --ana-blue-dark: #002D5A;
            --ana-blue-main: #004482;
            --ana-blue-sky: #0076cb;
            --ana-gradient: linear-gradient(135deg, #004482 0%, #0076cb 100%);
            --bg-gray: #f2f4f7;
            --plane-body: #ffffff;
            --plane-wing: #dce1e6;
            --text-main: #333;
            --danger: #d93025;
            --success: #1e8e3e;
            --gold: #d4af37;
            --diamond: #b9f2ff;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg-gray);
            margin: 0; padding: 0; color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        header {
            background-color: var(--ana-blue-dark);
            color: white; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header-left { display: flex; flex-direction: column; }
        .header-title { font-size: 1.2rem; font-weight: bold; }
        .mile-display { font-size: 0.8rem; color: var(--gold); font-weight: bold; margin-top: 2px; }
        .status-badge-header { font-size: 0.6rem; padding: 1px 5px; border-radius: 3px; margin-left: 5px; vertical-align: middle; }
        .st-BRONZE { background: #cd7f32; color: white; }
        .st-SAPPHIRE { background: #0f52ba; color: white; }
        .st-DIAMOND { background: var(--diamond); color: #004482; }
        .header-icon { font-size: 1.5rem; cursor: pointer; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

        /* Flight Card */
        .flight-card {
            background: white; border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative;
            overflow: hidden; border-top: 4px solid var(--ana-blue-main);
        }

        .noshow-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.7); display: flex;
            justify-content: center; align-items: center; z-index: 5; pointer-events: none;
        }
        .noshow-stamp {
            border: 4px solid var(--danger); color: var(--danger);
            padding: 10px 30px; font-size: 2rem; font-weight: 900;
            transform: rotate(-15deg); border-radius: 8px; background: white;
        }

        .card-inner { padding: 15px; }
        .route-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .city-box { text-align: center; width: 80px; }
        .city-code { font-size: 2rem; font-weight: 800; color: var(--ana-blue-dark); letter-spacing: 1px; line-height: 1; }
        .city-name { font-size: 0.7rem; color: #777; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .time-row {
            display: flex; justify-content: space-between; 
            background: #f4f7fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;
        }
        .time-box { text-align: center; flex: 1; }
        .time-label { font-size: 0.7rem; color: #666; font-weight: bold; }
        .time-value { font-size: 1.2rem; font-weight: bold; color: #333; }
        .duration-center { font-size: 0.8rem; color: #999; align-self: center; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; color: white; background: #999; }
        .badge-reserved { background: var(--ana-blue-sky); }
        .badge-checkin { background: var(--success); }
        .badge-noshow { background: var(--danger); }
        .badge-inflight { background: var(--ana-blue-main); animation: pulse 2s infinite; }
        .badge-arrived { background: var(--gold); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .boarding-pass { background: #f9f9f9; border-top: 1px dashed #ddd; padding: 12px; font-size: 0.8rem; }
        .mile-tag { color: var(--gold); font-weight: bold; font-size: 0.7rem; text-align: right; margin-top: 5px; }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 45, 90, 0.85); z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #f0f3f6; width: 95%; max-width: 480px; height: auto; max-height: 90vh;
            margin: 5vh auto; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;
        }
        .modal-header-ana { background: var(--ana-gradient); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .modal-footer { background: white; padding: 15px; border-top: 1px solid #ddd; }

        /* Inputs */
        .form-group { margin-bottom: 15px; background: white; padding: 15px; border-radius: 8px; }
        .form-group label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 8px; }
        select, input { 
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; 
            box-sizing: border-box; font-size: 1rem; background: #fff;
            -webkit-appearance: none; appearance: none;
        }

        /* Settings List */
        .airport-list { list-style: none; padding: 0; margin: 0; }
        .airport-item { 
            background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .airport-code-tag { background: var(--ana-blue-sky); color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; margin-right: 10px; }
        .delete-btn { color: var(--danger); background: none; border: none; font-size: 1.2rem; cursor: pointer; }

        /* Seat Map Elements */
        .plane-wrapper { position: relative; width: 280px; margin: 20px auto; padding-top: 60px; padding-bottom: 60px; }
        .fuselage { background: var(--plane-body); width: 100%; height: 100%; border-radius: 140px 140px 80px 80px; position: absolute; top: 0; left: 0; z-index: 1; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; }
        .cockpit { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); width: 50px; height: 20px; background: linear-gradient(to bottom, #333, #666); border-radius: 40% 40% 50% 50%; z-index: 2; }
        .wing-left, .wing-right { position: absolute; top: 300px; width: 100px; height: 180px; background: var(--plane-wing); z-index: 0; border: 1px solid #ccc; }
        .wing-left { left: -80px; transform: skewY(15deg); border-radius: 10% 0 0 80%; }
        .wing-right { right: -80px; transform: skewY(-15deg); border-radius: 0 10% 80% 0; }
        .seat-map-container { position: relative; z-index: 10; padding: 20px 10px; }
        .seat-row { display: flex; justify-content: center; gap: 5px; margin-bottom: 6px; }
        .aisle-gap { width: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #ccc; }
        .seat {
    width: 35px;
    height: 40px; /* å°‘ã—é«˜ãã™ã‚‹ */
    border: 1px solid #ccc;
    border-radius: 4px;
    display: flex;
    flex-direction: column; /* ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: white;
}
        .seat.selected { background: var(--ana-blue-main); color: white; }

        /* Buttons */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; text-align: center; }
        .btn-save { background: var(--ana-blue-dark); color: white; }
        .btn-add { background: var(--success); color: white; margin-top: 10px; }
        .btn-checkin { background: var(--success); color: white; padding: 10px; border-radius: 8px; margin-top: 10px; width: 100%; }
        .btn-disabled { background: #ccc !important; cursor: not-allowed; }

        .fab { position: fixed; bottom: 30px; right: 25px; width: 65px; height: 65px; background: var(--ana-gradient); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2.2rem; box-shadow: 0 8px 20px rgba(0,68,130,0.4); border: none; cursor: pointer; z-index: 90; }
        .in-app-banner {
        position: fixed; top: -100px; left: 0; width: 100%;
        background: var(--ana-blue-main); color: white;
        padding: 15px; text-align: center; font-weight: bold;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 2000; display: flex; align-items: center; justify-content: center; gap: 10px;
        cursor: pointer;
    }
    .in-app-banner.show { top: 0; }
    .swipe-container {
        position: relative;
        width: 100%;
        height: 50px;
        background: #eee;
        border-radius: 25px;
        margin-top: 15px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #777;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .swipe-handle {
        position: absolute;
        left: 0;
        top: 0;
        width: 60px;
        height: 50px;
        background: var(--ana-gradient);
        border-radius: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        z-index: 10;
        cursor: grab;
        touch-action: none;
    }

    /* åˆ‡ã‚Šé›¢ã—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .stub-tear {
        animation: tear-off 0.6s forwards ease-out;
    }

    @keyframes tear-off {
        0% { transform: rotate(0deg) translateY(0); opacity: 1; }
        30% { transform: rotate(5deg) translateY(10px); opacity: 1; }
        100% { transform: rotate(15deg) translateY(100px); opacity: 0; }
    }
    /* ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.tab-container {
    display: flex;
    background: white;
    border-bottom: 1px solid #ddd;
    position: sticky;
    top: 60px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã«åˆã‚ã›ã¦èª¿æ•´ */
    z-index: 99; /* ãƒ˜ãƒƒãƒ€ãƒ¼(100)ã®ã™ãä¸‹ */
}

.tab-btn {
    flex: 1;
    text-align: center;
    padding: 15px;
    font-size: 0.9rem;
    font-weight: bold;
    color: #999;
    cursor: pointer;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}

.tab-btn.active {
    color: var(--ana-blue-main);
    border-bottom: 3px solid var(--ana-blue-main);
    background: rgba(0, 68, 130, 0.05);
}
    /* éå»ã®ãƒã‚±ãƒƒãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .flight-card.history {
    border-top: 4px solid #999; /* å±¥æ­´ã¯é’ã§ã¯ãªãã‚°ãƒ¬ãƒ¼ã®ç·šã« */
}

/* å±¥æ­´ã‚«ãƒ¼ãƒ‰å†…ã®ç‰¹å®šã®è¦ç´ ã ã‘ã‚’ç™½é»’ãƒ»è–„ãã™ã‚‹ */
.flight-card.history .city-code, 
.flight-card.history .time-value,
.flight-card.history .route-row,
.flight-card.history .time-row {
    filter: grayscale(1);
    opacity: 0.6;
}

.boarding-pass {
    background: white;
    color: #333;
    border-radius: 12px;
    padding: 20px;
    margin-top: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    position: relative;
    border: 1px solid #eee;
}

/* 2æ¬¡å…ƒãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ */
.qr-placeholder {
    width: 140px;
    height: 140px;
    background: #f5f5f5;
    margin: 10px auto 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ddd;
    border-radius: 8px;
}

/* æƒ…å ±è¡¨ç¤ºãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.pass-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2åˆ—ã«ã—ã¦å¤§ããè¦‹ã›ã‚‹ */
    gap: 20px;
    text-align: center;
    border-top: 1px dashed #ccc;
    padding-top: 20px;
}

.pass-label {
    font-size: 0.65rem;
    color: #888;
    margin-bottom: 4px;
    font-weight: bold;
}

.pass-value {
    font-size: 1.1rem;
    font-weight: bold;
    color: #000;
}

/* ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·ã®å¼·èª¿ */
.group-badge {
    background: #000;
    color: #fff;
    padding: 2px 8px;
    border-radius: 4px;
    display: inline-block;
}

.seat-highlight {
    font-size: 2.5rem; /* ã‹ãªã‚Šå¤§ãã */
    font-weight: bold;
    color: var(--ana-blue-main);
    line-height: 1;
    margin: 10px 0;
}

/* æ­ä¹—åˆ¸ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆæœ€åˆã¯éš ã™ï¼‰ */
.boarding-pass-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

/* é–‹ã„ãŸæ™‚ã®çŠ¶æ…‹ */
.boarding-pass-container.open {
    max-height: 500px; /* ååˆ†ãªé«˜ã•ã‚’æŒ‡å®š */
}

/* é–‹é–‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.toggle-pass-btn {
    width: 100%;
    background: #f8f9fa;
    border: 1px dashed var(--ana-blue-main);
    color: var(--ana-blue-main);
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
    font-size: 0.8rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px;
}

.toggle-pass-btn::after {
    content: 'â–¼';
    font-size: 0.6rem;
    transition: transform 0.3s;
}

.toggle-pass-btn.active::after {
    transform: rotate(180deg);
}
.focus-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px); /* èƒŒæ™¯ã‚’å°‘ã—ã¼ã‹ã™ */
    z-index: 900;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s;
}

.focus-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

/* æ­ä¹—åˆ¸ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸæ™‚ã®å¼·èª¿ */
.boarding-pass-container.open {
    position: relative;
    z-index: 1000; /* æš—å¹•ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
}

.boarding-pass-container.open .boarding-pass {
    box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
    transform: scale(1.02); /* ã»ã‚“ã®å°‘ã—ã ã‘å¤§ããã—ã¦æµ®éŠæ„Ÿã‚’å‡ºã™ */
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.progress-container {
    width: 100%;
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    margin: 15px 0;
    position: relative;
    overflow: visible;
}

/* å®Ÿéš›ã«ä¼¸ã³ã‚‹ãƒãƒ¼ */
.progress-bar {
    height: 100%;
    background: var(--ana-gradient);
    border-radius: 3px;
    transition: width 1s linear;
}

/* ãƒãƒ¼ã®å…ˆç«¯ã§é£›ã¶é£›è¡Œæ©Ÿã‚¢ã‚¤ã‚³ãƒ³ */
.progress-plane {
    position: absolute;
    top: -8px;
    transform: translateX(-50%);
    font-size: 1.2rem;
    transition: left 1s linear;
}

/* é€²æ—ãƒãƒ¼ã¨ä¸€ç·’ã« <style> ã«è¿½åŠ  */
.pulse {
    color: #e60012; /* ANAã®æ©Ÿæãƒˆãƒ©ãƒ–ãƒ«è¡¨ç¤ºã§ã¯ãªãã€ãƒ©ã‚¤ãƒ–çŠ¶æ…‹ã‚’ç¤ºã™èµ¤ */
    animation: blink 1.5s infinite;
    margin-right: 4px;
}

@keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
}

/* æ™‚é–“å¸¯ã”ã¨ã®èƒŒæ™¯ãƒ‘ã‚¿ãƒ¼ãƒ³ */
.bg-day { background: linear-gradient(135deg, #4da3ff 0%, #0056b3 100%); }      /* æ˜¼ï¼šé’ç©º */
.bg-sunset { background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%); }   /* å¤•æ–¹ï¼šèŒœè‰² */
.bg-night { background: linear-gradient(135deg, #001f3f 0%, #000814 100%); }    /* å¤œï¼šæ˜Ÿç©º */
.bg-dawn { background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%); }     /* æ˜ã‘æ–¹ï¼šè–„æ˜ */

/* ã‚«ãƒ¼ãƒ‰ã®æ–‡å­—ãŒè¦‹ã‚„ã™ã„ã‚ˆã†ã«èª¿æ•´ */
.flight-card.dynamic-bg {
    color: white !important;
    border: none !important;
}
.flight-card.dynamic-bg .city-code, 
.flight-card.dynamic-bg .time-value {
    color: #ffffff !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4); /* å½±ã‚’å°‘ã—å¼·ã‚ã¦è¦–èªæ€§ã‚¢ãƒƒãƒ— */
    font-weight: 800;
}

.flight-card.dynamic-bg .city-name, 
.flight-card.dynamic-bg .time-label,
.flight-card.dynamic-bg .duration-center {
    color: rgba(255, 255, 255, 0.85) !important;
}

.flight-card.dynamic-bg .time-row {
    background: rgba(255, 255, 255, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* é€²æ—ãƒãƒ¼ã®èƒŒæ™¯ã‚‚å°‘ã—ç™½ãã—ã¦è¦‹ã‚„ã™ãã™ã‚‹ */
.flight-card.dynamic-bg .progress-container {
    background: rgba(255, 255, 255, 0.25) !important;
}

.flight-card.dynamic-bg .progress-plane {
    color: #ffffff;
}

/* ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å¾Œã®ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼ˆç¸¦ä¸¦ã³ï¼‰ */
.flight-main-content {
    display: flex;
    flex-direction: column; /* ç¸¦ä¸¦ã³ã«è¨­å®š */
    align-items: center;
    gap: 10px;
    margin: 15px 0;
    padding: 12px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 15px;
}

/* è¡¨é¢ã®çª“ã‚¹ã‚¿ã‚¤ãƒ« */
.card-window-wrapper {
    width: 60px;
    height: 80px;
    background: #000;
    border: 4px solid #e0e0e0;
    border-radius: 25px;
    position: relative;
    overflow: hidden;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
}

/* ã‚·ã‚§ãƒ¼ãƒ‰ï¼ˆåˆæœŸã¯åŠåˆ†é–‰ã˜ï¼‰ */
.card-window-shade {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 55%;
    background: linear-gradient(to bottom, #d1d1d1, #a0a0a0);
    border-bottom: 2px solid #777;
    z-index: 5;
    transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* é£›è¡Œä¸­ã«ã‚·ã‚§ãƒ¼ãƒ‰ã‚’é–‹ã‘ã‚‹ */
.status-inflight .card-window-shade {
    transform: translateY(-100%);
}
/* é›²ã®å‹•ã */
.cloud-particle {
    position: absolute; background: white; border-radius: 50%; filter: blur(4px); opacity: 0.5;
    animation: particles-move 15s linear infinite;
}
@keyframes particles-move { from { transform: translateX(80px); } to { transform: translateX(-60px); } }

/* è¡¨é¢ã®çª“ã‚¹ã‚¿ã‚¤ãƒ« */
.card-window-wrapper {
    width: 60px; height: 80px; background: #000;
    border: 4px solid #e0e0e0; border-radius: 25px;
    position: relative; overflow: hidden; margin-bottom: 10px;
}
.card-window-shade {
    position: absolute; top: 0; left: 0; width: 100%; height: 55%;
    background: linear-gradient(to bottom, #d1d1d1, #a0a0a0);
    border-bottom: 2px solid #777; z-index: 5;
    transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
}
/* INFLIGHTçŠ¶æ…‹ã®æ™‚ã ã‘ã‚·ã‚§ãƒ¼ãƒ‰ã‚’ä¸Šã’ã‚‹ */
.dynamic-bg.bg-inflight .card-window-shade, 
.dynamic-bg[class*="status-inflight"] .card-window-shade {
    transform: translateY(-100%);
}
/* ç©ºã®è‰² */
.sky-morning { background: linear-gradient(to bottom, #4a90e2, #f5a623); }
.sky-day     { background: linear-gradient(to bottom, #1e90ff, #87ceeb); }
.sky-evening { background: linear-gradient(to bottom, #2c3e50, #ff7e5f); }
.sky-night   { background: linear-gradient(to bottom, #00000c, #000050); }

.card-window-shade {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, #d1d1d1, #a0a0a0);
    border-bottom: 3px solid #777;
    z-index: 5;
    /* 1ç§’ã‹ã‘ã¦å‹•ãè¨­å®š */
    transition: transform 1.0s cubic-bezier(0.45, 0.05, 0.55, 0.95);
    transform: translateY(-100%); /* åŸºæœ¬ã¯é–‹ã„ã¦ã„ã‚‹ */
}

/* çª“ã®ä¸­ã®æ™¯è‰²ï¼ˆåœ°ä¸Šã¨ç©ºã®åˆ‡ã‚Šæ›¿ãˆç”¨ï¼‰ */
.window-view-container {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
}

/* åœ°ä¸Šã®æ™¯è‰²ã®ç°¡æ˜“è¡¨ç¾ */
.ground-view {
    background: linear-gradient(to bottom, #87ceeb 0%, #87ceeb 50%, #91b33e 50%, #91b33e 100%);
    width: 100%; height: 100%;
}

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.focus-active body {
    overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
}

.focus-overlay-screen {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: #000;
    z-index: 9999;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
}

.focus-overlay-screen.active {
    display: flex;
    animation: fadeIn 0.8s ease;
}

.focus-exit-btn {
    position: absolute;
    top: 20px; right: 20px;
    background: rgba(255,255,255,0.2);
    border: 1px solid white;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    cursor: pointer;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.runway-loader {
    width: 80%; max-width: 400px; height: 30px;
    border-bottom: 2px dashed rgba(255,255,255,0.3);
    position: relative; margin: 20px auto;
}

.plane-icon-progress {
    position: absolute; bottom: -10px;
    font-size: 1.5rem; transition: left 1s linear;
}

/* ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã®ãƒ†ãƒ­ãƒƒãƒ—é¢¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.announcement-bar {
    background: rgba(0, 68, 130, 0.8);
    color: white; padding: 10px; width: 100%;
    position: absolute; top: 80px;
    font-size: 0.8rem; text-align: center;
    overflow: hidden; white-space: nowrap;
}

/* é›²ã®æµã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes cloudFlow {
    from { left: 120%; }
    to { left: -120%; }
}

.real-cloud {
    position: absolute;
    width: 100px;
    height: 30px;
    background: #fff;
    border-radius: 50%;
    filter: blur(8px);
    opacity: 0.8;
    animation: cloudFlow linear infinite;
    box-shadow: 
        /* è¤‡æ•°ã®å††ã‚’ãšã‚‰ã—ã¦é‡ã­ã‚‹ã“ã¨ã§ãƒ¢ã‚³ãƒ¢ã‚³æ„Ÿã‚’å‡ºã™ */
        40px 10px 0 10px #fff,
        -30px 5px 0 5px #fff,
        15px -15px 0 15px #fff;
}

/* å¤œé–“ç”¨ã®é›²ã®è‰²èª¿æ•´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ */
.focus-active .real-cloud {
    background: #ccddee; /* å°‘ã—é’ã¿ãŒã‹ã£ãŸç™½ */
}

/* å¤–æ ï¼šæ©Ÿä½“ã®å£é¢ */
.window-outer-frame {
    width: 300px;
    height: 400px;
    margin: 0 auto;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 120px;
    padding: 15px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* çª“æ ã®å†…å´ï¼šå¥¥è¡Œã */
.window-inner-frame {
    width: 100%;
    height: 100%;
    background: #000;
    border-radius: 105px;
    border: 10px solid #cbd5e1;
    position: relative;
    overflow: hidden;
    box-shadow: inset 0 10px 30px rgba(0,0,0,0.5);
    cursor: pointer;
}

/* ã‚·ã‚§ãƒ¼ãƒ‰ï¼šè‰²ã‚’ãƒãƒƒã‚­ãƒªã•ã›ã€æ‰‹å‰ã«é…ç½® */
#window-shade {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;

    /* â˜…ã“ã“ãŒä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šæ¨¡æ§˜ã¨ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’1è¡Œã§é‡ã­ã‚‹ */
    background-image: 
        /* 1å±¤ç›®ï¼šè›‡è…¹ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ï¼ˆéš™é–“ãŒé€æ˜ï¼‰ */
        repeating-linear-gradient(
            0deg, 
            rgba(255,255,255,0.9) 0px, 
            rgba(255,255,255,0.9) 1px, 
            transparent 1px, 
            transparent 15px
        ),
        /* 2å±¤ç›®ï¼šãƒ™ãƒ¼ã‚¹ã®è‰²ï¼ˆä¸é€æ˜ãªã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
        linear-gradient(to bottom, #f3f4f6 0%, #d1d5db 100%) !important;

    /* ä¸‡ãŒä¸€ç”»åƒãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã®ä¸é€æ˜è‰² */
    background-color: #f3f4f6 !important;
    
    /* æ™¯è‰²ã®æ‰‹å‰ã«è¡¨ç¤º */
    z-index: 10 !important;
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š */
    transition: transform 1.2s cubic-bezier(0.45, 0.05, 0.55, 0.95);
    transform: translateY(-100%); /* åˆæœŸçŠ¶æ…‹ã¯ä¸Šï¼ˆé–‹ã„ã¦ã„ã‚‹ï¼‰ */
    
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 25px;
    pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚’è¦ªè¦ç´ ã«é€šã™ */
}

/* ã‚·ã‚§ãƒ¼ãƒ‰ãŒé–‰ã˜ãŸçŠ¶æ…‹ */
#window-shade.shade-closed {
    transform: translateY(-5%) !important;
}

/* ã¤ã¾ã¿ */
.shade-handle {
    width: 70px;
    height: 8px;
    background: #6b7280;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
    </style>
</head>
<body>
    <div id="scanModal" class="modal" style="display:none; position:fixed; z-index:5000; left:0; top:0; width:100%; height:100%; background:#000; flex-direction:column; align-items:center; justify-content:center;">
    <div style="color:white; margin-bottom:20px; font-weight:bold;">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
    <div style="position:relative; width:80%; max-width:300px; aspect-ratio:1/1; border:2px solid var(--ana-blue-sky); border-radius:15px; overflow:hidden;">
        <video id="video" style="width:100%; height:100%; object-fit:cover;"></video>
        <div style="position:absolute; top:10%; left:10%; right:10%; bottom:10%; border:1px dashed rgba(255,255,255,0.5);"></div>
    </div>
    <button onclick="stopScan()" style="margin-top:30px; padding:12px 40px; border-radius:25px; border:none; background:white; color:black; font-weight:bold;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <canvas id="canvas" style="display:none;"></canvas>
</div>
    <audio id="cabinNoise" loop src="https://www.soundjay.com/transportation/airplane-cabin-white-noise-01.mp3"></audio>

<div id="focusModeScreen" class="focus-overlay-screen">
    <div id="announcementBar" class="announcement-bar" style="display:none;">
        <span id="announcementText"></span>
    </div>
    <button class="focus-exit-btn" onclick="toggleFocusMode()">EXIT FOCUS</button>
    <div id="focusContent" style="text-align: center; width: 100%;"></div>
</div>
<div id="focusOverlay" class="focus-overlay" onclick="closeAllPasses()"></div>
<div id="qrModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()" style="text-align: center;">
        <h3 style="color: var(--ana-blue-main);">SHARE FLIGHT</h3>
        <p style="font-size: 0.8rem; color: #666;">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦å…±æœ‰</p>
        <div id="qrcode" style="display: flex; justify-content: center; margin: 20px 0;"></div>
        <button onclick="document.getElementById('qrModal').style.display='none'" style="width: 100%; padding: 10px; background: #eee; border: none; border-radius: 8px;">é–‰ã˜ã‚‹</button>
    </div>
</div>
<header>
    <div class="header-left">
        <div class="header-title">Flight Schedule <span id="statusLabel" class="status-badge-header"></span></div>
        <div class="mile-display">âœˆ <span id="totalMiles">0</span> MILES</div>
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
        <span id="notifBtn" onclick="requestNotification()" style="cursor:pointer; font-size:1.2rem; filter:grayscale(1);">ğŸ””</span>
        <div class="header-icon" onclick="openAirportModal()">âš™ï¸</div>
    </div>
    <div id="notifBanner" class="in-app-banner" onclick="hideBanner()">
    <span>âœˆ</span> <span id="notifText">æ­ä¹—æ‰‹ç¶šããŒå¯èƒ½ãªä¾¿ãŒã‚ã‚Šã¾ã™</span>
</div>
</header>

<div class="tab-container">
    <div id="tab-upcoming" class="tab-btn active" onclick="switchTab('upcoming')">Upcoming</div>
    <div id="tab-history" class="tab-btn" onclick="switchTab('history')">History</div>
</div>

<div class="container" id="flightList"></div>

<button class="fab" onclick="openNewFlightModal()">+</button>
<button onclick="startScan()" style="background:var(--ana-blue-main); color:white; border:none; padding:10px 15px; border-radius:20px; font-weight:bold;">
    ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³
</button>

<div id="newFlightModal" class="modal">
    <div class="modal-content">
        <div class="modal-header-ana">
            <strong>ãƒ•ãƒ©ã‚¤ãƒˆäºˆç´„</strong>
            <span onclick="closeModal('newFlightModal')" style="cursor:pointer; font-size:1.5rem">Ã—</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ­ä¹—ã‚¯ãƒ©ã‚¹ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥)</label>
                <select id="classSelect">
                    <option value="ECONOMY">æ™®é€šå¸­ (Economy)</option>
                    <option value="BUSINESS" id="optPremium" disabled>ãƒ“ã‚¸ãƒã‚¹ã‚¯ãƒ©ã‚¹ (Sapphireä»¥ä¸Š)</option>
                    <option value="FIRST" id="optFirst" disabled>ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ (Diamondé™å®š)</option>
                </select>
            </div>
            <div class="form-group">
                <label>åŒºé–“é¸æŠ</label>
                <div style="display:flex; gap:10px; align-items: center;">
                    <div style="flex:1"><label style="font-size:0.6rem">FROM</label><select id="fromSelect"></select></div>
                    <div style="color:var(--ana-blue-sky)">âœˆ</div>
                    <div style="flex:1"><label style="font-size:0.6rem">TO</label><select id="toSelect"></select></div>
                </div>
            </div>
            <div class="form-group">
                <label>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</label>
                <div style="display:flex; gap:10px;">
                    <div class="input-group">
                        <label>æ­ä¹—æ—¥</label>
                        <input type="date" id="flightDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div style="flex:1"><label style="font-size:0.6rem">å‡ºç™ºæ™‚åˆ»</label><input type="time" id="timeInput"></div>
                    <div style="flex:1"><label style="font-size:0.6rem">æ‰€è¦æ™‚é–“ (åˆ†)</label><input type="number" id="durationInput" value="60"></div>
                </div>
            </div>
            <div class="form-group" onclick="openSeatMap()" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                <div><label>åº§å¸­æŒ‡å®š</label><span id="seatLabel" style="font-weight:bold; color:var(--ana-blue-main);">æœªæŒ‡å®š</span></div>
                <div style="color:var(--ana-blue-sky)">é¸æŠ &gt;</div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-save" onclick="saveFlight()">äºˆç´„ç¢ºå®š</button></div>
    </div>
</div>

<div id="airportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header-ana"><strong>ãƒã‚¤ç©ºæ¸¯(ã‚„ã‚‹ã“ã¨)è¨­å®š</strong><span onclick="closeModal('airportModal')" style="cursor:pointer; font-size:1.5rem">Ã—</span></div>
        <div class="modal-body">
            <div class="form-group">
                <div style="display:flex; gap:10px;"><input type="text" id="newAirportCode" placeholder="3ãƒ¬ã‚¿ãƒ¼" maxlength="3" style="flex:1; text-transform:uppercase;"><input type="text" id="newAirportName" placeholder="åç§°" style="flex:2;"></div>
                <button class="btn btn-add" onclick="addAirport()">è¿½åŠ ç™»éŒ²</button>
            </div>
            <ul class="airport-list" id="airportListUi"></ul>
        </div>
    </div>
</div>

<div id="seatModal" class="modal">
    <div class="modal-content" style="height:90vh;">
        <div class="modal-header-ana"><strong>åº§å¸­æŒ‡å®š</strong><span onclick="confirmSeat()" style="cursor:pointer">æ±ºå®š</span></div>
        <div class="modal-body" style="background: #dce1e6;">
            <div class="plane-wrapper" id="planeWrapper"><div class="wing-left"></div><div class="wing-right"></div><div class="fuselage"><div class="cockpit"></div></div><div class="seat-map-container" id="seatGrid"></div></div>
        </div>
    </div>
</div>

<script>
    const defaultAirports = [{code: 'HME', name: 'è‡ªå®…'}, {code: 'WRK', name: 'ä»•äº‹'}, {code: 'CFE', name: 'ã‚«ãƒ•ã‚§'}];
    let airports = JSON.parse(localStorage.getItem('my_airports') || JSON.stringify(defaultAirports));
    let flights = JSON.parse(localStorage.getItem('ana_flights_final') || '[]');
    let tempSeat = null;
    let notifiedFlights = new Set();
    let bannerShownFor = new Set();
    
    // ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨å¤‰æ•°
    let startX = 0;
    let currentX = 0;
    let isDragging = false;
    let currentTab = 'upcoming'; // ã‚¿ãƒ–çŠ¶æ…‹ã®ç®¡ç†

    // --- Status & Mile Logic ---
    function getStatusInfo() {
        const total = flights.reduce((acc, f) => getStatus(f) === 'ARRIVED' ? acc + (f.duration || 0) : acc, 0);
        let status = 'BRONZE';
        if (total >= 3000) status = 'DIAMOND';
        else if (total >= 1000) status = 'SAPPHIRE';
        return { total, status };
    }

    function updateHeader() {
        const info = getStatusInfo();
        document.getElementById('totalMiles').innerText = info.total.toLocaleString();
        const label = document.getElementById('statusLabel');
        label.innerText = info.status;
        label.className = 'status-badge-header st-' + info.status;
        document.getElementById('optPremium').disabled = info.total < 1000;
        document.getElementById('optFirst').disabled = info.total < 3000;
    }

    function getStatus(f) {
    const now = new Date();
    // f.date (2026-02-03) ã¨ f.time (19:30) ã‚’çµ„ã¿åˆã‚ã›ã¦ Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    const [y, m, d] = (f.date || new Date().toISOString().split('T')[0]).split('-').map(Number);
    const [hh, mm] = f.time.split(':').map(Number);
    
    const dep = new Date(y, m - 1, d, hh, mm);
    const arr = new Date(dep.getTime() + (f.duration || 60) * 60000); 
    
    if (now > arr) return 'ARRIVED'; 
    if (now > dep && !f.checkedIn) return 'NOSHOW'; 
    if (now > dep && f.checkedIn) return 'INFLIGHT';
    return f.checkedIn ? 'CHECKEDIN' : 'RESERVED';
}

    function isCheckInOpen(f) {
    const now = new Date();
    const [y, m, d] = (f.date || new Date().toISOString().split('T')[0]).split('-').map(Number);
    const [hh, mm] = f.time.split(':').map(Number);
    
    const dep = new Date(y, m - 1, d, hh, mm);
    const openTime = new Date(dep.getTime() - 10 * 60000); // 10åˆ†å‰
    return now >= openTime && now <= dep;
}

    // --- Tab Switching ---
    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('tab-upcoming').classList.toggle('active', tab === 'upcoming');
        document.getElementById('tab-history').classList.toggle('active', tab === 'history');
        render(); // å†æç”»
    }

    // --- Swipe UI Logic ---
    function getCheckInUI(f, canCheckIn) {
        if (!canCheckIn) {
            return `<div class="swipe-container" style="opacity:0.5; background:#ccc; color:#666">å‡ºç™º10åˆ†å‰ã‹ã‚‰å—ä»˜é–‹å§‹</div>`;
        }
        return `
            <div class="swipe-container" id="swipeContainer-${f.id}">
                <div class="swipe-handle" 
                     onmousedown="handleSwipeStart(event, ${f.id})"
                     ontouchstart="handleSwipeStart(event, ${f.id})">âœˆ</div>
                ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
            </div>
        `;
    }

    function handleSwipeStart(e, id) {
        startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        isDragging = true;
        const handle = e.target;
        handle.style.transition = 'none';

        const moveHandler = (ev) => handleSwipeMove(ev, id);
        const endHandler = () => {
            handleSwipeEnd(id);
            window.removeEventListener('mousemove', moveHandler);
            window.removeEventListener('touchmove', moveHandler);
            window.removeEventListener('mouseup', endHandler);
            window.removeEventListener('touchend', endHandler);
        };

        window.addEventListener('mousemove', moveHandler);
        window.addEventListener('touchmove', moveHandler, { passive: false });
        window.addEventListener('mouseup', endHandler);
        window.addEventListener('touchend', endHandler);
    }

    function handleSwipeMove(e, id) {
        if (!isDragging) return;
        if (e.cancelable) e.preventDefault();
        const container = document.getElementById(`swipeContainer-${id}`);
        const handle = container.querySelector('.swipe-handle');
        const maxMove = container.offsetWidth - handle.offsetWidth;
        const x = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        currentX = x - startX;
        if (currentX < 0) currentX = 0;
        if (currentX > maxMove) currentX = maxMove;
        handle.style.transform = `translateX(${currentX}px)`;
        container.style.background = `rgba(0, 68, 130, ${0.1 + (currentX/maxMove) * 0.2})`;
    }

    function handleSwipeEnd(id) {
        if (!isDragging) return;
        isDragging = false;
        const container = document.getElementById(`swipeContainer-${id}`);
        const handle = container.querySelector('.swipe-handle');
        const maxMove = container.offsetWidth - handle.offsetWidth;
        if (currentX >= maxMove * 0.9) {
            handle.style.transition = 'transform 0.2s';
            handle.style.transform = `translateX(${maxMove}px)`;
            setTimeout(() => {
                if (window.navigator.vibrate) window.navigator.vibrate(30);
                doCheckIn(id);
            }, 200);
        } else {
            handle.style.transition = 'transform 0.3s ease';
            handle.style.transform = 'translateX(0)';
            container.style.background = '#eee';
        }
        currentX = 0;
    }

    // --- Render ---
    function render() {
    updateHeader();
    const list = document.getElementById('flightList');
    
    const displayFlights = flights.filter(f => {
        const status = getStatus(f);
        const isHistory = (status === 'ARRIVED' || status === 'NOSHOW');
        return currentTab === 'upcoming' ? !isHistory : isHistory;
    });

    let summaryHtml = '';
    if (currentTab === 'history' && displayFlights.length > 0) {
        const totalFlights = displayFlights.length;
        const arrivedCount = displayFlights.filter(f => getStatus(f) === 'ARRIVED').length;
        const totalMinutes = displayFlights
            .filter(f => getStatus(f) === 'ARRIVED')
            .reduce((sum, f) => sum + Number(f.duration), 0);

        const days = Math.floor(totalMinutes / 1440);
        const hours = Math.floor((totalMinutes % 1440) / 60);
        const mins = totalMinutes % 60;

        let timeStr = "";
        if (days > 0) timeStr += `${days}d `;
        timeStr += `${hours}h ${mins}m`;
        
        let rankTitle = "BEGINNER";
        let rankColor = "#fff"; 
        if (totalMinutes >= 6000) { rankTitle = "SKY LEGEND"; rankColor = "var(--gold)"; }
        else if (totalMinutes >= 1440) { rankTitle = "CLOUD DWELLER"; rankColor = "#e5e4e2"; }
        else if (totalMinutes >= 600) { rankTitle = "SKY RUNNER"; rankColor = "#87ceeb"; }

        summaryHtml = `
            <div style="background: var(--ana-gradient); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,68,130,0.2); position: relative; overflow: hidden;">
                <div style="position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.1; transform: rotate(-20deg);">âœˆ</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <div style="font-size: 0.75rem; opacity: 0.8; letter-spacing: 1.5px;">TOTAL AIR TIME</div>
                    <div style="font-size: 0.7rem; font-weight: bold; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; color: ${rankColor}; border: 1px solid ${rankColor}55;">${rankTitle}</div>
                </div>
                <div style="font-size: 2.2rem; font-weight: bold; font-family: sans-serif; margin-bottom: 15px;">${timeStr}</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
                    <div><div style="font-size: 0.7rem; opacity: 0.8;">æ­ä¹—å›æ•°</div><div style="font-size: 1.1rem; font-weight: bold;">${totalFlights} <span style="font-size: 0.7rem;">å›</span></div></div>
                    <div style="text-align: center;"><div style="font-size: 0.7rem; opacity: 0.8;">å®šæ™‚æ­ä¹—ç‡</div><div style="font-size: 1.1rem; font-weight: bold;">${Math.round((arrivedCount/totalFlights)*100)}%</div></div>
                    <div style="text-align: right;"><div style="font-size: 0.7rem; opacity: 0.8;">ç´¯è¨ˆãƒã‚¤ãƒ«</div><div style="font-size: 1.1rem; font-weight: bold; color: var(--gold);">${totalMinutes.toLocaleString()}</div></div>
                </div>
            </div>`;
    }

    if(displayFlights.length === 0) {
        list.innerHTML = summaryHtml + `<div style="text-align:center; color:#999; margin-top:50px">${currentTab === 'upcoming' ? 'ã“ã‚Œã‹ã‚‰ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“' : 'æ­ä¹—å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“'}</div>`;
        return;
    }

    // 3. ä¸¦ã³æ›¿ãˆ
    displayFlights.sort((a, b) => {
        // æ—¥ä»˜ã¨æ™‚åˆ»ã‚’çµåˆã—ã¦æ­£ç¢ºãªæ¯”è¼ƒç”¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹
        const dateTimeA = new Date(`${a.date}T${a.time}`).getTime();
        const dateTimeB = new Date(`${b.date}T${b.time}`).getTime();
        
        if (currentTab === 'upcoming') {
            // ã€Upcomingã€‘å‡ºç™ºãŒè¿‘ã„ã‚‚ã®ï¼ˆæ™‚åˆ»ãŒæ—©ã„é †ï¼‰ã‚’ä¸Šã«
            return dateTimeA - dateTimeB;
        } else {
            // ã€Historyã€‘æœ€è¿‘ä¹—ã£ãŸã‚‚ã®ï¼ˆæ™‚åˆ»ãŒé…ã„é †ï¼‰ã‚’ä¸Šã«
            return dateTimeB - dateTimeA;
        }
    });

    

    // 4. æç”»
    // 4. æç”»
    list.innerHTML = summaryHtml + displayFlights.map(f => {
        const status = getStatus(f);
        const canCheckIn = isCheckInOpen(f);
        const isHistory = (status === 'ARRIVED' || status === 'NOSHOW');
        
        const dateObj = new Date(f.date || new Date());
        const dateStr = dateObj.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', weekday: 'short' });
        const [h, m] = f.time.split(':').map(Number);
        const depDate = new Date(dateObj); depDate.setHours(h, m, 0, 0);
        const arrDate = new Date(depDate.getTime() + f.duration * 60000);
        const arrTimeStr = arrDate.getHours().toString().padStart(2,'0') + ':' + arrDate.getMinutes().toString().padStart(2,'0');
        const bgClass = getBgClass(f.time);
        const skyClass = bgClass.replace('bg-', 'sky-');

        let inflightExtra = "";
        if (status === 'INFLIGHT') {
            inflightExtra = `
                <div class="airplane-window">
                    <div class="sky-view ${skyClass}">
                        <div class="cloud-particle" style="width:50px; height:20px; top:20%;"></div>
                        <div class="cloud-particle" style="width:70px; height:25px; top:50%; animation-delay:-5s;"></div>
                        <div class="cloud-particle" style="width:40px; height:15px; top:75%; animation-delay:-10s;"></div>
                    </div>
                </div>
                <div style="text-align:center; font-size:0.6rem; color:rgba(255,255,255,0.7); margin-bottom:10px;">
                    Cruising at 35,000ft
                </div>`;
        }

        const priorityGroup = (f.boardingClass === 'FIRST') ? 1 : (f.boardingClass === 'BUSINESS') ? 2 : 3;
        const gateLabel = f.from.charAt(0).toUpperCase() + (String(f.id).slice(-1));
        const getWorkStyle = (seat) => {
            if (!seat || seat === 'ANY') return 'Style: Undefined';
            const letter = seat.slice(-1);
            if (['A', 'K'].includes(letter)) return 'Deepï¼ˆé›†ä¸­ï¼‰';
            if (['C', 'H'].includes(letter)) return 'Lightï¼ˆæ°—è»½ï¼‰';
            return 'Normalï¼ˆæ¨™æº–ï¼‰';
        };

        // --- é€²æ—ãƒãƒ¼ã®è¨ˆç®— ---
        let progressHtml = '';
        if (f.checkedIn && !isHistory) {
            const now = new Date().getTime();
            const totalDuration = f.duration * 60000;
            const elapsed = now - depDate.getTime();
            const percent = Math.min(Math.max((elapsed / totalDuration) * 100, 0), 100);

            // æ™¯è‰²ã®å®šç¾©
            let windowContent = '';
            if (status === 'INFLIGHT') {
                // ã€é£›è¡Œä¸­ã€‘ä¸Šç©ºã®æ™¯è‰²
                windowContent = `
                    <div class="sky-view ${skyClass}" style="width:100%; height:100%;">
                        <div class="cloud-particle" style="top:25%; width:30px; height:10px; left:10%;"></div>
                        <div class="cloud-particle" style="top:55%; width:40px; height:15px; left:40%; animation-delay:-5s;"></div>
                    </div>`;
            } else {
                // ã€å‡ºç™ºå‰ã€‘æ·±ã¿ã®ã‚ã‚‹åœ°ä¸Šã®æ™¯è‰²
                windowContent = `
                    <div style="width: 100%; height: 100%; background: linear-gradient(to bottom, 
                        #4a90e2 0%,      /* ç©ºã®é«˜ã„ã¨ã“ã‚ */
                        #87ceeb 45%,     /* åœ°å¹³ç·šä»˜è¿‘ã®æ˜ã‚‹ã„ç©º */
                        #cfe2f3 54%,     /* åœ°å¹³ç·šã®éœã¿ */
                        #7da438 56%,     /* é ãã®ç·‘ï¼ˆå°‘ã—è–„ã„ï¼‰ */
                        #5a8226 100%     /* æ‰‹å‰ã®ç·‘ï¼ˆæ¿ƒã„ï¼‰ */
                    );">
                        <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%); pointer-events:none;"></div>
                    </div>`;
            }

            // æ¼”å‡ºï¼šå‡ºç™ºã®ç¬é–“ï¼ˆ0%ã€œ2.5%ï¼‰ã¯ã‚·ã‚§ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹(0%)ã€ãã‚Œä»¥å¤–ã¯é–‹ã‘ã‚‹(-100%)
            const shadeTransform = (status === 'INFLIGHT' && percent < 2.5) 
                                   ? 'translateY(0%)' 
                                   : 'translateY(-100%)';

            progressHtml = `
                <div class="flight-main-content" style="display: flex; flex-direction: column; align-items: center; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                    <div class="card-window-wrapper" style="width: 100px; height: 130px; background: #000; border: 6px solid #e0e0e0; border-radius: 40px; position: relative; overflow: hidden; box-shadow: inset 0 0 15px rgba(0,0,0,0.5); margin-bottom: 10px;">
                        <div class="card-window-shade" style="
                            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                            background: linear-gradient(to bottom, #e0e0e0 0%, #b0b0b0 100%);
                            border-bottom: 4px solid #888; z-index: 5;
                            transition: transform 1.2s cubic-bezier(0.45, 0.05, 0.55, 0.95);
                            transform: ${shadeTransform};
                        ">
                            <div style="width:100%; height:100%; opacity:0.1; background: repeating-linear-gradient(0deg, transparent, transparent 4px, #000 5px);"></div>
                        </div>
                        <div class="window-view-container" style="width:100%; height:100%;">
                            ${windowContent}
                        </div>
                    </div>
                    
                    <div style="width: 100%; margin-top: 5px;">
                        <div class="progress-container" style="width:100%; height:4px; background: rgba(255,255,255,0.2); border-radius:2px; position:relative;">
                            <div class="progress-bar" style="width: ${percent}%; height:100%; background: white;"></div>
                            <div class="progress-plane" style="position:absolute; left: ${percent}%; top:-8px; transform:translateX(-50%); color: white; font-size:12px;">âœˆ</div>
                        </div>
                    </div>
                </div>`;
        }

        return `
    <div class="flight-card ${isHistory ? 'history' : ''} dynamic-bg ${bgClass}" data-id="${f.id}">
        ${status === 'NOSHOW' ? '<div class="noshow-overlay"><div class="noshow-stamp">NO SHOW</div></div>' : ''}
        ${status === 'ARRIVED' ? '<div class="noshow-overlay"><div class="noshow-stamp" style="border-color:var(--gold); color:var(--gold);">ARRIVED</div></div>' : ''}
        
        <div class="card-inner">
            <button onclick="toggleFocusMode()" style="margin-top: 10px; width: 100%; background: rgba(0,0,0,0.8); color: white; border: 1px solid white; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                ğŸ”­ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ï¼ˆå…¨ç”»é¢ï¼‰ã‚’èµ·å‹•
            </button>
            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px;">
                <span style="font-size: 0.9rem;">ğŸ“…</span> ${dateStr}
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span class="status-badge badge-${status.toLowerCase()}">${status}</span>
                <span style="font-size:0.8rem; color:rgba(255,255,255,0.5)">#${String(f.id).slice(-4)}</span>
            </div>
            <div class="route-row">
                <div class="city-box"><div class="city-code" style="color:white !important;">${f.from}</div><div class="city-name" style="color:rgba(255,255,255,0.8) !important;">${f.fromName}</div></div>
                <div style="color:rgba(255,255,255,0.8)">âœˆ</div>
                <div class="city-box"><div class="city-code" style="color:white !important;">${f.to}</div><div class="city-name" style="color:rgba(255,255,255,0.8) !important;">${f.toName}</div></div>
            </div>
            <div class="time-row" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);">
                <div class="time-box"><div class="time-label" style="color:rgba(255,255,255,0.7) !important;">DEP</div><div class="time-value" style="color:white !important; font-size:1.4rem;">${f.time}</div></div>
                <div class="duration-center" style="color:rgba(255,255,255,0.6)">â¯ ${f.duration}m â¯</div>
                <div class="time-box"><div class="time-label" style="color:rgba(255,255,255,0.7) !important;">ARR</div><div class="time-value" style="color:white !important; font-size:1.4rem;">${arrTimeStr}</div></div>
            </div>

            ${progressHtml}

            ${isHistory ? `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.3);">
                    <div style="font-size:0.75rem; font-weight:bold; color:${status === 'ARRIVED' ? 'var(--gold)' : 'rgba(255,255,255,0.5)'}">
                        ${status === 'ARRIVED' ? `1. LOGGED: +${f.duration} MILES` : '0 MILES (NO SHOW)'}
                    </div>
                    <button onclick='repeatFlight(${JSON.stringify(f)})' style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; cursor: pointer;">å†äºˆç´„ âœˆ</button>
                </div>` : ''}

            ${(status === 'RESERVED' && currentTab === 'upcoming') ? getCheckInUI(f, canCheckIn) : ''}
            ${(status === 'CHECKEDIN' && currentTab === 'upcoming') ? `<div style="text-align:center; color:white; font-size:0.8rem; margin-top:10px; font-weight:bold;">âœ“ ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿</div>` : ''}
        </div>

        ${(f.checkedIn && !isHistory) ? `
            <button class="toggle-pass-btn" onclick="toggleBoardingPass(this)" style="background: rgba(255,255,255,0.15); border: 1px dashed rgba(255,255,255,0.5); color: white;">æ­ä¹—åˆ¸ã‚’è¡¨ç¤º</button>
            <div class="boarding-pass-container">
                <div class="boarding-pass" style="padding:0; overflow:hidden; border-radius:15px; position:relative;">
                    <div style="background: var(--ana-blue-main); color: white; padding: 10px; text-align: center; font-size: 0.7rem; font-weight: bold; letter-spacing: 2px;">
                        THE AIRLINE BOARDING PASS
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">TASK LOCATION</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--ana-blue-main);">${f.from} â†’ ${f.to}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">TASK CLASS</div>
                                <div style="font-size: 0.9rem; font-weight: bold;">${f.boardingClass || 'ECONOMY'}</div>
                            </div>
                        </div>

                        <div class="boarding-pass-inner" style="position: relative; background: white; padding: 20px 15px; border-radius: 12px; border: 1px dashed #ccc; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div id="qrcode-${f.id}" style="background: white; padding: 5px; display: flex; justify-content: center;"></div>
                            <div style="font-size: 0.6rem; color: #999; margin-top: 8px; letter-spacing: 1px;">SCAN TO SHARE</div>
                            
                            <div style="position: absolute; width: 20px; height: 20px; background: #eee; border-radius: 50%; top: 50%; left: -11px; transform: translateY(-50%); border: 1px dashed #ccc;"></div>
                            <div style="position: absolute; width: 20px; height: 20px; background: #eee; border-radius: 50%; top: 50%; right: -11px; transform: translateY(-50%); border: 1px dashed #ccc;"></div>
                        </div>
                        
                        <div style="text-align: center; padding: 20px 0 10px 0;">
                            <div style="font-size: 0.65rem; color: #888; font-weight: bold;">ASSIGNED WORK STYLE</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--ana-blue-main); line-height: 1.2;">
                                ${getWorkStyle(f.seat)}<br>
                                <span style="font-size: 0.8rem; color: #888; font-weight: normal;">SEAT: ${f.seat}</span>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; border-top: 1px dashed #ccc; padding-top: 15px;">
                            <div>
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">PRIORITY</div>
                                <div style="font-size: 1.2rem; font-weight: bold;"><span style="background: #000; color: #fff; padding: 2px 8px; border-radius: 4px;">${priorityGroup}</span></div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">GATE (SPOT)</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">${gateLabel}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>` : ''}
    </div>`;
    }).join('');

    displayFlights.forEach(f => {
        const qrContainer = document.getElementById(`qrcode-${f.id}`);
        if (qrContainer) {
            // ãƒ‡ãƒ¼ã‚¿ã‚’URLåŒ–ï¼ˆbtoaã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
            // renderé–¢æ•°ã®æœ€å¾Œã®ãƒ«ãƒ¼ãƒ—å†…
            const data = `${f.from},${f.to},${f.date},${f.time},${f.duration},${f.boardingClass},${f.seat}`;
            const shareUrl = `${window.location.origin}${window.location.pathname}?add=${btoa(data)}`;

            qrContainer.innerHTML = ""; // é‡è¤‡é˜²æ­¢
            new QRCode(qrContainer, {
                text: shareUrl,
                width: 80,  // æ­ä¹—åˆ¸ã«åã¾ã‚‹ã‚µã‚¤ã‚º
                height: 80,
                colorDark : "#000000", // ANAãƒ–ãƒ«ãƒ¼
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });
        }
    });

}

    // --- Other Functions ---
    function doCheckIn(id) {
        flights = flights.map(f => f.id === id ? {...f, checkedIn: true} : f);
        localStorage.setItem('ana_flights_final', JSON.stringify(flights));
        render();
    }

    function saveFlight() {
        // HTMLã®IDã¨ä¸€è‡´ã•ã›ã‚‹ (dateInput â†’ flightDate)
        const fromCode = document.getElementById('fromSelect').value;
        const toCode = document.getElementById('toSelect').value;
        const dateVal = document.getElementById('flightDate').value; 
        const timeVal = document.getElementById('timeInput').value;
        const durationVal = parseInt(document.getElementById('durationInput').value) || 60;
        const classVal = document.getElementById('classSelect').value;

        const fromAp = airports.find(a => a.code === fromCode);
        const toAp = airports.find(a => a.code === toCode);
        
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!dateVal || !timeVal) {
            alert('æ—¥ä»˜ã¨æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        const f = {
            id: Date.now(),
            date: dateVal,
            from: fromCode, 
            fromName: fromAp ? fromAp.name : '',
            to: toCode, 
            toName: toAp ? toAp.name : '',
            time: timeVal,
            duration: durationVal,
            seat: tempSeat || 'ANY',
            boardingClass: classVal,
            checkedIn: false
        };
        
        flights.push(f);
        localStorage.setItem('ana_flights_final', JSON.stringify(flights));
        closeModal('newFlightModal');
        render();
    }

    function initSeatMap() {
        const grid = document.getElementById('seatGrid'); 
        grid.innerHTML = '';

    const selectedClass = document.getElementById('classSelect').value;

        for (let r = 1; r <= 20; r++) {
            let rowClass = (r <= 2) ? 'FIRST' : (r <= 7) ? 'BUSINESS' : 'ECONOMY';
            const isLocked = (rowClass !== selectedClass);
            const row = document.createElement('div'); 
            row.className = 'seat-row';
            if (isLocked) row.style.opacity = "0.3";
            ['A','B','C'].forEach(c => createSeat(row, r, c, isLocked, rowClass));
            const aisle = document.createElement('div'); aisle.className='aisle-gap'; aisle.innerText = r; row.appendChild(aisle);
            ['H','J','K'].forEach(c => createSeat(row, r, c, isLocked, rowClass));
            grid.appendChild(row);
        }
    }

    function createSeat(container, r, c, isLocked, rowClass) {
    const s = document.createElement('div'); 
    s.className = 'seat'; 
    
    // ã‚¹ã‚¿ã‚¤ãƒ«åˆ¤å®š
    let styleLabel = "";
    if (['A', 'K'].includes(c)) styleLabel = "Deep";
    else if (['C', 'H'].includes(c)) styleLabel = "Light";
    else styleLabel = "Normal"; // ã¾ãŸã¯ Routine

    s.innerHTML = `
        <div style="font-size:0.9rem; font-weight:bold;">${c}</div>
        <div style="font-size:0.5rem; opacity:0.7;">${styleLabel}</div>
    `;

    if (rowClass === 'FIRST') s.style.borderColor = "var(--diamond)";
    if (rowClass === 'BUSINESS') s.style.borderColor = "var(--ana-blue-sky)";

    if (isLocked) {
        s.style.cursor = 'not-allowed';
        s.style.background = '#ddd';
        s.style.opacity = '0.5';
    } else {
        s.onclick = () => { 
            document.querySelectorAll('.seat').forEach(x => x.classList.remove('selected')); 
            s.classList.add('selected'); 
            tempSeat = r + c; 
        };
    }
    container.appendChild(s);
}

    function requestNotification() {
        if (!("Notification" in window)) return alert("éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™");
        Notification.requestPermission().then(p => {
            if (p === "granted") {
                document.getElementById('notifBtn').style.filter = "none";
                new Notification("é€šçŸ¥è¨­å®šå®Œäº†", { body: "æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚" });
            }
        });
    }

    function sendNotification(f) {
        if (Notification.permission === "granted" && !notifiedFlights.has(f.id)) {
            new Notification("æ­ä¹—æ‰‹ç¶šãã®ã”æ¡ˆå†…", { body: `${f.from} âœˆ ${f.to} ä¾¿ã®å—ä»˜ãŒå§‹ã¾ã‚Šã¾ã—ãŸã€‚` });
            notifiedFlights.add(f.id);
        }
    }

    function showInAppBanner(f) {
        if (bannerShownFor.has(f.id)) return;
        const banner = document.getElementById('notifBanner');
        document.getElementById('notifText').innerText = `æ­ä¹—æ‰‹ç¶šãã®ã”æ¡ˆå†…: ${f.from} âœˆ ${f.to}`;
        banner.classList.add('show');
        setTimeout(hideBanner, 8000);
        bannerShownFor.add(f.id);
    }

    function hideBanner() { document.getElementById('notifBanner').classList.remove('show'); }

    function mainLoop() {
        render(); // 10ç§’ãŠãã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘
        flights.forEach(f => {
            if (getStatus(f) === 'RESERVED' && isCheckInOpen(f)) {
                sendNotification(f);
                showInAppBanner(f);
            }
        });
    }

    function openNewFlightModal() { tempSeat = null; document.getElementById('seatLabel').innerText = 'æœªæŒ‡å®š'; updateHeader(); updateSelectOptions(); document.getElementById('newFlightModal').style.display = 'block'; }
    function openAirportModal() { renderAirportList(); document.getElementById('airportModal').style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openSeatMap() { initSeatMap(); document.getElementById('seatModal').style.display = 'block'; }
    function confirmSeat() { if(tempSeat) document.getElementById('seatLabel').innerText = tempSeat; closeModal('seatModal'); }
    function updateSelectOptions() {
        const html = airports.map(a => `<option value="${a.code}">${a.code} - ${a.name}</option>`).join('');
        document.getElementById('fromSelect').innerHTML = html;
        document.getElementById('toSelect').innerHTML = html;
        if(airports.length > 1) document.getElementById('toSelect').selectedIndex = 1;
    }
    function renderAirportList() {
        document.getElementById('airportListUi').innerHTML = airports.map((a, i) => `<li class="airport-item"><span class="airport-code-tag">${a.code}</span><strong>${a.name}</strong><button class="delete-btn" onclick="deleteAirport(${i})">Ã—</button></li>`).join('');
    }
    function addAirport() {
        const c = document.getElementById('newAirportCode').value.toUpperCase();
        const n = document.getElementById('newAirportName').value;
        if(c && n) { airports.push({code:c, name:n}); localStorage.setItem('my_airports', JSON.stringify(airports)); renderAirportList(); }
    }
    function deleteAirport(i) { airports.splice(i, 1); localStorage.setItem('my_airports', JSON.stringify(airports)); renderAirportList(); }

    if (Notification.permission === "granted") document.getElementById('notifBtn').style.filter = "none";
    render();
    setInterval(mainLoop, 10000);

    function repeatFlight(f) {
    switchTab('upcoming');
    openNewFlightModal();
    
    setTimeout(() => {
        document.getElementById('fromSelect').value = f.from;
        document.getElementById('toSelect').value = f.to;
        document.getElementById('durationInput').value = f.duration;
        document.getElementById('classSelect').value = f.boardingClass || 'ECONOMY';
        
        // IDã‚’ä¿®æ­£: dateInput â†’ flightDate
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('flightDate').value = today; 
        
        tempSeat = null;
        document.getElementById('seatLabel').innerText = `æœªæŒ‡å®š (å‰å›: ${f.seat})`;
        
        const now = new Date();
        now.setMinutes(now.getMinutes() + 10);
        const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
        document.getElementById('timeInput').value = timeStr;
    }, 100);
}

function toggleBoardingPass(btn) {
    const container = btn.nextElementSibling;
    const overlay = document.getElementById('focusOverlay');
    const isOpen = container.classList.toggle('open');
    
    btn.classList.toggle('active');
    btn.textContent = isOpen ? 'æ­ä¹—åˆ¸ã‚’é–‰ã˜ã‚‹' : 'æ­ä¹—åˆ¸ã‚’è¡¨ç¤º';

    if (isOpen) {
        overlay.classList.add('active');
        // ä»–ã®è¦ç´ ãŒé‡ãªã‚‰ãªã„ã‚ˆã†ã«ã‚«ãƒ¼ãƒ‰ã‚’æœ€å‰é¢ã¸
        btn.parentElement.style.zIndex = "1001";
    } else {
        overlay.classList.remove('active');
        btn.parentElement.style.zIndex = "";
    }
}

// èƒŒæ™¯ã‚’ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã«é–‰ã˜ã‚‹ç”¨
function closeAllPasses() {
    const openPasses = document.querySelectorAll('.boarding-pass-container.open');
    openPasses.forEach(container => {
        const btn = container.previousElementSibling;
        container.classList.remove('open');
        btn.classList.remove('active');
        btn.textContent = 'æ­ä¹—åˆ¸ã‚’è¡¨ç¤º';
        btn.parentElement.style.zIndex = "";
    });
    document.getElementById('focusOverlay').classList.remove('active');
}

function getBgClass(timeStr) {
    const hour = parseInt(timeStr.split(':')[0]);
    if (hour >= 5 && hour < 10) return 'bg-dawn';   // 5:00 - 9:59
    if (hour >= 10 && hour < 16) return 'bg-day';   // 10:00 - 15:59
    if (hour >= 16 && hour < 19) return 'bg-sunset'; // 16:00 - 18:59
    return 'bg-night';                               // ãã‚Œä»¥å¤–ï¼ˆå¤œï¼‰
}

let isFocusMode = false;
const cabinAudio = document.getElementById('cabinNoise');

function toggleFocusMode() {
    const screen = document.getElementById('focusModeScreen');
    const content = document.getElementById('focusContent');
    const announcement = document.getElementById('announcementBar');
    const annText = document.getElementById('announcementText');

    isFocusMode = !isFocusMode;

    if (isFocusMode) {
        const activeFlight = flights.find(f => getStatus(f) === 'INFLIGHT');
        if (!activeFlight) {
            alert("ç¾åœ¨é£›è¡Œä¸­ã®ãƒ•ãƒ©ã‚¤ãƒˆãŒå¿…è¦ã§ã™");
            isFocusMode = false; return;
        }

        startCabinNoise();

        // â˜…ä¿®æ­£: å¤–æ ï¼ˆãƒœã‚¿ãƒ³ï¼‰ã‚’1å›ã ã‘ä½œæˆ
        content.innerHTML = `
            <div id="focus-wrapper" style="position:relative; width:100%; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#000;">
                
                <div id="focus-dynamic-content"></div>

                <button onclick="toggleFocusMode()" style="margin-top:40px; background:rgba(255,255,255,0.1); border:1px solid #fff; color:#fff; padding:12px 30px; border-radius:30px; font-weight:bold; cursor:pointer; z-index:10000;">
                    CLOSE WINDOW
                </button>
            </div>
        `;

        const dynamicPart = document.getElementById('focus-dynamic-content');
        updateFocusUI(activeFlight, dynamicPart);
        window.focusTimer = setInterval(() => updateFocusUI(activeFlight, dynamicPart), 1000);

        screen.classList.add('active');
        document.body.classList.add('focus-active');
    } else {
        stopCabinNoise();
        clearInterval(window.focusTimer);
        screen.classList.remove('active');
        document.body.classList.remove('focus-active');
    }
}

function updateFocusUI(f, container) {
    const now = new Date().getTime();
    const [h, m] = f.time.split(':').map(Number);
    const depT = new Date(f.date).setHours(h, m);
    const elapsed = now - depT;
    const totalMs = f.duration * 60000;
    const percent = Math.min(Math.max((elapsed / totalMs) * 100, 0), 100);
    const remainingMins = Math.max(0, f.duration - Math.floor(elapsed / 60000));

    if (!document.getElementById('focus-window-body')) {
        const hour = new Date().getHours();
        let skyGradient = 'linear-gradient(to bottom, #1e90ff 0%, #87ceeb 100%)'; 
        if (hour >= 18 || hour < 6) skyGradient = 'linear-gradient(to bottom, #001a33 0%, #004482 100%)';

        container.innerHTML = `
            <div id="focus-window-body" style="text-align:center; color: white;">
                <div style="font-size: 0.8rem; letter-spacing: 4px; opacity: 0.6; margin-bottom: 20px;">CRUISING</div>
                
                <div class="window-outer-frame">
                    <div class="window-inner-frame" onclick="toggleShade()">
                        <div id="window-shade">
                            <div class="shade-handle"></div>
                        </div>
                        <div class="sky-background" style="background: ${skyGradient}; position:absolute; top:0; left:0; width:100%; height:100%; z-index:1;">
                            <div class="real-cloud" style="top:25%; transform:scale(0.5); animation-duration: 12s; opacity: 0.5;"></div>
                            <div class="real-cloud" style="top:45%; transform:scale(1.2); animation-duration: 25s; animation-delay: -5s;"></div>
                            <div class="real-cloud" style="top:75%; transform:scale(1.8); animation-duration: 40s; animation-delay: -15s; filter: blur(12px); opacity: 0.4;"></div>
                        </div>
                    </div>
                </div>

                <div style="font-size: 2.2rem; font-weight: bold; letter-spacing: 2px; margin-top:30px;">${f.from} âœˆ ${f.to}</div>

                <div style="width:300px; height:2px; background:rgba(255,255,255,0.2); margin:30px auto 10px; position:relative; border-radius: 2px;">
                    <div style="position:absolute; width:100%; height:100%; background-image: linear-gradient(to right, white 50%, transparent 50%); background-size: 20px 100%; opacity: 0.3;"></div>
                    <div id="focus-plane" style="position:absolute; top:-12px; font-size:18px; transition: left 1s linear; z-index:2;">âœˆ</div>
                </div>
                
                <div id="focus-timer-text" style="font-size: 1.5rem; font-family: monospace; color: var(--gold); font-weight: bold; margin-top:10px;"></div>
                
                <div style="font-size: 0.7rem; opacity: 0.5; margin-top: 30px; font-style: italic;">
                    "Enjoy your flight over the clouds."
                </div>
            </div>
        `;
    }

    // æ•°å€¤ã¨é£›è¡Œæ©Ÿã®ä½ç½®ã‚’æ›´æ–°
    const plane = document.getElementById('focus-plane');
    if (plane) plane.style.left = `calc(${percent}% - 9px)`; // ã‚¢ã‚¤ã‚³ãƒ³ã®åŠåˆ†ãšã‚‰ã—ã¦ä¸­å¿ƒã«åˆã‚ã›ã‚‹

    const timerText = document.getElementById('focus-timer-text');
    if (timerText) timerText.innerText = `åˆ°ç€ã¾ã§: ${remainingMins} åˆ†`;
}

function toggleShade() {
    const shade = document.getElementById('window-shade');
    if (shade) {
        shade.classList.toggle('shade-closed');
        console.log("Shade toggled"); // ãƒ‡ãƒãƒƒã‚°ç”¨
    }
}   

let audioCtx = null;
let noiseNode = null;
let filterNode = null;

function startCabinNoise() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }

    if (noiseNode) return;

    const bufferSize = 2 * audioCtx.sampleRate;
    const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const output = noiseBuffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
    }

    noiseNode = audioCtx.createBufferSource();
    noiseNode.buffer = noiseBuffer;
    noiseNode.loop = true;

    // ä½éŸ³ã‚’å¼·èª¿ã™ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
    filterNode = audioCtx.createBiquadFilter();
    filterNode.type = 'lowpass';
    // 150ã‹ã‚‰200ã«å°‘ã—ä¸Šã’ã‚‹ã¨ã€éŸ³ã«åšã¿ãŒå‡ºã¾ã™
    filterNode.frequency.setValueAtTime(200, audioCtx.currentTime); 

    const gainNode = audioCtx.createGain();
    // â˜…ã“ã“ã‚’ 0.1 ã‹ã‚‰ 0.4 ã«å¤‰æ›´ï¼ˆ4å€ã®éŸ³é‡ï¼‰
    gainNode.gain.setValueAtTime(1, audioCtx.currentTime); 

    noiseNode.connect(filterNode);
    filterNode.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    noiseNode.start();
}

function stopCabinNoise() {
    if (noiseNode) {
        noiseNode.stop();
        noiseNode.disconnect();
        noiseNode = null; // ãƒªã‚»ãƒƒãƒˆ
    }
}

// 1. ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±ã‚’URLã«å¤‰æ›ã—ã¦QRã‚’è¡¨ç¤º
function shareFlight(id) {
    const f = flights.find(x => x.id === id);
    if (!f) return;

    // ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®ã—ã¦URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½œæˆ
    const data = `${f.from},${f.to},${f.date},${f.time},${f.duration}`;
    const shareUrl = `${window.location.origin}${window.location.pathname}?add=${btoa(data)}`;

    // QRã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆ
    const qrContainer = document.getElementById("qrcode");
    qrContainer.innerHTML = ""; // å‰ã®QRã‚’ã‚¯ãƒªã‚¢
    new QRCode(qrContainer, {
        text: shareUrl,
        width: 200,
        height: 200
    });

    document.getElementById('qrModal').style.display = 'flex';
}

// 2. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªï¼ˆå—ã‘å–ã‚Šå´ï¼‰
window.addEventListener('load', () => {
    const params = new URLSearchParams(window.location.search);
    const addData = params.get('add');
    if (addData) {
        try {
            // Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦é…åˆ—ã«æˆ»ã™
            const decoded = atob(addData).split(',');
            
            // ãƒ‡ãƒ¼ã‚¿ã®é †ç•ªã‚’QRç”Ÿæˆæ™‚ã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã‚‹
            // 0:from, 1:to, 2:date, 3:time, 4:duration, 5:class, 6:seat
            const fromAp = airports.find(a => a.code === decoded[0]);
            const toAp = airports.find(a => a.code === decoded[1]);

            const newFlight = {
                id: Date.now(),
                from: decoded[0],
                fromName: fromAp ? fromAp.name : '',
                to: decoded[1],
                toName: toAp ? toAp.name : '',
                date: decoded[2],
                time: decoded[3],
                duration: parseInt(decoded[4]),
                boardingClass: decoded[5] || 'ECONOMY',
                seat: decoded[6] || 'ANY',
                checkedIn: false
            };

            // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜å‡ºç™ºåœ°ãƒ»ç›®çš„åœ°ãƒ»æ™‚åˆ»ãªã‚‰è¿½åŠ ã—ãªã„ï¼‰
            const isDuplicate = flights.some(f => f.from === newFlight.from && f.time === newFlight.time && f.date === newFlight.date);
            
            if (!isDuplicate) {
                flights.push(newFlight);
                localStorage.setItem('ana_flights_final', JSON.stringify(flights));
                render();
                alert("âœˆï¸ å…±æœ‰ã•ã‚ŒãŸãƒ•ãƒ©ã‚¤ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸï¼");
            }
            
            // URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹
            window.history.replaceState({}, document.title, window.location.pathname);
        } catch (e) {
            console.error("å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        }
    }
});

let videoStream = null;

function startScan() {
    const video = document.getElementById("video");
    const modal = document.getElementById("scanModal");
    modal.style.display = "flex";

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
        videoStream = stream;
        video.srcObject = stream;
        video.setAttribute("playsinline", true);
        video.play();
        requestAnimationFrame(tick);
    });
}

function stopScan() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
    document.getElementById("scanModal").style.display = "none";
}

function tick() {
    const video = document.getElementById("video");
    const canvasElement = document.getElementById("canvas");
    const canvas = canvasElement.getContext("2d");

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

        if (code) {
            // QRã‚³ãƒ¼ãƒ‰ã®ä¸­ã«URLï¼ˆ?add=...ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (code.data.includes("?add=")) {
                const url = new URL(code.data);
                const addData = url.searchParams.get('add');
                if (addData) {
                    processAddData(addData); // æ—¢å­˜ã®å–ã‚Šè¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯ã¸
                    stopScan();
                    alert("ãƒ•ãƒ©ã‚¤ãƒˆã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼");
                    return;
                }
            }
        }
    }
    if (document.getElementById("scanModal").style.display === "flex") {
        requestAnimationFrame(tick);
    }
}

// å—ã‘å–ã‚Šãƒ­ã‚¸ãƒƒã‚¯ã‚’å…±é€šåŒ–
function processAddData(addData) {
    try {
        const decoded = atob(addData).split(',');
        const newFlight = {
            id: Date.now(),
            from: decoded[0], to: decoded[1],
            date: decoded[2], time: decoded[3],
            duration: parseInt(decoded[4]),
            boardingClass: decoded[5] || 'ECONOMY',
            seat: decoded[6] || 'ANY',
            checkedIn: false
        };
        flights.push(newFlight);
        localStorage.setItem('ana_flights_final', JSON.stringify(flights));
        render();
    } catch(e) { console.error("Invalid QR Data"); }
}

</script>

</body>
</html>
