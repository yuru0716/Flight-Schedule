<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#002D5A">
    <title>Flight Schedule</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root {
            /* JAL-like Blue Theme (Solid & Sharp) */
            --ana-blue-dark: #002D5A;
            /* Deep Navy */
            --ana-blue-main: #002D5A;
            /* Primary Brand Color */
            --ana-blue-sky: #0055A4;
            /* Brighter accent blue */
            --ana-gradient: #002D5A;
            /* Solid color, no gradient */
            --bg-gray: #f2f2f2;
            /* Lighter, starker gray */
            --plane-body: #ffffff;
            --plane-wing: #dce1e6;
            --text-main: #111111;
            /* Darker black for high contrast */
            --danger: #d93025;
            --success: #1e8e3e;
            --gold: #c5a065;
            --diamond: #b9f2ff;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #001a3a 0%, #003366 40%, #004c99 100%);
            color: white;
            padding: 16px 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0, 20, 60, 0.25);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-left {
            display: flex;
            flex-direction: column;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 0.03em;
        }

        .mile-display {
            font-size: 0.75rem;
            color: var(--gold);
            font-weight: bold;
            margin-top: 3px;
            letter-spacing: 0.05em;
        }

        .status-badge-header {
            font-size: 0.6rem;
            padding: 1px 5px;
            border-radius: 3px;
            margin-left: 5px;
            vertical-align: middle;
        }

        .st-BRONZE {
            background: #cd7f32;
            color: white;
        }

        .st-SAPPHIRE {
            background: #0f52ba;
            color: white;
        }

        .st-DIAMOND {
            background: var(--diamond);
            color: #004482;
        }

        .header-icon {
            font-size: 1.5rem;
            cursor: pointer;
        }

        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        /* Flight Card */
        /* Flight Card */
        /* Flight Card */
        .flight-card {
            background: white;
            border-radius: 12px;
            /* Adding roundness back */
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            /* Softer, deeper shadow */
            position: relative;
            overflow: hidden;
            border-left: 6px solid var(--ana-blue-main);
        }

        .noshow-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            pointer-events: none;
        }

        .noshow-stamp {
            border: 4px solid var(--danger);
            color: var(--danger);
            padding: 10px 30px;
            font-size: 2rem;
            font-weight: 900;
            transform: rotate(-15deg);
            border-radius: 8px;
            background: white;
        }

        .card-inner {
            padding: 15px;
        }

        .route-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .city-box {
            text-align: center;
            width: 80px;
        }

        .city-code {
            font-size: 2rem;
            font-weight: 800;
            color: var(--ana-blue-dark);
            letter-spacing: 1px;
            line-height: 1;
        }

        .city-name {
            font-size: 0.7rem;
            color: #777;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .time-row {
            display: flex;
            justify-content: space-between;
            background: #f4f7fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .time-box {
            text-align: center;
            flex: 1;
        }

        .time-label {
            font-size: 0.7rem;
            color: #666;
            font-weight: bold;
        }

        .time-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .duration-center {
            font-size: 0.8rem;
            color: #999;
            align-self: center;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 2px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            background: #999;
        }

        .badge-reserved {
            background: var(--ana-blue-sky);
        }

        .badge-checkin {
            background: var(--success);
        }

        .badge-noshow {
            background: var(--danger);
        }

        .badge-inflight {
            background: var(--ana-blue-main);
            animation: pulse 2s infinite;
        }

        .badge-arrived {
            background: var(--gold);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .boarding-pass {
            background: #f9f9f9;
            border-top: 1px dashed #ddd;
            padding: 12px;
            font-size: 0.8rem;
        }

        .mile-tag {
            color: var(--gold);
            font-weight: bold;
            font-size: 0.7rem;
            text-align: right;
            margin-top: 5px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 45, 90, 0.85);
            z-index: 1000;
            z-index: 1000;
            backdrop-filter: blur(5px);
            /* Flex centering */
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #fff;
            width: 95%;
            max-width: 550px;
            /* Slightly wider */
            height: auto;
            min-height: 45vh;
            /* Reduced height */
            max-height: 85vh;
            /* Keep some margin at bottom */
            margin: auto;
            /* Move lower */
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header-ana {
            background: var(--ana-blue-main);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .modal-footer {
            background: white;
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        /* Inputs */
        .form-group {
            margin-bottom: 15px;
            background: white;
            padding: 15px;
            border-radius: 2px;
            border: 1px solid #eee;
        }

        .form-group label {
            display: block;
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 8px;
        }

        select,
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 2px;
            box-sizing: border-box;
            font-size: 1rem;
            background: #fff;
            -webkit-appearance: none;
            appearance: none;
        }

        /* Settings List */
        .airport-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .airport-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 2px;
            border-left: 4px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .airport-code-tag {
            background: var(--ana-blue-sky);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 10px;
        }

        .delete-btn {
            color: var(--danger);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Improved Seat Map */
        .plane-wrapper {
            position: relative;
            width: 320px;
            /* Slightly wider */
            margin: 30px auto;
            padding-top: 80px;
            padding-bottom: 80px;
            /* No more external shapes, we will style the container itself as the fuselage interior */
        }

        .fuselage {
            background: #fdfdfd;
            width: 100%;
            height: 100%;
            border-radius: 150px 150px 90px 90px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            box-shadow:
                0 20px 50px rgba(0, 0, 0, 0.15),
                inset 0 0 40px rgba(0, 0, 0, 0.05);
            /* Inner shadow for depth */
            border: 8px solid #eee;
            /* Thicker walls */
        }

        .cockpit {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 35px;
            background: linear-gradient(180deg, #333, #555);
            border-radius: 8px 8px 40% 40%;
            z-index: 2;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid #aaa;
        }

        .wing-left,
        .wing-right {
            display: none;
            /* Simplify visuals inside modal */
        }

        .seat-map-container {
            position: relative;
            z-index: 10;
            padding: 20px 14px;
        }

        .seat-row {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 12px;
            /* More legroom visually */
            align-items: center;
        }

        .row-number {
            width: 20px;
            font-size: 0.7rem;
            color: #aaa;
            text-align: center;
            font-weight: bold;
        }

        .aisle-gap {
            width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #ccc;
        }

        .seat {
            width: 38px;
            height: 48px;
            border: none;
            border-radius: 6px 6px 10px 10px;
            /* Chair shape */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            box-shadow:
                0 4px 6px rgba(0, 0, 0, 0.05),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1);
            /* Bottom thickness */
            position: relative;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        /* Headrest */
        .seat::before {
            content: '';
            position: absolute;
            top: -4px;
            width: 80%;
            height: 8px;
            background: inherit;
            border-radius: 4px;
            opacity: 0.8;
        }

        .seat:active {
            transform: scale(0.95);
        }

        .seat.selected {
            background: var(--ana-blue-main);
            color: white;
            box-shadow:
                0 4px 10px rgba(0, 45, 90, 0.3),
                inset 0 -3px 0 rgba(0, 0, 0, 0.2);
        }

        /* Class specific seat colors */
        .seat-first {
            background: #fffcf0;
            border: 1px solid #e3c880;
            color: #8a6d3b;
        }

        .seat-business {
            background: #f0f8ff;
            border: 1px solid #bce0fd;
            color: #31708f;
        }

        .seat-economy {
            background: #fff;
            border: 1px solid #ddd;
            color: #555;
        }

        .seat.selected.seat-first {
            background: #d4af37;
            color: white;
            border-color: transparent;
        }

        .seat.selected.seat-business {
            background: #0055A4;
            color: white;
            border-color: transparent;
        }


        /* Buttons */
        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            /* Softer buttons */
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .btn:active {
            transform: scale(0.98);
            box-shadow: none;
        }

        .btn-save {
            background: var(--ana-blue-dark);
            color: white;
        }

        .btn-add {
            background: var(--success);
            color: white;
            margin-top: 10px;
        }

        .btn-checkin {
            background: var(--success);
            color: white;
            padding: 10px;
            border-radius: 2px;
            margin-top: 10px;
            width: 100%;
        }

        .btn-disabled {
            background: #ccc !important;
            cursor: not-allowed;
        }

        .fab {
            position: fixed;
            bottom: 30px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: var(--ana-blue-main);
            color: white;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: none;
            cursor: pointer;
            z-index: 90;
        }

        .in-app-banner {
            position: fixed;
            top: -100px;
            left: 0;
            width: 100%;
            background: var(--ana-blue-main);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
        }

        .in-app-banner.show {
            top: 0;
        }

        .swipe-container {
            position: relative;
            width: 100%;
            height: 50px;
            background: #eee;
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .swipe-handle {
            position: absolute;
            left: 0;
            top: 0;
            width: 60px;
            height: 50px;
            background: var(--ana-blue-main);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            z-index: 10;
            cursor: grab;
            touch-action: none;
        }

        /* 切り離しアニメーション */
        .stub-tear {
            animation: tear-off 0.6s forwards ease-out;
        }

        @keyframes tear-off {
            0% {
                transform: rotate(0deg) translateY(0);
                opacity: 1;
            }

            30% {
                transform: rotate(5deg) translateY(10px);
                opacity: 1;
            }

            100% {
                transform: rotate(15deg) translateY(100px);
                opacity: 0;
            }
        }

        /* タブメニュー全体のスタイル */
        .tab-container {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 60px;
            /* ヘッダーの高さに合わせて調整 */
            z-index: 99;
            /* ヘッダー(100)のすぐ下 */
        }

        .tab-btn {
            flex: 1;
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--ana-blue-main);
            border-bottom: 3px solid var(--ana-blue-main);
            background: rgba(0, 45, 90, 0.05);
        }

        /* 過去のチケット用スタイル */
        .flight-card.history {
            border-top: 4px solid #999;
            /* 履歴は青ではなくグレーの線に */
        }

        /* 履歴カード内の特定の要素だけを白黒・薄くする */
        .flight-card.history .city-code,
        .flight-card.history .time-value,
        .flight-card.history .route-row,
        .flight-card.history .time-row {
            filter: grayscale(1);
            opacity: 0.6;
        }

        .boarding-pass {
            background: white;
            color: #333;
            border-radius: 2px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 1px solid #eee;
        }

        /* 2次元バーコード（ダミー） */
        .qr-placeholder {
            width: 140px;
            height: 140px;
            background: #f5f5f5;
            margin: 10px auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 2px;
        }

        /* 情報表示レイアウト */
        .pass-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* 2列にして大きく見せる */
            gap: 20px;
            text-align: center;
            border-top: 1px dashed #ccc;
            padding-top: 20px;
        }

        .pass-label {
            font-size: 0.65rem;
            color: #888;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .pass-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #000;
        }

        /* グループ番号の強調 */
        .group-badge {
            background: #000;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .seat-highlight {
            font-size: 2.5rem;
            /* かなり大きく */
            font-weight: bold;
            color: var(--ana-blue-main);
            line-height: 1;
            margin: 10px 0;
        }

        /* 搭乗券のコンテナ（最初は隠す） */
        .boarding-pass-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 開いた時の状態 */
        .boarding-pass-container.open {
            max-height: 500px;
            /* 十分な高さを指定 */
        }

        /* 開閉ボタンのスタイル */
        .toggle-pass-btn {
            width: 100%;
            background: #f8f9fa;
            border: 1px dashed var(--ana-blue-main);
            color: var(--ana-blue-main);
            padding: 10px;
            border-radius: 2px;
            margin-top: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .toggle-pass-btn::after {
            content: '▼';
            font-size: 0.6rem;
            transition: transform 0.3s;
        }

        .toggle-pass-btn.active::after {
            transform: rotate(180deg);
        }

        .focus-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            /* 背景を少しぼかす */
            z-index: 900;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
        }

        .focus-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* 搭乗券がフォーカスされた時の強調 */
        .boarding-pass-container.open {
            position: relative;
            z-index: 1000;
            /* 暗幕より上に表示 */
        }

        .boarding-pass-container.open .boarding-pass {
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
            /* ほんの少しだけ大きくして浮遊感を出す */
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 15px 0;
            position: relative;
            overflow: visible;
        }

        /* 実際に伸びるバー */
        .progress-bar {
            height: 100%;
            background: var(--ana-gradient);
            border-radius: 3px;
            transition: width 1s linear;
        }

        /* バーの先端で飛ぶ飛行機アイコン */
        .progress-plane {
            position: absolute;
            top: -8px;
            transform: translateX(-50%);
            font-size: 1.2rem;
            transition: left 1s linear;
        }

        /* 進捗バーと一緒に <style> に追加 */
        .pulse {
            color: #e60012;
            /* ANAの機材トラブル表示ではなく、ライブ状態を示す赤 */
            animation: blink 1.5s infinite;
            margin-right: 4px;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 1;
            }
        }

        /* 時間帯ごとの背景パターン */
        .bg-day {
            background: linear-gradient(135deg, #4da3ff 0%, #0056b3 100%);
        }

        /* 昼：青空 */
        .bg-sunset {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
        }

        /* 夕方：茜色 */
        .bg-night {
            background: linear-gradient(135deg, #001f3f 0%, #000814 100%);
        }

        /* 夜：星空 */
        .bg-dawn {
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
        }

        /* 明け方：薄明 */

        /* カードの文字が見やすいように調整 */
        .flight-card.dynamic-bg {
            color: white !important;
            border: none !important;
        }

        .flight-card.dynamic-bg .city-code,
        .flight-card.dynamic-bg .time-value {
            color: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            /* 影を少し強めて視認性アップ */
            font-weight: 800;
        }

        .flight-card.dynamic-bg .city-name,
        .flight-card.dynamic-bg .time-label,
        .flight-card.dynamic-bg .duration-center {
            color: rgba(255, 255, 255, 0.85) !important;
        }

        .flight-card.dynamic-bg .time-row {
            background: rgba(255, 255, 255, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 進捗バーの背景も少し白くして見やすくする */
        .flight-card.dynamic-bg .progress-container {
            background: rgba(255, 255, 255, 0.25) !important;
        }

        .flight-card.dynamic-bg .progress-plane {
            color: #ffffff;
        }

        /* チェックイン後のメインエリア（縦並び） */
        .flight-main-content {
            display: flex;
            flex-direction: column;
            /* 縦並びに設定 */
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
        }

        /* 表面の窓スタイル */
        .card-window-wrapper {
            width: 60px;
            height: 80px;
            background: #000;
            border: 4px solid #e0e0e0;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* シェード（初期は半分閉じ） */
        .card-window-shade {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            background: linear-gradient(to bottom, #d1d1d1, #a0a0a0);
            border-bottom: 2px solid #777;
            z-index: 5;
            transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 飛行中にシェードを開ける */
        .status-inflight .card-window-shade {
            transform: translateY(-100%);
        }

        /* 雲の動き */
        .cloud-particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            filter: blur(4px);
            opacity: 0.5;
            animation: particles-move 15s linear infinite;
        }

        @keyframes particles-move {
            from {
                transform: translateX(80px);
            }

            to {
                transform: translateX(-60px);
            }
        }

        /* 表面の窓スタイル */
        .card-window-wrapper {
            width: 60px;
            height: 80px;
            background: #000;
            border: 4px solid #e0e0e0;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .card-window-shade {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            background: linear-gradient(to bottom, #d1d1d1, #a0a0a0);
            border-bottom: 2px solid #777;
            z-index: 5;
            transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* INFLIGHT状態の時だけシェードを上げる */
        .dynamic-bg.bg-inflight .card-window-shade,
        .dynamic-bg[class*="status-inflight"] .card-window-shade {
            transform: translateY(-100%);
        }

        /* 空の色 */
        .sky-morning {
            background: linear-gradient(to bottom, #4a90e2, #f5a623);
        }

        .sky-day {
            background: linear-gradient(to bottom, #1e90ff, #87ceeb);
        }

        .sky-evening {
            background: linear-gradient(to bottom, #2c3e50, #ff7e5f);
        }

        .sky-night {
            background: linear-gradient(to bottom, #00000c, #000050);
        }

        .card-window-shade {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #d1d1d1, #a0a0a0);
            border-bottom: 3px solid #777;
            z-index: 5;
            /* 1秒かけて動く設定 */
            transition: transform 1.0s cubic-bezier(0.45, 0.05, 0.55, 0.95);
            transform: translateY(-100%);
            /* 基本は開いている */
        }

        /* 窓の中の景色（地上と空の切り替え用） */
        .window-view-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        /* 地上の景色の簡易表現 */
        .ground-view {
            background: linear-gradient(to bottom, #87ceeb 0%, #87ceeb 50%, #91b33e 50%, #91b33e 100%);
            width: 100%;
            height: 100%;
        }

        /* フォーカスモード用のスタイル */
        .focus-active body {
            overflow: hidden;
            /* スクロール禁止 */
        }

        .focus-overlay-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .focus-overlay-screen.active {
            display: flex;
            animation: fadeIn 0.8s ease;
        }

        .focus-exit-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .runway-loader {
            width: 80%;
            max-width: 400px;
            height: 30px;
            border-bottom: 2px dashed rgba(255, 255, 255, 0.3);
            position: relative;
            margin: 20px auto;
        }

        .plane-icon-progress {
            position: absolute;
            bottom: -10px;
            font-size: 1.5rem;
            transition: left 1s linear;
        }

        /* アナウンスのテロップ風アニメーション */
        .announcement-bar {
            background: rgba(0, 68, 130, 0.8);
            color: white;
            padding: 10px;
            width: 100%;
            position: absolute;
            top: 80px;
            font-size: 0.8rem;
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
        }

        /* 雲の流れるアニメーション */
        @keyframes cloudFlow {
            from {
                left: 120%;
            }

            to {
                left: -120%;
            }
        }

        .real-cloud {
            position: absolute;
            width: 100px;
            height: 30px;
            background: #fff;
            border-radius: 50%;
            filter: blur(8px);
            opacity: 0.8;
            animation: cloudFlow linear infinite;
            box-shadow:
                /* 複数の円をずらして重ねることでモコモコ感を出す */
                40px 10px 0 10px #fff,
                -30px 5px 0 5px #fff,
                15px -15px 0 15px #fff;
        }

        /* 夜間用の雲の色調整（オプション） */
        .focus-active .real-cloud {
            background: #ccddee;
            /* 少し青みがかった白 */
        }

        /* 外枠：機体の壁面 */
        .window-outer-frame {
            width: 320px;
            height: 440px;
            margin: 0 auto;
            /* 航空機の内壁のようなオフホワイト */
            background: #f1f3f5;
            border-radius: 130px;
            padding: 20px;
            /* 窓が壁に埋め込まれているような深みのある影 */
            box-shadow:
                0 30px 60px rgba(0, 0, 0, 0.3),
                inset 0 2px 10px rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #d1d5db;
        }

        /* 窓枠の内側：奥行き */
        .window-inner-frame {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 105px;
            border: 10px solid #cbd5e1;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 10px 30px rgba(0, 0, 0, 0.5);
            cursor: pointer;
        }

        /* シェード：色をハッキリさせ、手前に配置 */
        #window-shade {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            /* ★ここが修正ポイント：模様とグラデーションを1行で重ねる */
            background-image:
                /* 1層目：蛇腹のテクスチャ（隙間が透明） */
                repeating-linear-gradient(0deg,
                    rgba(255, 255, 255, 0.9) 0px,
                    rgba(255, 255, 255, 0.9) 1px,
                    transparent 1px,
                    transparent 15px),
                /* 2層目：ベースの色（不透明なグラデーション） */
                linear-gradient(to bottom, #f3f4f6 0%, #d1d5db 100%) !important;

            /* 万が一画像が読み込めない場合の不透明色 */
            background-color: #f3f4f6 !important;

            /* 景色の手前に表示 */
            z-index: 10 !important;

            /* アニメーション設定 */
            transition: transform 1.2s cubic-bezier(0.45, 0.05, 0.55, 0.95);
            transform: translateY(-100%);
            /* 初期状態は上（開いている） */

            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 25px;
            pointer-events: none;
            /* クリックを親要素に通す */
        }

        /* シェードが閉じた状態 */
        #window-shade.shade-closed {
            transform: translateY(-5%) !important;
        }

        /* つまみ */
        .shade-handle {
            width: 70px;
            height: 8px;
            background: #6b7280;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        #focusModeScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            /* デフォルト：明るい機内の色 */
            background: radial-gradient(circle at center, #e6e9ed 0%, #bdc3c7 100%);

            /* 常にザラついた質感を出すための画像（あれば） */
            /* background-image: url('...'); */

            z-index: 9999;
            display: none;
            /* 通常は非表示 */
            flex-direction: column;
            align-items: center;
            justify-content: center;

            /* 色がゆっくり変わるようにアニメーションを設定 */
            transition: background 1.5s ease;
        }

        #focusContent::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            pointer-events: none;
            background-image: url('https://www.transparenttextures.com/patterns/asfalt-light.png');
        }

        #focusModeScreen.active {
            display: flex;
        }

        #focus-window-body {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8), 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #focus-timer-text {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9);
            background: rgba(0, 0, 0, 0.2);
            /* わずかに背景を暗くして浮かび上がらせる */
            padding: 5px 15px;
            border-radius: 10px;
            display: inline-block;
        }

        /* 飛行ルート（都市名）の強調 */
        .focus-route {
            font-size: 2.2rem;
            font-weight: bold;
            letter-spacing: 2px;
            margin-top: 30px;
            filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.7));
        }

        .info-glass-panel {
            background: rgba(0, 0, 0, 0.3);
            /* 薄い黒の背景 */
            backdrop-filter: blur(8px);
            /* ★ここが重要：背景をぼかす */
            -webkit-backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 20px;
            margin: 20px auto;
            width: 320px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* 文字にしっかりとした影を追加 */
        .focus-text-bold {
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
            font-weight: bold;
        }

        /* ルート情報の文字をさらに強調 */
        .focus-route {
            font-size: 2rem;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        /* タイマー文字のスタイル */
        #focus-timer-text {
            font-size: 1.6rem;
            color: #ffcc00;
            /* より視認性の高いゴールドイエロー */
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* モバイル対応：画面が小さい場合に要素を少し縮小する */
        @media screen and (max-height: 750px) {
            .window-outer-frame {
                transform: scale(0.75);
                /* 窓を75%に縮小 */
                margin: -30px auto !important;
            }

            .info-glass-panel {
                transform: scale(0.85);
                /* パネルを85%に縮小 */
                margin: 0 auto !important;
                padding: 15px !important;
            }

            #focus-window-body>div:first-child {
                margin-bottom: 5px !important;
                /* "CRUISING"の余白を詰める */
            }
        }

        /* さらに画面が小さい場合 */
        @media screen and (max-height: 600px) {
            .window-outer-frame {
                transform: scale(0.6);
            }

            .info-glass-panel {
                transform: scale(0.75);
            }
        }

        /* リアルな空のレイヤー */
        .sky.bg-day {
            background: linear-gradient(to bottom, #003366 0%, #0076cb 60%, #add8e6 100%);
        }

        .sky.bg-night {
            background: linear-gradient(to bottom, #00050a 0%, #001a33 70%, #003366 100%);
        }

        .sky.bg-morning {
            background: linear-gradient(to bottom, #001a33 0%, #4b0082 40%, #ff8c00 80%, #ffd700 100%);
        }

        .sky.bg-evening {
            background: linear-gradient(to bottom, #001a33 0%, #800080 30%, #ff4500 70%, #ff8c00 100%);
        }

        /* 窓の奥行き感を出すガラスの反射 */
        .window-frame::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 50%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
            border-radius: 40% 40% 45% 45%;
        }

        .focus-note-container {
            position: absolute;
            bottom: 40px;
            width: 80%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.9);
            /* 半透明の紙質 */
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .note-header {
            background: var(--ana-blue-dark);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            letter-spacing: 1px;
        }

        #focus-textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: none;
            background: repeating-linear-gradient(white, white 24px, #e5e5e5 25px);
            /* 罫線 */
            line-height: 25px;
            font-family: inherit;
            resize: none;
            color: var(--text-main);
            outline: none;
        }

        #toggle-note {
            background: transparent;
            border: 1px solid white;
            color: white;
            font-size: 10px;
            cursor: pointer;
            padding: 2px 5px;
        }

        /* 最小化状態 */
        .focus-note-container.minimized {
            height: 35px;
        }

        .focus-note-container.minimized #focus-textarea {
            display: none;
        }

        /* レイアウトの基本設定 */
        .focus-layout-container {
            display: flex;
            flex-direction: row;
            /* PCは横並び */
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            gap: 30px;
            padding: 20px;
        }

        .focus-window-area {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        #focus-note-panel {
            width: 350px;
            /* PCでの幅 */
            height: 500px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #focus-textarea-box {
            flex: 1;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        /* スマホ用スタイル (1024px以下) */
        @media screen and (max-width: 1024px) {
            .focus-layout-container {
                flex-direction: column;
            }

            #focus-note-panel {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                z-index: 10000;
                border-radius: 0;
                transform: translateY(100%);
                /* 最初は下に隠す */
                opacity: 0;
                display: none;
            }

            #focus-note-panel.memo-open {
                display: flex;
                transform: translateY(0);
                opacity: 1;
            }

            .mobile-memo-trigger {
                position: fixed;
                bottom: 100px;
                right: 20px;
                background: var(--ana-gradient);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 30px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                z-index: 9999;
            }

            .mobile-only-btn {
                background: white;
                color: var(--ana-blue-dark);
                border: none;
                padding: 5px 15px;
                border-radius: 20px;
                font-weight: bold;
            }
        }

        /* PCではスマホ用ボタンを隠す */
        @media screen and (min-width: 1025px) {

            .mobile-memo-trigger,
            .mobile-only-btn {
                display: none;
            }
        }

        /* レイアウトの外枠：中央寄せ用 */
        .focus-layout-outer {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .focus-layout-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 1000px;
            /* ここを調整して窓とメモの距離を縮める */
            gap: 40px;
            /* 窓とメモ帳の間の距離 */
            padding: 20px;
        }

        .focus-window-area {
            flex: 0 0 auto;
            /* 窓のサイズを固定気味にする */
        }

        #focus-note-panel {
            flex: 1;
            /* メモ帳が残りのスペースを埋める */
            max-width: 450px;
            /* メモ帳が大きくなりすぎないように */
            height: 500px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #focus-textarea-box {
            flex: 1;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            box-sizing: border-box;
        }

        /* スマホ用設定 (1024px以下) */
        @media screen and (max-width: 1024px) {
            .focus-layout-container {
                flex-direction: column;
                width: 100%;
                max-width: none;
                gap: 0;
            }

            #focus-note-panel {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                max-width: none;
                z-index: 10000;
                border-radius: 0;
                transform: translateY(100%);
                opacity: 0;
                display: none;
            }

            #focus-note-panel.memo-open {
                display: flex;
                transform: translateY(0);
                opacity: 1;
            }

            .mobile-memo-trigger {
                position: fixed;
                bottom: 40px;
                right: 20px;
                background: var(--ana-gradient);
                color: white;
                border: none;
                padding: 15px 25px;
                border-radius: 30px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
                z-index: 9999;
                font-weight: bold;
            }
        }

        /* PC用ボタン非表示 */
        @media screen and (min-width: 1025px) {

            .mobile-memo-trigger,
            .mobile-only-btn {
                display: none;
            }
        }

        /* --- ボトムメニュー用CSS --- */
        .my-app-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 75px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eeeeee;
            z-index: 9999;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .my-app-nav-link {
            text-decoration: none;
            color: #999999;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            flex: 1;
            transition: color 0.2s;
            cursor: pointer;
        }

        .my-app-nav-icon-text {
            font-size: 22px;
            margin-bottom: 2px;
        }

        .my-app-nav-link-center {
            position: relative;
        }

        .my-app-plus-circle {
            background-color: var(--ana-blue-main);
            color: #ffffff;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            margin-top: -35px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: transform 0.1s;
        }

        .my-app-plus-circle:active {
            transform: scale(0.92);
        }

        .my-app-nav-link-active {
            color: var(--ana-blue-main);
            font-weight: bold;
        }

        .board {
            background: rgba(5, 15, 30, 0.9);
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            font-size: 16px;
            backdrop-filter: blur(2px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow:
                0 0 0 1px rgba(0, 0, 0, 0.6),
                0 20px 40px rgba(0, 0, 0, 0.8);
        }

        /* 行アイテム */
        .board-row {
            display: grid;
            grid-template-columns: 1.3fr 0.8fr 0.8fr 1.1fr 1.8fr;
            gap: 6px;
            font-size: 1rem;
            /* ほんの少し小さめ */
            letter-spacing: 0.06em;
            line-height: 1.4;
            padding: 6px 10px;
        }

        /* 見出し行 */
        .board-row.header {
            color: #94a3b8;
            text-shadow: 0 0 4px rgba(148, 163, 184, 0.4);
            font-size: 0.85rem;
            letter-spacing: 0.08em;
        }

        /* 境目なし＋行間すっきり */
        .board-row:not(.header) {
            border-bottom: 1px solid #111;
        }

        /* 自分便は白く */
        .board-row:not(.external)>span {
            color: #fff;
        }

        /* 外部便は薄め */
        .board-row.external>span {
            color: #777;
        }

        /* 状態文字の強調 */
        .board-row span:nth-child(5) {
            font-weight: bold;
            text-align: right;
            letter-spacing: 0.08em;
        }

        /* 状態ごとの色 */
        .status-boarding {
            color: #22c55e;
            text-shadow: 0 0 6px rgba(34, 197, 94, 0.6);
        }

        .status-checkinopen {
            color: #38bdf8;
            text-shadow: 0 0 6px rgba(56, 189, 248, 0.6);
        }

        .status-lastcall {
            color: #fb7185;
            text-shadow: 0 0 6px rgba(251, 113, 133, 0.6);
        }

        .status-delayed {
            color: #f97316;
            text-shadow: 0 0 6px rgba(249, 115, 22, 0.6);
        }

        .status-scheduled {
            color: #eee;
        }

        /* ホバーで少し明るく */
        .board-row:hover:not(.header)>span {
            color: #fff;
        }

        .board-frame {
            background: linear-gradient(180deg,
                    #0b1d33 0%,
                    #050b14 100%);
        }

        .board-title {
            background: #1a1a1a;
            color: #ccc;
            font-size: 0.7rem;
            letter-spacing: 0.3em;
            text-align: center;
            padding: 6px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 6px;
        }

        .board,
        .board-frame,
        .board-row {
            border-radius: 0 !important;
        }

        .board-row span:nth-child(1) {
            color: #7dd3fc;
            /* 空色 */
            font-weight: bold;
        }

        .board-row span:nth-child(2),
        .board-row span:nth-child(3) {
            color: #e5e7eb;
        }

        .board-row span:nth-child(4) {
            color: #facc15;
            /* 黄 */
            font-weight: bold;
            font-size: 1.1rem;
        }

        .board-row:not(.header):hover {
            background: rgba(56, 189, 248, 0.05);
        }

        /* ========== Full-Screen Booking ========== */
        .booking-fullscreen {
            position: fixed;
            inset: 0;
            z-index: 3000;
            background: linear-gradient(180deg, #001d3d 0%, #003566 40%, #f8f9fa 40.1%);
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.35s ease;
        }

        .booking-fullscreen.active {
            display: flex;
            opacity: 1;
        }

        .booking-header {
            background: linear-gradient(135deg, #001d3d 0%, #003566 100%);
            color: white;
            padding: 20px 20px 30px;
            position: relative;
            flex-shrink: 0;
        }

        .booking-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .booking-back-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            transition: background 0.2s;
        }

        .booking-back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .booking-header-title {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .booking-close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 4px;
        }

        /* Step indicator */
        .booking-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
        }

        .booking-step-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
        }

        .booking-step-dot.active {
            background: white;
            color: #003566;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        .booking-step-dot.done {
            background: #38bdf8;
            color: white;
        }

        .booking-step-line {
            width: 60px;
            height: 2px;
            background: rgba(255, 255, 255, 0.15);
            transition: background 0.3s;
        }

        .booking-step-line.done {
            background: #38bdf8;
        }

        .booking-step-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 0 15px;
        }

        .booking-step-label {
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.4);
            text-align: center;
            width: 80px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: color 0.3s;
        }

        .booking-step-label.active {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Body area */
        .booking-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px 20px 120px;
            background: #f8f9fa;
        }

        .booking-form-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }

        .booking-form-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1a1a2e;
            text-align: center;
            margin-bottom: 24px;
        }

        .booking-field {
            margin-bottom: 16px;
        }

        .booking-field-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: #003566;
            letter-spacing: 1px;
            margin-bottom: 6px;
            display: block;
        }

        .booking-field select,
        .booking-field input {
            width: 100%;
            padding: 14px 12px;
            font-size: 1rem;
            border: 2px solid #e8ecf1;
            border-radius: 10px;
            background: #f8f9fa;
            font-weight: 600;
            color: #1a1a2e;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .booking-field select:focus,
        .booking-field input:focus {
            outline: none;
            border-color: #003566;
            box-shadow: 0 0 0 3px rgba(0, 53, 102, 0.1);
            background: white;
        }

        .booking-divider-icon {
            text-align: center;
            color: #003566;
            font-size: 1.2rem;
            padding: 4px 0;
            opacity: 0.5;
        }

        /* Footer */
        .booking-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            background: white;
            border-top: 1px solid #e8ecf1;
            display: flex;
            gap: 10px;
            z-index: 3001;
            max-width: 100%;
        }

        .booking-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .booking-btn:active {
            transform: scale(0.97);
        }

        .booking-btn-back {
            background: #e8ecf1;
            color: #333;
            flex: 0.35;
        }

        .booking-btn-next {
            background: linear-gradient(135deg, #003566 0%, #0055a4 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 53, 102, 0.3);
        }

        .booking-btn-confirm {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        /* Seat selector in booking */
        .booking-seat-picker {
            border: 2px dashed #d1d5db;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            transition: border-color 0.2s, background 0.2s;
        }

        .booking-seat-picker:hover {
            border-color: #003566;
            background: #eef4fb;
        }

        .booking-seat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: #003566;
            font-family: 'Inter', monospace;
            margin: 8px 0;
        }

        .booking-seat-cta {
            display: inline-block;
            background: linear-gradient(135deg, #003566 0%, #0055a4 100%);
            color: white;
            padding: 6px 18px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* ========== Settings Screen ========== */
        .settings-screen {
            background: #f0f2f5;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .settings-screen.active {
            display: flex;
            opacity: 1;
        }

        .settings-tabs {
            display: flex;
            background: white;
            padding: 0 10px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
            white-space: nowrap;
        }

        .settings-tab {
            padding: 15px 20px;
            font-size: 0.85rem;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .settings-tab.active {
            color: var(--ana-blue-main);
            border-bottom-color: var(--ana-blue-main);
        }

        .settings-section {
            padding: 20px;
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }

        .settings-desc {
            font-size: 0.75rem;
            color: #888;
            margin-top: 2px;
        }

        .status-card-preview {
            background: linear-gradient(135deg, #002d5a 0%, #0055a4 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .status-card-preview::after {
            content: 'BRONZE';
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 4rem;
            font-weight: 900;
            opacity: 0.1;
            font-style: italic;
        }

        .danger-zone {
            border: 1px solid #fee2e2;
            background: #fffafa;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--ana-blue-main);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        /* ========== Departure Board (FIDS) Screen - Image Based Redesign ========== */
        .board-frame {
            background: #000;
            min-height: calc(100vh - 120px);
            padding: 0;
            display: flex;
            flex-direction: column;
            font-family: 'Inter', sans-serif;
            color: #fff;
        }

        .fids-main-container {
            display: flex;
            width: 100%;
            height: 100%;
            flex: 1;
        }

        .fids-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #333;
        }

        .board-header-fids {
            background: #0044cc;
            /* Rich Blue from image */
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .board-title-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .board-title-group .material-icons {
            font-size: 2rem;
            transform: rotate(45deg);
        }

        .board-title-fids {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .board-table-header {
            display: grid;
            grid-template-columns: 80px 1fr 120px 140px;
            padding: 8px 15px;
            background: #f0f0f0;
            color: #333;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            border-bottom: 1px solid #ccc;
        }

        .board-row-fids {
            display: grid;
            grid-template-columns: 80px 1fr 120px 140px;
            padding: 12px 15px;
            align-items: center;
            border-bottom: 1px solid #222;
            background: #050505;
            min-height: 50px;
        }

        .fids-time {
            color: #fff;
            font-size: 1.1rem;
            font-weight: 800;
            font-family: 'inter', sans-serif;
        }

        .fids-time.expected {
            color: #ff3300;
            /* Red for expected time if different */
        }

        .fids-destination {
            font-size: 1.2rem;
            font-weight: 800;
            color: #fff;
        }

        .fids-flight-info {
            font-size: 0.8rem;
            font-weight: 700;
            color: #ccc;
        }

        .fids-gate {
            font-size: 1.1rem;
            font-weight: 900;
            color: #fff;
            text-align: center;
        }

        /* Status Badges */
        .fids-remarks {
            display: flex;
            justify-content: flex-end;
        }

        .fids-badge {
            padding: 4px 10px;
            border-radius: 2px;
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            min-width: 100px;
            text-align: center;
        }

        .badge-go-to-gate {
            background: #00cc66;
            color: #fff;
        }

        .badge-last-call {
            background: #cc3300;
            color: #fff;
        }

        .badge-late {
            background: #ff9900;
            color: #000;
        }

        .badge-boarding {
            background: #00cc66;
            color: #fff;
        }

        .badge-scheduled {
            background: none;
            color: #aaa;
            border: 1px solid #444;
        }

        .badge-closed {
            background: #333;
            color: #888;
        }

        .badge-arrived {
            background: #0044cc;
            color: #fff;
        }

        /* Sidebar - Walking Time */
        .fids-sidebar {
            width: 120px;
            background: #0044cc;
            display: flex;
            flex-direction: column;
            border-left: 2px solid #0033aa;
        }

        .sidebar-header {
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #0033aa;
            font-size: 0.7rem;
            font-weight: 800;
        }

        .walking-list {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .walking-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: #fff;
            color: #0044cc;
        }

        .walking-gate-letter {
            font-size: 1.5rem;
            font-weight: 900;
        }

        .walking-minutes {
            font-size: 1.1rem;
            font-weight: 900;
            display: flex;
            align-items: baseline;
            gap: 2px;
        }

        .walking-minutes::after {
            content: 'min';
            font-size: 0.6rem;
            font-weight: 700;
        }

        @keyframes fids-flicker {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .blink {
            animation: fids-flicker 1.2s infinite;
        }

        /* --- Premium Class Themes --- */
        .card-inner.class-first {
            border: 2px solid #D4AF37;
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.95) 0%, rgba(60, 50, 30, 0.95) 100%);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }

        .card-inner.class-first::after {
            content: 'FIRST CLASS';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.6rem;
            color: #D4AF37;
            border: 1px solid #D4AF37;
            padding: 2px 5px;
            border-radius: 2px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .card-inner.class-business {
            border: 2px solid #0055a4;
            background: linear-gradient(135deg, rgba(0, 8, 20, 0.95) 0%, rgba(0, 45, 90, 0.95) 100%);
            box-shadow: 0 0 15px rgba(0, 85, 164, 0.3);
        }

        .card-inner.class-business::after {
            content: 'BUSINESS CLASS';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.6rem;
            color: #99ccff;
            border: 1px solid #99ccff;
            padding: 2px 5px;
            border-radius: 2px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* --- In-Flight Portal Styles --- */
        .portal-telemetry-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .portal-stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .portal-stat-label {
            font-size: 0.65rem;
            color: #aaa;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }

        .portal-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            font-family: 'Roboto Mono', monospace;
            color: #fff;
        }

        .portal-map-area {
            width: 100%;
            height: 200px;
            background: #001a35;
            border-radius: 12px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .portal-map-line {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%);
        }

        .portal-map-plane {
            position: absolute;
            top: 50%;
            left: 10%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 20px;
            transition: left 1s linear;
        }

        .weather-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: #fff;
            margin-top: 10px;
        }

        @keyframes fids-flicker {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="scanModal" class="modal"
        style="display:none; position:fixed; z-index:5000; left:0; top:0; width:100%; height:100%; background:#000; flex-direction:column; align-items:center; justify-content:center;">
        <div style="color:white; margin-bottom:20px; font-weight:bold;">QRコードをスキャン</div>
        <div
            style="position:relative; width:80%; max-width:300px; aspect-ratio:1/1; border:2px solid var(--ana-blue-sky); border-radius:4px; overflow:hidden;">
            <video id="video" style="width:100%; height:100%; object-fit:cover;"></video>
            <div
                style="position:absolute; top:10%; left:10%; right:10%; bottom:10%; border:1px dashed rgba(255,255,255,0.5);">
            </div>
        </div>
        <button onclick="stopScan()"
            style="margin-top:30px; padding:12px 40px; border-radius:2px; border:none; background:white; color:black; font-weight:bold;">キャンセル</button>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>
    <audio id="cabinNoise" loop src="https://www.soundjay.com/transportation/airplane-cabin-white-noise-01.mp3"></audio>

    <div id="focusModeScreen" class="focus-overlay-screen">

        <div class="focus-layout-outer">
            <div class="focus-layout-container">
                <div id="focusContent" class="focus-window-area"></div>

                <div id="focus-note-panel" class="info-glass-panel">
                    <div class="memo-header">
                        <span class="focus-text-bold">INFLIGHT MEMO</span>
                        <button id="close-memo-mobile" class="mobile-only-btn"
                            onclick="toggleMobileMemo()">Done</button>
                    </div>
                    <textarea id="focus-textarea-box" placeholder="機内でのひらめきをメモ..."></textarea>
                </div>
            </div>
        </div>

        <button id="open-memo-mobile" class="mobile-memo-trigger" onclick="toggleMobileMemo()">
            ✎ Memo
        </button>
    </div>


    <nav class="my-app-bottom-nav">
        <a class="my-app-nav-link my-app-nav-link-active" onclick="switchTab('upcoming', this)">
            <span class="material-icons my-app-nav-icon-text">format_list_bulleted</span>
            <span>予定</span>
        </a>

        <a class="my-app-nav-link" onclick="switchTab('departures', this)">
            <span class="material-icons my-app-nav-icon-text">flight_takeoff</span>
            <span>出発案内</span>
        </a>

        <a class="my-app-nav-link my-app-nav-link-center" onclick="openNewFlightModal()">
            <div class="my-app-plus-circle">+</div>
            <span>予約</span>
        </a>

        <a class="my-app-nav-link" onclick="switchTab('arrivals', this)">
            <span class="material-icons my-app-nav-icon-text">flight_land</span>
            <span>到着案内</span>
        </a>

        <a class="my-app-nav-link" onclick="switchTab('history', this)">
            <span class="material-icons my-app-nav-icon-text">history</span>
            <span>履歴</span>
        </a>
    </nav>


    <div id="focusOverlay" class="focus-overlay" onclick="closeAllPasses()"></div>
    <div id="qrModal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()" style="text-align: center;">
            <h3 style="color: var(--ana-blue-main);">SHARE FLIGHT</h3>
            <p style="font-size: 0.8rem; color: #666;">このQRコードをスキャンして共有</p>
            <div id="qrcode" style="display: flex; justify-content: center; margin: 20px 0;"></div>
            <button onclick="document.getElementById('qrModal').style.display='none'"
                style="width: 100%; padding: 10px; background: #eee; border: none; border-radius: 8px;">閉じる</button>
        </div>
    </div>
    <header>
        <div class="header-left">
            <div class="header-title">Flight Schedule <span id="statusLabel" class="status-badge-header"></span></div>
            <div class="mile-display">✈ <span id="totalMiles">0</span> MILES</div>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
            <span class="material-icons" onclick="startScan()"
                style="cursor:pointer; font-size:1.35rem; color:rgba(255,255,255,0.7);">qr_code_scanner</span>
            <span class="material-icons" onclick="openSettings()"
                style="cursor:pointer; font-size:1.35rem; color:rgba(255,255,255,0.7);">settings</span>
        </div>
        <div id="notifBanner" class="in-app-banner" onclick="hideBanner()">
            <span>✈</span> <span id="notifText">搭乗手続きが可能な便があります</span>
        </div>
    </header>
    <!-- Removed JAL button because we are changing the entire theme to JAL-like -->


    <div class="container" id="flightList"></div>



    <div id="newFlightModal" class="booking-fullscreen">
        <div class="booking-header">
            <div class="booking-header-top">
                <button class="booking-back-btn" id="booking-back-header" onclick="prevBookingStep()"
                    style="visibility:hidden;">←</button>
                <span class="booking-header-title" id="bookingTitle">FLIGHT RESERVATION</span>
                <button class="booking-close-btn" onclick="closeBookingScreen()">✕</button>
            </div>
            <div class="booking-steps">
                <div class="booking-step-dot active" id="bsd-1">1</div>
                <div class="booking-step-line" id="bsl-1"></div>
                <div class="booking-step-dot" id="bsd-2">2</div>
                <div class="booking-step-line" id="bsl-2"></div>
                <div class="booking-step-dot" id="bsd-3">3</div>
            </div>
            <div class="booking-step-labels">
                <span class="booking-step-label active" id="bslbl-1">ROUTE</span>
                <span class="booking-step-label" id="bslbl-2">SCHEDULE</span>
                <span class="booking-step-label" id="bslbl-3">SEAT</span>
            </div>
        </div>

        <div class="booking-body">
            <!-- Step 1: Route -->
            <div id="booking-step-1" class="booking-step-container">
                <div class="booking-form-card">
                    <div class="booking-form-title">ご希望の区間を選択してください</div>
                    <div class="booking-field">
                        <label class="booking-field-label">FROM（出発地）</label>
                        <select id="fromSelect"></select>
                    </div>
                    <div class="booking-divider-icon">✈</div>
                    <div class="booking-field">
                        <label class="booking-field-label">TO（到着地）</label>
                        <select id="toSelect"></select>
                    </div>
                </div>
            </div>

            <!-- Step 2: Schedule -->
            <div id="booking-step-2" class="booking-step-container" style="display:none;">
                <div class="booking-form-card">
                    <div class="booking-form-title">日時を選択してください</div>
                    <div class="booking-field">
                        <label class="booking-field-label">DATE</label>
                        <input type="date" id="flightDate">
                    </div>
                    <div style="display:flex; gap:12px;">
                        <div class="booking-field" style="flex:1;">
                            <label class="booking-field-label">DEPARTURE TIME</label>
                            <input type="time" id="timeInput">
                        </div>
                        <div class="booking-field" style="flex:1;">
                            <label class="booking-field-label">DURATION (MIN)</label>
                            <input type="number" id="durationInput" value="60">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Seat & Class -->
            <div id="booking-step-3" class="booking-step-container" style="display:none;">
                <div class="booking-form-card">
                    <div class="booking-form-title">座席・クラス指定</div>
                    <div class="booking-field">
                        <label class="booking-field-label">CLASS</label>
                        <select id="classSelect">
                            <option value="ECONOMY">普通席 (Economy)</option>
                            <option value="BUSINESS" id="optPremium" disabled>ビジネスクラス (Sapphire以上)</option>
                            <option value="FIRST" id="optFirst" disabled>ファーストクラス (Diamond限定)</option>
                        </select>
                    </div>
                    <div class="booking-seat-picker" onclick="openSeatMap()">
                        <div style="font-size:0.75rem; color:#888; font-weight:700;">SEAT SELECTION</div>
                        <div class="booking-seat-value" id="seatLabel">未指定</div>
                        <div class="booking-seat-cta">シートマップを開く</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="booking-footer">
            <button id="btn-back" class="booking-btn booking-btn-back" onclick="prevBookingStep()"
                style="display:none;">戻る</button>
            <button id="btn-next" class="booking-btn booking-btn-next" onclick="nextBookingStep()">次へ →</button>
            <button id="btn-confirm" class="booking-btn booking-btn-confirm" onclick="saveFlight()"
                style="display:none;">予約を確定する ✈</button>
        </div>
    </div>

    <div id="settingsModal" class="booking-fullscreen settings-screen">
        <div class="booking-header">
            <div class="booking-header-top">
                <div style="width:36px;"></div>
                <span class="booking-header-title">SETTINGS</span>
                <button class="booking-close-btn" onclick="closeSettings()">✕</button>
            </div>
            <div class="settings-tabs">
                <div class="settings-tab active" onclick="switchSettingsTab('general')">一般</div>
                <div class="settings-tab" onclick="switchSettingsTab('airports')">マイ空港</div>
                <div class="settings-tab" onclick="switchSettingsTab('data')">データ</div>
            </div>
        </div>

        <div class="booking-body">
            <!-- General Section -->
            <div id="settings-general" class="settings-section active">
                <div class="status-card-preview">
                    <div style="font-size:0.7rem; opacity:0.8; letter-spacing:1px;">MY STATUS</div>
                    <div style="font-size:1.4rem; font-weight:bold; margin:5px 0;" id="settings-user-name">Guest USER
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:15px;">
                        <div>
                            <div style="font-size:0.6rem; opacity:0.8;">TOTAL MILES</div>
                            <div style="font-size:1.1rem; font-weight:bold;"><span id="settings-miles">0</span>
                                <small>LT MILES</small>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.6rem; opacity:0.8;">MEMBER SINCE</div>
                            <div style="font-size:0.8rem; font-weight:bold;">2024.01</div>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">ユーザー名</div>
                            <div class="settings-desc">アプリ内での表示名を変更します</div>
                        </div>
                        <input type="text" id="userNameInput" placeholder="お名前"
                            style="width:120px; padding:8px; border:1px solid #ddd; border-radius:4px;"
                            onchange="saveUserName()">
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">効果音</div>
                            <div class="settings-desc">チェックインや操作時のサウンド</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundToggle" checked onchange="saveAppPreferences()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">通知許可</div>
                            <div class="settings-desc">通知を許可します</div>
                        </div>
                        <button class="booking-btn" style="flex:0; padding:8px 15px; font-size:0.75rem;"
                            onclick="enableNotifications()">許可</button>
                    </div>
                </div>
            </div>

            <!-- Airports Section -->
            <div id="settings-airports" class="settings-section">
                <div class="settings-card">
                    <div style="margin-bottom:15px;">
                        <div class="settings-label">マイ空港(やること)の追加</div>
                        <div class="settings-desc">よく使う目的地やタスクをプレセットとして登録</div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" id="newAirportCode" placeholder="3レター" maxlength="3"
                            style="flex:1; text-transform:uppercase;">
                        <input type="text" id="newAirportName" placeholder="名称" style="flex:2;">
                    </div>
                    <button class="booking-btn booking-btn-next" style="padding:10px; font-size:0.8rem;"
                        onclick="addAirport()">登録する</button>
                </div>
                <div class="settings-card" style="padding:0;">
                    <ul class="airport-list" id="airportListUi" style="margin:0;"></ul>
                </div>
            </div>

            <!-- Data Section -->
            <div id="settings-data" class="settings-section">
                <div class="settings-card">
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">バックアップ</div>
                            <div class="settings-desc">全フライトデータをJSONファイルで保存</div>
                        </div>
                        <button class="booking-btn" style="flex:0; padding:8px 15px; font-size:0.75rem;"
                            onclick="exportData()">保存</button>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">データ復元</div>
                            <div class="settings-desc">JSONファイルからデータを読み込み</div>
                        </div>
                        <button class="booking-btn" style="flex:0; padding:8px 15px; font-size:0.75rem;"
                            onclick="importData()">読み込み</button>
                    </div>
                </div>

                <div class="settings-card danger-zone">
                    <div class="settings-item">
                        <div>
                            <div class="settings-label" style="color:#ef4444;">データの初期化</div>
                            <div class="settings-desc">すべての履歴、マイ空港、設定を削除します</div>
                        </div>
                        <button class="btn-danger" onclick="resetAllData()">すべて削除</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="seatModal" class="modal" style="z-index:4000;">
        <div class="modal-content" style="height:90vh;">
            <div class="modal-header-ana"><strong>座席指定</strong><span onclick="confirmSeat()"
                    style="cursor:pointer">決定</span></div>
            <div class="modal-body" style="background: #dce1e6;">
                <div class="plane-wrapper" id="planeWrapper">
                    <div class="wing-left"></div>
                    <div class="wing-right"></div>
                    <div class="fuselage">
                        <div class="cockpit"></div>
                    </div>
                    <div class="seat-map-container" id="seatGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" style="
  position: fixed;
  top: -100px;
  left: 50%;
  transform: translateX(-50%);
  background: #002D5A;
  color: white;
  padding: 14px 20px;
  border-radius: 4px;
  font-weight: bold;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  transition: top 0.4s ease;
  z-index: 2000;
"></div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }
        const defaultAirports = [{ code: 'HME', name: '自宅' }, { code: 'WRK', name: '仕事' }, { code: 'CFE', name: 'カフェ' }];
        let airports = JSON.parse(localStorage.getItem('my_airports') || JSON.stringify(defaultAirports));
        let flights = JSON.parse(localStorage.getItem('ana_flights_final') || '[]');

        function isCheckInOpen(f) {
            if (!f) return false;
            const now = new Date();
            const [y, m, d] = (f.date || new Date().toISOString().split('T')[0]).split('-').map(Number);
            const [hh, mm] = (f.time || '00:00').split(':').map(Number);
            if (!y) return false;
            const dep = new Date(y, m - 1, d, hh, mm);
            return now >= new Date(dep.getTime() - 10 * 60000);
        }

        // --- Settings Screen Logic (Moved to Top) ---
        function openSettings() {
            try {
                const screen = document.getElementById('settingsModal');
                if (!screen) {
                    console.error('settingsModal not found');
                    return;
                }

                // Load current values safely
                const name = localStorage.getItem('ana_user_name') || 'Guest USER';
                const nameInput = document.getElementById('userNameInput');
                const nameDisplay = document.getElementById('settings-user-name');
                const milesDisplay = document.getElementById('settings-miles');
                const totalMiles = document.getElementById('totalMiles');

                if (nameInput) nameInput.value = name;
                if (nameDisplay) nameDisplay.innerText = name;
                if (milesDisplay && totalMiles) milesDisplay.innerText = totalMiles.innerText;

                const soundOn = localStorage.getItem('ana_sound_enabled') !== 'false';
                const soundToggle = document.getElementById('soundToggle');
                if (soundToggle) soundToggle.checked = soundOn;

                updateAirportList();

                screen.style.display = 'flex';
                requestAnimationFrame(() => {
                    screen.classList.add('active');
                });
                const nav = document.querySelector('.my-app-bottom-nav');
                if (nav) nav.style.display = 'none';
            } catch (e) {
                console.error('Error in openSettings:', e);
            }
        }

        function closeSettings() {
            const screen = document.getElementById('settingsModal');
            if (screen) {
                screen.classList.remove('active');
                setTimeout(() => {
                    screen.style.display = 'none';
                }, 300);
            }
            const nav = document.querySelector('.my-app-bottom-nav');
            if (nav) nav.style.display = 'flex';
        }

        function switchSettingsTab(tabId) {
            // Update tabs
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            const target = event ? event.currentTarget : null;
            if (target) {
                target.classList.add('active');
            } else {
                // Fallback for direct calls
                document.querySelectorAll('.settings-tab').forEach(t => {
                    if (t.innerText.includes(tabId === 'general' ? '一般' : (tabId === 'airports' ? '空港' : 'データ'))) {
                        t.classList.add('active');
                    }
                });
            }

            // Update sections
            const sections = ['general', 'airports', 'data'];
            sections.forEach(s => {
                const el = document.getElementById(`settings-${s}`);
                if (el) el.classList.remove('active');
            });

            const targetSection = document.getElementById(`settings-${tabId}`);
            if (targetSection) targetSection.classList.add('active');
        }

        function updateAirportList() {
            const listUi = document.getElementById('airportListUi');
            if (!listUi) return;
            listUi.innerHTML = airports.map((a, i) => `
                <li class="airport-item" style="padding: 10px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-weight:bold; color:var(--ana-blue-main); margin-right:8px;">${a.code}</span>
                        <span style="font-size:0.9rem; color:#555;">${a.name}</span>
                    </div>
                    <button onclick="removeAirport(${i})" style="background:none; border:none; color:#ccc; cursor:pointer; font-size:1.1rem;">×</button>
                </li>
            `).join('');
        }

        function addAirport() {
            const codeEl = document.getElementById('newAirportCode');
            const nameEl = document.getElementById('newAirportName');
            const code = codeEl ? codeEl.value.toUpperCase() : '';
            const name = nameEl ? nameEl.value : '';
            if (code.length === 3 && name) {
                airports.push({ code, name });
                localStorage.setItem('my_airports', JSON.stringify(airports));
                if (codeEl) codeEl.value = '';
                if (nameEl) nameEl.value = '';
                updateAirportList();
                if (typeof showToast === 'function') showToast(`登録しました: ${code}`);
            } else {
                alert('3文字のコードと名称を入力してください');
            }
        }

        function removeAirport(index) {
            if (confirm('このマイ空港を削除しますか？')) {
                airports.splice(index, 1);
                localStorage.setItem('my_airports', JSON.stringify(airports));
                updateAirportList();
            }
        }

        function saveUserName() {
            const name = document.getElementById('userNameInput').value || 'Guest USER';
            localStorage.setItem('ana_user_name', name);
            const display = document.getElementById('settings-user-name');
            if (display) display.innerText = name;
        }

        function saveAppPreferences() {
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) {
                const soundOn = soundToggle.checked;
                localStorage.setItem('ana_sound_enabled', soundOn);
            }
        }

        function exportData() {
            const data = {
                flights: flights,
                airports: airports,
                userName: localStorage.getItem('ana_user_name'),
                soundEnabled: localStorage.getItem('ana_sound_enabled')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ana_flight_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.flights) {
                            flights = data.flights;
                            localStorage.setItem('ana_flights_final', JSON.stringify(flights));
                        }
                        if (data.airports) {
                            airports = data.airports;
                            localStorage.setItem('my_airports', JSON.stringify(airports));
                        }
                        if (data.userName) localStorage.setItem('ana_user_name', data.userName);
                        if (data.soundEnabled) localStorage.setItem('ana_sound_enabled', data.soundEnabled);

                        alert('データを復元しました。再読み込みします。');
                        location.reload();
                    } catch (err) {
                        alert('ファイル形式が正しくありません');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetAllData() {
            if (confirm('すべての情報を初期化しますか？この操作は取り消せません。')) {
                localStorage.clear();
                alert('初期化しました');
                location.reload();
            }
        }
        let tempSeat = null;
        let notifiedFlights = new Set();
        let bannerShownFor = new Set();
        let boardMode = false;
        let fidsType = 'DEPARTURES';
        let externalFlights = [];
        let externalArrivals = [];
        const EXTERNAL_FLIGHT_TARGET = 12;
        let currentTab = 'upcoming';

        let isDragging = false;
        let startX = 0;
        let currentX = 0;

        function getGateForFlight(flightNumber) {
            let hash = 0;
            for (let i = 0; i < flightNumber.length; i++) {
                hash = ((hash << 5) - hash) + flightNumber.charCodeAt(i);
                hash |= 0;
            }
            return (Math.abs(hash) % 45) + 1;
        }

        const externalFlightsPool = [
            { airline: 'JAM', code: 'JM', from: 'HND', to: 'ITM', name: '羽田 → 伊丹' },
            { airline: 'ANB', code: 'NB', from: 'HND', to: 'CTS', name: '羽田 → 札幌' },
            { airline: 'SKZ', code: 'SZ', from: 'HND', to: 'FUK', name: '羽田 → 福岡' },
            { airline: 'S-FIER', code: 'SF', from: 'HND', to: 'KKJ', name: '羽田 → 北九州' },
            { airline: 'Peaci', code: 'PC', from: 'KIX', to: 'CTS', name: '関空 → 札幌' },
            { airline: 'Jetstas', code: 'JS', from: 'NRT', to: 'FUK', name: '成田 → 福岡' },
            { airline: 'F-DASH', code: 'FD', from: 'HND', to: 'AOI', name: '羽田 → 青森' },
            { airline: 'A-DOJO', code: 'AD', from: 'HND', to: 'HKD', name: '羽田 → 函館' },
            { airline: 'SOLA', code: 'SN', from: 'HND', to: 'KOJ', name: '羽田 → 鹿児島' },
            { airline: 'IBI-X', code: 'IB', from: 'ITM', to: 'SDJ', name: '伊丹 → 仙台' },
            { airline: 'O-ROCK', code: 'OR', from: 'NGS', to: 'FUJ', name: '長崎 → 五島福江' },
            { airline: 'AM-AX', code: 'AM', from: 'AXT', to: 'FUK', name: '天草 → 福岡' },
            { airline: 'J-ACE', code: 'JA', from: 'KOJ', to: 'TNM', name: '鹿児島 → 種子島' },
            { airline: 'R-ACE', code: 'RA', from: 'OKA', to: 'ISG', name: '那覇 → 石垣' }
        ];
        const airportNameMap = {
            HND: '羽田',
            NRT: '成田',
            NGO: '中部',
            NKM: '小牧',
            ITM: '伊丹',
            KIX: '関西',
            CTS: '新千歳',
            FUK: '福岡',
            OKA: '那覇',
        }

        // --- Status & Mile Logic ---
        function getStatusInfo() {
            const total = flights.reduce((acc, f) => getStatus(f) === 'ARRIVED' ? acc + (f.duration || 0) : acc, 0);
            let status = 'BRONZE';
            if (total >= 3000) status = 'DIAMOND';
            else if (total >= 1000) status = 'SAPPHIRE';
            return { total, status };
        }

        function updateHeader() {
            const info = getStatusInfo();
            document.getElementById('totalMiles').innerText = info.total.toLocaleString();
            const label = document.getElementById('statusLabel');
            label.innerText = info.status;
            label.className = 'status-badge-header st-' + info.status;
            document.getElementById('optPremium').disabled = info.total < 1000;
            document.getElementById('optFirst').disabled = info.total < 3000;
        }

        function getStatus(f) {
            if (!f) return 'RESERVED';
            const now = new Date();
            const dateStr = f.date || new Date().toISOString().split('T')[0];
            const timeStr = f.time || '00:00';

            const [y, m, d] = dateStr.split('-').map(Number);
            const [hh, mm] = timeStr.split(':').map(Number);

            const dep = new Date(y, m - 1, d, hh, mm);
            const duration = Number(f.duration) || 60;
            const arr = new Date(dep.getTime() + duration * 60000);

            if (now > arr) return 'ARRIVED';
            if (now > dep && !f.checkedIn) return 'NOSHOW';
            if (now > dep && f.checkedIn) return 'INFLIGHT';
            return f.checkedIn ? 'CHECKEDIN' : 'RESERVED';
        }



        function getNowMinutes() {
            const now = new Date();
            return now.getHours() * 60 + now.getMinutes();
        }

        function getWeatherForAirport(icao) {
            if (!icao) return null;
            // Simple deterministic mock weather based on hash of ICAO
            let hash = 0;
            for (let i = 0; i < icao.length; i++) hash += icao.charCodeAt(i);
            const weathers = ['☀️ Clear', '🌤 Partly Cloudy', '☁️ Cloudy', '🌧 Rainy', '⛈ Thunderstorm', '❄️ Snowy'];
            const weather = weathers[hash % weathers.length];
            const temp = 5 + (hash % 25);
            return { weather, temp };
        }

        // --- Tab Switching ---
        function switchTab(tab, el) {
            // Reset state
            boardMode = false;

            if (tab === 'departures') {
                boardMode = true;
                fidsType = 'DEPARTURES';
            } else if (tab === 'arrivals') {
                boardMode = true;
                fidsType = 'ARRIVALS';
            } else {
                currentTab = tab; // 'upcoming' or 'history'
            }

            // すべてのボタンからアクティブ色を外す
            document.querySelectorAll('.my-app-nav-link').forEach(n => {
                n.classList.remove('my-app-nav-link-active');
            });

            // クリックされたボタンだけに色をつける
            if (el) {
                el.classList.add('my-app-nav-link-active');
            }

            // リストを再描画
            render();
        }

        // --- Swipe UI Logic ---
        function getCheckInUI(f, canCheckIn) {
            if (!canCheckIn) {
                return `<div class="swipe-container" style="opacity:0.5; background:#ccc; color:#666">出発10分前から受付開始</div>`;
            }
            return `
            <div class="swipe-container" id="swipeContainer-${f.id}">
                <div class="swipe-handle" 
                     onmousedown="handleSwipeStart(event, ${f.id})"
                     ontouchstart="handleSwipeStart(event, ${f.id})">✈</div>
                スワイプしてチェックイン
            </div>
        `;
        }

        function handleSwipeStart(e, id) {
            unlockAudio();
            startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            isDragging = true;
            const handle = e.target;
            handle.style.transition = 'none';

            const moveHandler = (ev) => handleSwipeMove(ev, id);
            const endHandler = () => {
                handleSwipeEnd(id);
                window.removeEventListener('mousemove', moveHandler);
                window.removeEventListener('touchmove', moveHandler);
                window.removeEventListener('mouseup', endHandler);
                window.removeEventListener('touchend', endHandler);
            };

            window.addEventListener('mousemove', moveHandler);
            window.addEventListener('touchmove', moveHandler, { passive: false });
            window.addEventListener('mouseup', endHandler);
            window.addEventListener('touchend', endHandler);
        }

        function handleSwipeMove(e, id) {
            if (!isDragging) return;
            if (e.cancelable) e.preventDefault();
            const container = document.getElementById(`swipeContainer-${id}`);
            const handle = container.querySelector('.swipe-handle');
            const maxMove = container.offsetWidth - handle.offsetWidth;
            const x = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            currentX = x - startX;
            if (currentX < 0) currentX = 0;
            if (currentX > maxMove) currentX = maxMove;
            handle.style.transform = `translateX(${currentX}px)`;
            container.style.background = `rgba(0, 68, 130, ${0.1 + (currentX / maxMove) * 0.2})`;
        }

        function handleSwipeEnd(id) {
            if (!isDragging) return;
            isDragging = false;
            const container = document.getElementById(`swipeContainer-${id}`);
            const handle = container.querySelector('.swipe-handle');
            const maxMove = container.offsetWidth - handle.offsetWidth;
            if (currentX >= maxMove * 0.9) {
                handle.style.transition = 'transform 0.2s';
                handle.style.transform = `translateX(${maxMove}px)`;
                setTimeout(() => {
                    playCheckInFeedback();
                    playCheckInBeep();
                    doCheckIn(id);
                }, 200);
            } else {
                handle.style.transition = 'transform 0.3s ease';
                handle.style.transform = 'translateX(0)';
                container.style.background = '#eee';
            }
            currentX = 0;
        }

        // --- Render ---
        function render() {
            try {
                updateHeader();
                cleanupFinishedFlights();

                if (boardMode) {
                    renderFidsBoard();
                    return;
                }

                const list = document.getElementById('flightList');
                list.className = 'container';

                const displayFlights = flights.filter(f => {
                    const status = getStatus(f);
                    const isHistory = (status === 'ARRIVED' || status === 'NOSHOW');
                    return currentTab === 'upcoming' ? !isHistory : isHistory;
                });

                let summaryHtml = '';
                if (currentTab === 'history' && displayFlights.length > 0) {
                    const totalFlights = displayFlights.length;
                    const arrivedCount = displayFlights.filter(f => getStatus(f) === 'ARRIVED').length;
                    const totalMinutes = displayFlights
                        .filter(f => getStatus(f) === 'ARRIVED')
                        .reduce((sum, f) => sum + Number(f.duration), 0);

                    const days = Math.floor(totalMinutes / 1440);
                    const hours = Math.floor((totalMinutes % 1440) / 60);
                    const mins = totalMinutes % 60;

                    let timeStr = "";
                    if (days > 0) timeStr += `${days}d `;
                    timeStr += `${hours}h ${mins}m`;

                    let rankTitle = "BEGINNER";
                    let rankColor = "#fff";
                    if (totalMinutes >= 6000) { rankTitle = "SKY LEGEND"; rankColor = "var(--gold)"; }
                    else if (totalMinutes >= 1440) { rankTitle = "CLOUD DWELLER"; rankColor = "#e5e4e2"; }
                    else if (totalMinutes >= 600) { rankTitle = "SKY RUNNER"; rankColor = "#87ceeb"; }

                    summaryHtml = `
            <div style="background: var(--ana-gradient); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,68,130,0.2); position: relative; overflow: hidden;">
                <div style="position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.1; transform: rotate(-20deg);">✈</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <div style="font-size: 0.75rem; opacity: 0.8; letter-spacing: 1.5px;">TOTAL AIR TIME</div>
                    <div style="font-size: 0.7rem; font-weight: bold; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; color: ${rankColor}; border: 1px solid ${rankColor}55;">${rankTitle}</div>
                </div>
                <div style="font-size: 2.2rem; font-weight: bold; font-family: sans-serif; margin-bottom: 15px;">${timeStr}</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
                    <div><div style="font-size: 0.7rem; opacity: 0.8;">搭乗回数</div><div style="font-size: 1.1rem; font-weight: bold;">${totalFlights} <span style="font-size: 0.7rem;">回</span></div></div>
                    <div style="text-align: center;"><div style="font-size: 0.7rem; opacity: 0.8;">定時搭乗率</div><div style="font-size: 1.1rem; font-weight: bold;">${Math.round((arrivedCount / totalFlights) * 100)}%</div></div>
                    <div style="text-align: right;"><div style="font-size: 0.7rem; opacity: 0.8;">累計マイル</div><div style="font-size: 1.1rem; font-weight: bold; color: var(--gold);">${totalMinutes.toLocaleString()}</div></div>
                </div>
            </div>`;
                }

                if (displayFlights.length === 0) {
                    list.innerHTML = summaryHtml + `<div style="text-align:center; color:#999; padding-top:100px">${currentTab === 'upcoming' ? 'これからの予定はありません' : '搭乗履歴はありません'}</div>`;
                    return;
                }

                // 3. 並び替え
                displayFlights.sort((a, b) => {
                    // 日付と時刻を結合して正確な比較用オブジェクトを作る
                    const dateTimeA = new Date(`${a.date}T${a.time}`).getTime();
                    const dateTimeB = new Date(`${b.date}T${b.time}`).getTime();

                    if (currentTab === 'upcoming') {
                        // 【Upcoming】出発が近いもの（時刻が早い順）を上に
                        return dateTimeA - dateTimeB;
                    } else {
                        // 【History】最近乗ったもの（時刻が遅い順）を上に
                        return dateTimeB - dateTimeA;
                    }
                });



                // 4. 描画
                // 4. 描画
                list.innerHTML = summaryHtml + displayFlights.map(f => {
                    const status = getStatus(f);
                    const canCheckIn = isCheckInOpen(f);
                    const isHistory = (status === 'ARRIVED' || status === 'NOSHOW');

                    const dateObj = new Date(f.date || new Date());
                    const dateStr = dateObj.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', weekday: 'short' });
                    const [h, m] = f.time.split(':').map(Number);
                    const depDate = new Date(dateObj); depDate.setHours(h, m, 0, 0);
                    const arrDate = new Date(depDate.getTime() + f.duration * 60000);
                    const arrTimeStr = arrDate.getHours().toString().padStart(2, '0') + ':' + arrDate.getMinutes().toString().padStart(2, '0');
                    const bgClass = getBgClass(f.time);
                    const skyClass = bgClass.replace('bg-', 'sky-');

                    // --- カウントダウンの計算 ---
                    let countdownHtml = '';
                    if (status === 'RESERVED' || status === 'CHECKEDIN') {
                        const now = new Date();
                        const diffMs = depDate - now; // 出発までのミリ秒

                        if (diffMs > 0) {
                            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                            let countdownText = diffHrs > 0 ? `${diffHrs}h${diffMins}m` : `${diffMins}m`;

                            countdownHtml = `
                    <div style="background: rgba(255,255,255,0.15); border-radius: 6px; padding: 4px 10px; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">DEPARTURE IN</span>
                        <span style="font-size: 0.9rem; font-weight: bold; color: var(--diamond);">${countdownText}</span>
                    </div>
                `;
                        }
                    }

                    let inflightExtra = "";
                    if (status === 'INFLIGHT') {
                        inflightExtra = `
                <div class="airplane-window">
                    <div class="sky-view ${skyClass}">
                        <div class="cloud-particle" style="width:50px; height:20px; top:20%;"></div>
                        <div class="cloud-particle" style="width:70px; height:25px; top:50%; animation-delay:-5s;"></div>
                        <div class="cloud-particle" style="width:40px; height:15px; top:75%; animation-delay:-10s;"></div>
                    </div>
                </div>
                <div style="text-align:center; font-size:0.6rem; color:rgba(255,255,255,0.7); margin-bottom:10px;">
                    Cruising at 35,000ft
                </div>`;
                    }

                    const priorityGroup = (f.boardingClass === 'FIRST') ? 1 : (f.boardingClass === 'BUSINESS') ? 2 : 3;
                    const gateLabel = f.from.charAt(0).toUpperCase() + (String(f.id).slice(-1));
                    const getWorkStyle = (seat) => {
                        if (!seat || seat === 'ANY') return 'Style: Undefined';
                        const letter = seat.slice(-1);
                        if (['A', 'K'].includes(letter)) return 'Deep（集中）';
                        if (['C', 'H'].includes(letter)) return 'Light（気軽）';
                        return 'Normal（標準）';
                    };

                    // --- 進捗バーの計算 ---
                    let progressHtml = '';
                    let telemetryHtml = '';
                    if (f.checkedIn && !isHistory) {
                        const now = new Date().getTime();
                        const totalDuration = f.duration * 60000;
                        const elapsed = now - depDate.getTime();
                        const percent = Math.min(Math.max((elapsed / totalDuration) * 100, 0), 100);

                        // --- 高度と速度のシミュレーションロジック ---
                        let altitude = 0;
                        let speed = 0;

                        // 景色の定義
                        let windowContent = '';
                        if (status === 'INFLIGHT') {

                            if (percent < 15) {
                                // 上昇中（最初の15%）
                                altitude = Math.floor((percent / 15) * 35000);
                                speed = Math.floor(150 + (percent / 15) * 350);
                            } else if (percent > 85) {
                                // 降下中（最後の15%）
                                altitude = Math.floor(((100 - percent) / 15) * 35000);
                                speed = Math.floor(150 + ((100 - percent) / 15) * 350);
                            } else {
                                // 巡航中
                                altitude = 35000 + Math.floor(Math.random() * 100); // 少し揺らぎを出す
                                speed = 500 + Math.floor(Math.random() * 10);
                            }

                            telemetryHtml = `
            <div style="display: flex; justify-content: space-around; width: 100%; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                <div style="text-align: center;">
                    <div style="font-size: 0.6rem; opacity: 0.7;">ALTITUDE</div>
                    <div style="font-size: 0.9rem; font-weight: bold; font-family: monospace;">${altitude.toLocaleString()} <span style="font-size: 0.6rem;">ft</span></div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 0.6rem; opacity: 0.7;">GROUND SPEED</div>
                    <div style="font-size: 0.9rem; font-weight: bold; font-family: monospace;">${speed} <span style="font-size: 0.6rem;">kts</span></div>
                </div>
            </div>
        `;


                            // 【飛行中】上空の景色
                            windowContent = `
                    <div class="sky-view ${skyClass}" style="width:100%; height:100%;">
                        <div class="cloud-particle" style="top:25%; width:30px; height:10px; left:10%;"></div>
                        <div class="cloud-particle" style="top:55%; width:40px; height:15px; left:40%; animation-delay:-5s;"></div>
                    </div>`;
                        } else {
                            // 【出発前】深みのある地上の景色
                            windowContent = `
                    <div style="width: 100%; height: 100%; background: linear-gradient(to bottom, 
                        #4a90e2 0%,      /* 空の高いところ */
                        #87ceeb 45%,     /* 地平線付近の明るい空 */
                        #cfe2f3 54%,     /* 地平線の霞み */
                        #7da438 56%,     /* 遠くの緑（少し薄い） */
                        #5a8226 100%     /* 手前の緑（濃い） */
                    );">
                        <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%); pointer-events:none;"></div>
                    </div>`;
                        }

                        // 演出：出発の瞬間（0%〜2.5%）はシェードを閉じる(0%)、それ以外は開ける(-100%)
                        const shadeTransform = (status === 'INFLIGHT' && percent < 2.5)
                            ? 'translateY(0%)'
                            : 'translateY(-100%)';

                        progressHtml = `
                <div class="flight-main-content" style="display: flex; flex-direction: column; align-items: center; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                    <div style="width: 100%; margin-top: 5px;">
                        <div class="progress-container" style="width:100%; height:4px; background: rgba(255,255,255,0.2); border-radius:2px; position:relative;">
                            <div class="progress-bar" style="width: ${percent}%; height:100%; background: white;"></div>
                            <div class="progress-plane" style="position:absolute; left: ${percent}%; top:-8px; transform:translateX(-50%); color: white; font-size:12px;">✈</div>
                        </div>
                    </div>
                    ${telemetryHtml}
                </div>`;
                    }

                    return `
    <div class="flight-card ${isHistory ? 'history' : ''} dynamic-bg ${bgClass}" data-id="${f.id}">
        ${status === 'NOSHOW' ? '<div class="noshow-overlay"><div class="noshow-stamp">NO SHOW</div></div>' : ''}
        ${status === 'ARRIVED' ? '<div class="noshow-overlay"><div class="noshow-stamp" style="border-color:var(--gold); color:var(--gold);">ARRIVED</div></div>' : ''}
        
        <div class="card-inner class-${(f.boardingClass || 'ECONOMY').toLowerCase()}">
            ${status === 'INFLIGHT' ? `<button onclick="togglePortal(${f.id})" style="margin-top: 10px; width: 100%; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem;">✨ 機内ポータルを起動</button>` : ''}
            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px;">
                <span style="font-size: 0.9rem;">📅</span> ${dateStr}
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span class="status-badge badge-${status.toLowerCase()}">${status}</span>
                <span style="font-size:0.8rem; color:rgba(255,255,255,0.5)">#${String(f.id).slice(-4)}</span>
            </div>
            <div class="route-row">
                <div class="city-box"><div class="city-code" style="color:white !important;">${f.from}</div><div class="city-name" style="color:rgba(255,255,255,0.8) !important;">${formatAirport(f.from, false)}</div></div>
                <div style="color:rgba(255,255,255,0.8)">✈</div>
                <div class="city-box"><div class="city-code" style="color:white !important;">${f.to}</div><div class="city-name" style="color:rgba(255,255,255,0.8) !important;">${formatAirport(f.to, false)}</div></div>
            </div>
            <div class="time-row" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);">
                <div class="time-box"><div class="time-label" style="color:rgba(255,255,255,0.7) !important;">DEP</div><div class="time-value" style="color:white !important; font-size:1.4rem;">${f.time}${countdownHtml}</div></div>
                <div class="duration-center" style="color:rgba(255,255,255,0.6)">⎯ ${f.duration}m ⎯</div>
                <div class="time-box"><div class="time-label" style="color:rgba(255,255,255,0.7) !important;">ARR</div><div class="time-value" style="color:white !important; font-size:1.4rem;">${arrTimeStr}</div></div>
            </div>

            ${progressHtml}

            ${isHistory ? `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.3);">
                    <div style="font-size:0.75rem; font-weight:bold; color:${status === 'ARRIVED' ? 'var(--gold)' : 'rgba(255,255,255,0.5)'}">
                        ${status === 'ARRIVED' ? `1. LOGGED: +${f.duration} MILES` : '0 MILES (NO SHOW)'}
                    </div>
                    <button onclick='repeatFlight(${JSON.stringify(f)})' style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; cursor: pointer;">再予約 ✈</button>
                </div>
                ${getFlightNotesHtml(f.id)}` : ''}

            ${(status === 'RESERVED' && currentTab === 'upcoming') ? getCheckInUI(f, canCheckIn) : ''}
            ${(status === 'CHECKEDIN' && currentTab === 'upcoming') ? `<div style="text-align:center; color:white; font-size:0.8rem; margin-top:10px; font-weight:bold;">✓ チェックイン済み</div>` : ''}
        </div>

        ${(f.checkedIn && !isHistory) ? `
            <button class="toggle-pass-btn" onclick="toggleBoardingPass(this)" style="background: rgba(255,255,255,0.15); border: 1px dashed rgba(255,255,255,0.5); color: white;">搭乗券を表示</button>
            <div class="boarding-pass-container">
                <div class="boarding-pass" style="padding:0; overflow:hidden; border-radius:15px; position:relative;">
                    <div style="background: var(--ana-blue-main); color: white; padding: 10px; text-align: center; font-size: 0.7rem; font-weight: bold; letter-spacing: 2px;">
                        THE AIRLINE BOARDING PASS
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">TASK LOCATION</div>
                                <div style="font-size: 1.25rem; font-weight: bold; color: var(--ana-blue-main); letter-spacing: 1px;">${f.from} → ${f.to}</div>
                                <div style="font-size: 0.73rem; color: #888; margin-top: -2px; font-weight: bold;">
                                    (${formatAirport(f.from, false)} → ${formatAirport(f.to, false)})
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">TASK CLASS</div>
                                <div style="font-size: 0.9rem; font-weight: bold;">${f.boardingClass || 'ECONOMY'}</div>
                            </div>
                        </div>

                        <div class="boarding-pass-inner" style="position: relative; background: white; padding: 20px 15px; border-radius: 12px; border: 1px dashed #ccc; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div id="qrcode-${f.id}" style="background: white; padding: 5px; display: flex; justify-content: center;"></div>
                            <div style="font-size: 0.6rem; color: #999; margin-top: 8px; letter-spacing: 1px;">SCAN TO SHARE</div>
                            
                            <div style="position: absolute; width: 20px; height: 20px; background: #eee; border-radius: 50%; top: 50%; left: -11px; transform: translateY(-50%); border: 1px dashed #ccc;"></div>
                            <div style="position: absolute; width: 20px; height: 20px; background: #eee; border-radius: 50%; top: 50%; right: -11px; transform: translateY(-50%); border: 1px dashed #ccc;"></div>
                        </div>
                        
                        <div style="text-align: center; padding: 20px 0 10px 0;">
                            <div style="font-size: 0.65rem; color: #888; font-weight: bold;">ASSIGNED WORK STYLE</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--ana-blue-main); line-height: 1.2;">
                                ${getWorkStyle(f.seat)}<br>
                                <span style="font-size: 0.8rem; color: #888; font-weight: normal;">SEAT: ${f.seat}</span>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; border-top: 1px dashed #ccc; padding-top: 15px;">
                            <div>
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">PRIORITY</div>
                                <div style="font-size: 1.2rem; font-weight: bold;"><span style="background: #000; color: #fff; padding: 2px 8px; border-radius: 4px;">${priorityGroup}</span></div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">GATE (SPOT)</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">${gateLabel}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>` : ''}
    </div>`;
                }).join('');


                displayFlights.forEach(f => {
                    const qrContainer = document.getElementById(`qrcode-${f.id}`);
                    if (qrContainer) {
                        // データをURL化（btoaでエンコード）
                        // render関数の最後のループ内
                        const data = `${f.from},${f.to},${f.date},${f.time},${f.duration},${f.boardingClass},${f.seat},${f.weatherCity || ''}`;
                        const shareUrl = `${window.location.origin}${window.location.pathname}?add=${btoa(data)}`;

                        qrContainer.innerHTML = ""; // 重複防止
                        new QRCode(qrContainer, {
                            text: shareUrl,
                            width: 80,  // 搭乗券に収まるサイズ
                            height: 80,
                            colorDark: "#000000", // ANAブルー
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.M
                        });
                    }
                });


            } catch (e) {
                console.error("Render Error:", e);
                const list = document.getElementById('flightList');
                if (list) list.innerHTML = `<div style="padding:20px; color:red;">表示エラーが発生しました。データを初期化するか、開発者に連絡してください。<br>(${e.message})</div>`;
            }
        }

        // --- Other Functions ---
        function doCheckIn(id) {
            flights = flights.map(f => f.id === id ? { ...f, checkedIn: true } : f);
            localStorage.setItem('ana_flights_final', JSON.stringify(flights));
            render();
        }

        function saveFlight() {
            // HTMLのIDと一致させる (dateInput → flightDate)
            const fromCode = document.getElementById('fromSelect').value;
            const toCode = document.getElementById('toSelect').value;
            const dateVal = document.getElementById('flightDate').value;
            const timeVal = document.getElementById('timeInput').value;
            const durationVal = parseInt(document.getElementById('durationInput').value) || 60;
            const classVal = document.getElementById('classSelect').value;

            const fromAp = airports.find(a => a.code === fromCode);
            const toAp = airports.find(a => a.code === toCode);

            // バリデーション
            if (!dateVal || !timeVal) {
                alert('日付と時刻を入力してください');
                return;
            }

            const f = {
                id: Date.now(),
                date: dateVal,
                from: fromCode,
                fromName: fromAp ? fromAp.name : '',
                to: toCode,
                toName: toAp ? toAp.name : '',
                time: timeVal,
                duration: durationVal,
                seat: tempSeat || 'ANY',
                boardingClass: classVal,
                checkedIn: false,
                notifiedCheckIn: false,
                notified10Min: false,
                notifiedFinalCall: false,
                notifiedLanding: false,
                notifiedArrived: false
            };

            flights.push(f);
            localStorage.setItem('ana_flights_final', JSON.stringify(flights));
            closeBookingScreen();
            render();
        }

        function initSeatMap() {
            const grid = document.getElementById('seatGrid');
            grid.innerHTML = '';

            const selectedClass = document.getElementById('classSelect').value;

            for (let r = 1; r <= 20; r++) {
                let rowClass = (r <= 2) ? 'FIRST' : (r <= 7) ? 'BUSINESS' : 'ECONOMY';
                const isLocked = (rowClass !== selectedClass);
                const row = document.createElement('div');
                row.className = 'seat-row';
                if (isLocked) row.style.opacity = "0.3";
                ['A', 'B', 'C'].forEach(c => createSeat(row, r, c, isLocked, rowClass));
                const aisle = document.createElement('div'); aisle.className = 'aisle-gap'; aisle.innerText = r; row.appendChild(aisle);
                ['H', 'J', 'K'].forEach(c => createSeat(row, r, c, isLocked, rowClass));
                grid.appendChild(row);
            }
        }

        function createSeat(container, r, c, isLocked, rowClass) {
            const s = document.createElement('div');
            s.className = `seat seat-${rowClass.toLowerCase()}`;

            // スタイル判定省略、CSSクラスで制御

            s.innerHTML = `<span style="font-size:0.8rem; font-weight:bold;">${c}</span>`;

            if (isLocked) {
                s.style.cursor = 'not-allowed';
                s.style.background = '#e5e5e5';
                s.style.color = '#ccc';
                s.style.boxShadow = 'none';
                s.style.border = '1px solid #ddd';
                s.style.opacity = '0.6';
            } else {
                s.onclick = () => {
                    if (isLocked) return;
                    document.querySelectorAll('.seat').forEach(x => x.classList.remove('selected'));
                    s.classList.add('selected');
                    tempSeat = r + c;

                    // Add subtle haptic feedback visual
                    s.style.transform = "scale(0.9)";
                    setTimeout(() => s.style.transform = "scale(1)", 150);
                };
            }
            container.appendChild(s);
        }

        function requestNotification() {
            if (!("Notification" in window)) return alert("非対応ブラウザです");
            Notification.requestPermission().then(p => {
                if (p === "granted") {
                    document.getElementById('notifBtn').style.filter = "none";
                    new Notification("通知設定完了", { body: "準備が整いました。" });
                }
            });
        }

        function sendNotification(title, body, id) {
            if (Notification.permission === "granted" && !notifiedFlights.has(id + body)) {
                new Notification(title, { body: body });
                notifiedFlights.add(id + body);
            }
        }

        function showInAppBanner(text, id) {
            if (bannerShownFor.has(id + text)) return;
            const banner = document.getElementById('notifBanner');
            document.getElementById('notifText').innerText = text;
            banner.classList.add('show');
            setTimeout(hideBanner, 8000);
            bannerShownFor.add(id + text);
        }

        function hideBanner() { document.getElementById('notifBanner').classList.remove('show'); }

        function mainLoop() {
            render();
            const now = new Date().getTime();

            flights.forEach(f => {
                const status = getStatus(f);
                const [h, m] = f.time.split(':').map(Number);
                const depT = new Date(f.date).setHours(h, m);
                const arrT = depT + (f.duration * 60000);
                const diffDep = (depT - now) / 60000;
                const diffArr = (arrT - now) / 60000;

                // 1. 搭乗手続き開始 (60分前 & RESERVED)
                if (status === 'RESERVED' && isCheckInOpen(f) && !f.notifiedCheckIn) {
                    const msg = `搭乗手続き開始: ${f.from} ✈ ${f.to}`;
                    sendNotification("搭乗案内", msg, f.id);
                    showInAppBanner(msg, f.id);
                    f.notifiedCheckIn = true;
                }

                // 2. 出発10分前 (RESERVED/CHECKED-IN)
                if ((status === 'RESERVED' || status === 'CHECKED-IN') && diffDep <= 10 && diffDep > 2 && !f.notified10Min) {
                    const msg = `出発10分前です。搭乗口へお急ぎください (${f.from} ✈ ${f.to})`;
                    sendNotification("出発案内", msg, f.id);
                    showInAppBanner(msg, f.id);
                    f.notified10Min = true;
                }

                // 3. 最終案内 (2分前)
                if ((status === 'RESERVED' || status === 'CHECKED-IN') && diffDep <= 2 && diffDep > 0 && !f.notifiedFinalCall) {
                    const msg = `FINAL CALL: まもなくドアが閉まります！ (${f.from} ✈ ${f.to})`;
                    sendNotification("最終案内", msg, f.id);
                    showInAppBanner(msg, f.id);
                    f.notifiedFinalCall = true;
                }

                // 4. 到着5分前 (INFLIGHT)
                if (status === 'INFLIGHT' && diffArr <= 5 && diffArr > 0 && !f.notifiedLanding) {
                    const msg = `まもなく ${f.to} に到着いたします。お忘れ物にご注意ください`;
                    sendNotification("着陸案内", msg, f.id);
                    showInAppBanner(msg, f.id);
                    f.notifiedLanding = true;
                }

                // 5. 到着時 (ARRIVEDになる瞬間)
                if (status === 'ARRIVED' && !f.notifiedArrived) {
                    const msg = `${f.to} に到着しました。本日のご搭乗ありがとうございました！`;
                    sendNotification("到着通知", msg, f.id);
                    showInAppBanner(msg, f.id);
                    f.notifiedArrived = true;
                }
            });

            localStorage.setItem('ana_flights_final', JSON.stringify(flights));
        }


        let currentBookingStep = 1;

        function openNewFlightModal() {
            tempSeat = null;
            document.getElementById('seatLabel').innerText = '未指定';

            // 完全なリセット
            document.getElementById('fromSelect').value = '';
            document.getElementById('toSelect').value = '';
            document.getElementById('flightDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('timeInput').value = '';
            document.getElementById('durationInput').value = '60';
            document.getElementById('classSelect').value = 'ECONOMY';

            updateHeader();
            updateSelectOptions();
            currentBookingStep = 1;
            updateBookingStepUI();
            const screen = document.getElementById('newFlightModal');
            screen.style.display = 'flex';
            requestAnimationFrame(() => {
                screen.classList.add('active');
            });
            document.querySelector('.my-app-bottom-nav').style.display = 'none';
        }

        function closeBookingScreen() {
            const screen = document.getElementById('newFlightModal');
            screen.classList.remove('active');
            setTimeout(() => {
                screen.style.display = 'none';
            }, 350);
            document.querySelector('.my-app-bottom-nav').style.display = 'flex';
        }

        function updateBookingStepUI() {
            // Hide all
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`booking-step-${i}`).style.display = 'none';
            }

            // Show current
            document.getElementById(`booking-step-${currentBookingStep}`).style.display = 'block';

            // Update step dots
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById(`bsd-${i}`);
                const label = document.getElementById(`bslbl-${i}`);
                dot.classList.remove('active', 'done');
                label.classList.remove('active');
                if (i < currentBookingStep) {
                    dot.classList.add('done');
                    dot.innerHTML = '✓';
                } else if (i === currentBookingStep) {
                    dot.classList.add('active');
                    dot.innerHTML = i;
                    label.classList.add('active');
                } else {
                    dot.innerHTML = i;
                }
            }
            // Update step lines
            for (let i = 1; i <= 2; i++) {
                const line = document.getElementById(`bsl-${i}`);
                if (i < currentBookingStep) {
                    line.classList.add('done');
                } else {
                    line.classList.remove('done');
                }
            }

            // Update Buttons
            const btnBack = document.getElementById('btn-back');
            const btnNext = document.getElementById('btn-next');
            const btnConfirm = document.getElementById('btn-confirm');
            const headerBack = document.getElementById('booking-back-header');

            if (currentBookingStep === 1) {
                btnBack.style.display = 'none';
                btnNext.style.display = 'block';
                btnConfirm.style.display = 'none';
                headerBack.style.visibility = 'hidden';
            } else if (currentBookingStep === 2) {
                btnBack.style.display = 'block';
                btnNext.style.display = 'block';
                btnConfirm.style.display = 'none';
                headerBack.style.visibility = 'visible';
            } else {
                btnBack.style.display = 'block';
                btnNext.style.display = 'none';
                btnConfirm.style.display = 'block';
                headerBack.style.visibility = 'visible';
            }
        }

        function nextBookingStep() {
            // Validation
            if (currentBookingStep === 1) {
                const f = document.getElementById('fromSelect').value;
                const t = document.getElementById('toSelect').value;
                if (!f || !t) { alert('出発地と到着地を選択してください'); return; }
                if (f === t) { alert('出発地と到着地は異なる場所を選択してください'); return; }
            } else if (currentBookingStep === 2) {
                const d = document.getElementById('flightDate').value;
                const time = document.getElementById('timeInput').value;
                if (!d || !time) { alert('日時を入力してください'); return; }
            }

            if (currentBookingStep < 3) {
                currentBookingStep++;
                updateBookingStepUI();
            }
        }

        function prevBookingStep() {
            if (currentBookingStep > 1) {
                currentBookingStep--;
                updateBookingStepUI();
            }
        }
        function openAirportModal() { renderAirportList(); document.getElementById('airportModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openSeatMap() { initSeatMap(); document.getElementById('seatModal').style.display = 'flex'; }
        function confirmSeat() { if (tempSeat) document.getElementById('seatLabel').innerText = tempSeat; closeModal('seatModal'); }
        function updateSelectOptions() {
            const combined = [...airports];
            const html = combined.map(a => `<option value="${a.code}">${a.code} - ${a.name}</option>`).join('');
            document.getElementById('fromSelect').innerHTML = html;
            document.getElementById('toSelect').innerHTML = html;
            if (combined.length > 1) document.getElementById('toSelect').selectedIndex = 1;
        }
        function renderAirportList() {
            document.getElementById('airportListUi').innerHTML = airports.map((a, i) => `<li class="airport-item"><span class="airport-code-tag">${a.code}</span><strong>${a.name}</strong><button class="delete-btn" onclick="deleteAirport(${i})">×</button></li>`).join('');
        }
        function addAirport() {
            const c = document.getElementById('newAirportCode').value.toUpperCase();
            const n = document.getElementById('newAirportName').value;
            if (c && n) { airports.push({ code: c, name: n }); localStorage.setItem('my_airports', JSON.stringify(airports)); renderAirportList(); }
        }
        function deleteAirport(i) { airports.splice(i, 1); localStorage.setItem('my_airports', JSON.stringify(airports)); renderAirportList(); }

        if (Notification.permission === "granted") document.getElementById('notifBtn').style.filter = "none";


        render();
        setInterval(mainLoop, 10000);


        function repeatFlight(f) {
            switchTab('upcoming');
            openNewFlightModal();

            setTimeout(() => {
                document.getElementById('fromSelect').value = f.from;
                document.getElementById('toSelect').value = f.to;
                document.getElementById('durationInput').value = f.duration;
                document.getElementById('classSelect').value = f.boardingClass || 'ECONOMY';

                // IDを修正: dateInput → flightDate
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('flightDate').value = today;

                tempSeat = null;
                document.getElementById('seatLabel').innerText = `未指定 (前回: ${f.seat})`;

                const now = new Date();
                now.setMinutes(now.getMinutes() + 10);
                const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                document.getElementById('timeInput').value = timeStr;
            }, 100);
        }

        function toggleBoardingPass(btn) {
            const container = btn.nextElementSibling;
            const overlay = document.getElementById('focusOverlay');
            const isOpen = container.classList.toggle('open');

            btn.classList.toggle('active');
            btn.textContent = isOpen ? '搭乗券を閉じる' : '搭乗券を表示';

            if (isOpen) {
                overlay.classList.add('active');
                // 他の要素が重ならないようにカードを最前面へ
                btn.parentElement.style.zIndex = "1001";
            } else {
                overlay.classList.remove('active');
                btn.parentElement.style.zIndex = "";
            }
        }

        // 背景をタップした時に閉じる用
        function closeAllPasses() {
            const openPasses = document.querySelectorAll('.boarding-pass-container.open');
            openPasses.forEach(container => {
                const btn = container.previousElementSibling;
                container.classList.remove('open');
                btn.classList.remove('active');
                btn.textContent = '搭乗券を表示';
                btn.parentElement.style.zIndex = "";
            });
            document.getElementById('focusOverlay').classList.remove('active');
        }

        function getBgClass(timeStr) {
            const hour = parseInt(timeStr.split(':')[0]);
            if (hour >= 5 && hour < 10) return 'bg-dawn';   // 5:00 - 9:59
            if (hour >= 10 && hour < 16) return 'bg-day';   // 10:00 - 15:59
            if (hour >= 16 && hour < 19) return 'bg-sunset'; // 16:00 - 18:59
            return 'bg-night';                               // それ以外（夜）
        }

        let isPortalMode = false;
        const cabinAudio = document.getElementById('cabinNoise');

        function togglePortal(id) {
            const screen = document.getElementById('focusModeScreen');
            const content = document.getElementById('focusContent');

            isPortalMode = !isPortalMode;

            if (isPortalMode) {
                let activeFlight = flights.find(f => f.id === id) || flights.find(f => getStatus(f) === 'INFLIGHT');

                // テスト用：もし飛行中の便がなければ、強制的にダミーデータで起動させる場合はここをコメントアウト解除
                /*
                if (!activeFlight) {
                     alert("現在飛行中のフライトが必要です");
                     isFocusMode = false; return;
                }
                */

                // 本番用チェック（もしダミーを使わないならこのまま）
                if (!activeFlight) {
                    alert("飛行中のフライトが見つかりません");
                    isPortalMode = false;
                    return;
                }

                startCabinNoise();
                document.querySelector('.my-app-bottom-nav').style.display = 'none';

                // 現在のフライトIDを記録（タスクリスト紐づけ用）
                window.currentFocusFlightId = activeFlight.id;
                // このフライト用のタスクを読み込む
                loadTasksForFlight(activeFlight.id);

                content.innerHTML = `
    <div id="focus-wrapper" style="position:relative; width:100%; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; background: transparent; overflow:hidden;">
        
        <div id="focus-dynamic-content" style="width:100%; height:100%;"></div>

        <!-- コントロールボタン群 -->
        <div class="focus-controls" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); display:flex; gap:15px; z-index:10001;">
            <button onclick="toggleSound()" id="btn-sound" style="background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); border:1px solid rgba(255,255,255,0.3); color:#fff; width:50px; height:50px; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                🔊
            </button>
            <button onclick="toggleNotePanel()" style="background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); border:1px solid rgba(255,255,255,0.3); color:#fff; width:50px; height:50px; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                📝
            </button>
            <button onclick="togglePortal()" style="background:rgba(255,50,50,0.8); backdrop-filter:blur(5px); border:1px solid rgba(255,255,255,0.3); color:#fff; padding:0 25px; height:50px; border-radius:30px; font-size:14px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                EXIT
            </button>
        </div>

        <!-- タスクリストパネル（初期は隠す） -->
        <div id="focus-task-panel" style="position:fixed; top:0; right:-350px; width:300px; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); transition:right 0.3s ease; z-index:10002; padding:20px; font-family:sans-serif;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #555; padding-bottom:10px;">
                <h3 style="color:white; margin:0;">In-Flight Tasks</h3>
                <button onclick="toggleNotePanel()" style="background:none; border:none; color:#aaa; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div style="display:flex; margin-bottom:15px;">
                <input type="text" id="new-task-input" placeholder="Add a new task..." style="flex:1; padding:8px; border-radius:4px 0 0 4px; border:none; outline:none;">
                <button onclick="addTask()" style="background:var(--ana-blue-sky); color:white; border:none; padding:8px 15px; border-radius:0 4px 4px 0; cursor:pointer;">Add</button>
            </div>

            <ul id="task-list" style="list-style:none; padding:0; margin:0; overflow-y:auto; max-height:calc(100% - 120px);">
                <!-- Tasks will be injected here -->
            </ul>
        </div>
    </div>
`;

                const dynamicPart = document.getElementById('focus-dynamic-content');
                updatePortalUI(activeFlight, dynamicPart);
                window.portalTimer = setInterval(() => updatePortalUI(activeFlight, dynamicPart), 1000);

                screen.classList.add('active');
                document.body.classList.add('focus-active');
            } else {
                stopCabinNoise();
                clearInterval(window.portalTimer);
                screen.classList.remove('active');
                document.body.classList.remove('focus-active');
                document.querySelector('.my-app-bottom-nav').style.display = 'flex';
            }
        }

        function updatePortalUI(f, container) {
            // 到着していたら自動終了
            if (getStatus(f) === 'ARRIVED') {
                togglePortal();
                return;
            }

            const now = new Date().getTime();
            const [h, m] = f.time.split(':').map(Number);
            const depT = new Date(f.date).setHours(h, m);
            const elapsed = now - depT;
            const totalMs = f.duration * 60000;
            const percent = Math.min(Math.max((elapsed / totalMs) * 100, 0), 100);
            const remainingMins = Math.max(0, f.duration - Math.floor(elapsed / 60000));

            const isWindowSeat = ['A', 'K'].includes(f.seat.slice(-1));
            const portalType = isWindowSeat ? 'WINDOW' : 'AISLE';

            if (!document.getElementById('portal-body')) {
                const hour = new Date().getHours();
                let skyGradient = 'linear-gradient(to bottom, #1e90ff 0%, #87ceeb 100%)';
                if (hour >= 18 || hour < 6) skyGradient = 'linear-gradient(to bottom, #001a33 0%, #004482 100%)';

                let specificContent = '';
                if (portalType === 'WINDOW') {
                    specificContent = `
                        <div style="font-size: 0.8rem; letter-spacing: 4px; color: white; opacity: 0.9; margin-bottom: 20px; text-shadow: 0 2px 4px black;">DEEP FOCUS - WINDOW VIEW</div>
                        <div class="window-outer-frame">
                            <div class="window-inner-frame" onclick="toggleShade()" style="position:relative;">
                                <div class="sky-background" style="background: ${skyGradient}; position:absolute; top:0; left:0; width:100%; height:100%; z-index:1;">
                                    <div class="real-cloud" style="top:25%; transform:scale(0.5); animation-duration: 12s; opacity: 0.5;"></div>
                                    <div class="real-cloud" style="top:45%; transform:scale(1.2); animation-duration: 25s; animation-delay: -5s;"></div>
                                    <div class="real-cloud" style="top:75%; transform:scale(1.8); animation-duration: 40s; animation-delay: -15s; filter: blur(12px); opacity: 0.4;"></div>
                                </div>
                                <div id="window-shade">
                                    <div class="shade-handle"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    specificContent = `
                        <div style="font-size: 0.8rem; letter-spacing: 4px; color: white; opacity: 0.9; margin-bottom: 20px; text-shadow: 0 2px 4px black;">LIGHT RELAX - FLIGHT CONSOLE</div>
                        <div class="portal-map-area">
                            <div class="portal-map-line"></div>
                            <div id="portal-map-plane" class="portal-map-plane">✈</div>
                            <div style="position:absolute; bottom:10px; left:10px; color:white; font-size:0.6rem; opacity:0.6;">FLIGHT MAP VIEW</div>
                        </div>
                        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
                            <div style="background:rgba(0,0,0,0.5); padding:10px 20px; border-radius:4px; border:1px solid #00ff00; color:#00ff00; font-size:0.7rem; font-weight:bold;">FASTEN SEATBELT: OFF</div>
                            <div style="background:rgba(0,0,0,0.5); padding:10px 20px; border-radius:4px; border:1px solid #ccc; color:#ccc; font-size:0.7rem; font-weight:bold;">Wi-Fi: CONNECTED</div>
                        </div>
                    `;
                }

                container.innerHTML = `
    <div id="portal-body" style="text-align:center; padding-top: 40px; width:100%; max-width:500px; margin:0 auto;">
        ${specificContent}

        <div class="info-glass-panel">
            <div class="focus-text-bold focus-route">${f.from} ✈ ${f.to}</div>
            
            <div class="portal-telemetry-grid">
                <div class="portal-stat-box">
                    <div class="portal-stat-label">ALTITUDE</div>
                    <div class="portal-stat-value" id="stat-alt">35,000 ft</div>
                </div>
                <div class="portal-stat-box">
                    <div class="portal-stat-label">SPEED</div>
                    <div class="portal-stat-value" id="stat-spd">480 kts</div>
                </div>
            </div>

            <div id="portal-timer-text" style="margin-top:20px; font-size:0.9rem; color: #99ccff;"></div>
        </div>

        <div style="font-size: 0.65rem; color: white; opacity: 0.5; margin-top: 20px; letter-spacing: 2px;">
            IN-FLIGHT ENTERTAINMENT SYSTEM V3.0
        </div>
    </div>
`;
            }

            // 更新処理
            const timerText = document.getElementById('portal-timer-text');
            if (timerText) timerText.innerText = `REMAINING: ${remainingMins} MIN`;

            const mapPlane = document.getElementById('portal-map-plane');
            if (mapPlane) mapPlane.style.left = `${10 + (percent * 0.8)}%`;

            // テレメトリの微変動演出
            const altEl = document.getElementById('stat-alt');
            const spdEl = document.getElementById('stat-spd');
            if (altEl && spdEl) {
                const altBase = percent < 10 ? (percent / 10) * 35000 : 35000;
                altEl.innerText = `${Math.floor(altBase + Math.random() * 50).toLocaleString()} ft`;
                spdEl.innerText = `${Math.floor(480 + Math.random() * 5)} kts`;
            }
        }

        function toggleShade() {
            const shade = document.getElementById('window-shade');
            const screen = document.getElementById('focusModeScreen'); // ★ここを修正

            if (shade && screen) {
                const isClosing = shade.classList.toggle('shade-closed');

                if (isClosing) {
                    // 閉じた時：機内を暗くする（夜間飛行モード）
                    screen.style.background = "radial-gradient(circle at center, #2c3e50 0%, #000 100%)";
                } else {
                    // 開いた時：機内を明るくする
                    screen.style.background = "radial-gradient(circle at center, #e6e9ed 0%, #bdc3c7 100%)";
                }
            }
        }


        // グローバルスコープで定義
        let audioCtx = null;
        let noiseNode = null;
        let filterNode = null;
        let gainNode = null;

        function startCabinNoise() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            if (noiseNode) return;

            const bufferSize = 2 * audioCtx.sampleRate;
            const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }

            noiseNode = audioCtx.createBufferSource();
            noiseNode.buffer = noiseBuffer;
            noiseNode.loop = true;

            filterNode = audioCtx.createBiquadFilter();
            filterNode.type = 'lowpass';
            filterNode.frequency.setValueAtTime(200, audioCtx.currentTime);

            // ここでグローバル変数の gainNode を使用
            gainNode = audioCtx.createGain();
            // 初期音量（ミュート状態でなければ1、ミュートなら0）
            gainNode.gain.setValueAtTime(isMuted ? 0 : 1, audioCtx.currentTime);

            noiseNode.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            noiseNode.start();
        }

        // 古いメモ機能の削除に伴い、関連イベントリスナーも削除済み


        function stopCabinNoise() {
            if (noiseNode) {
                noiseNode.stop();
                noiseNode.disconnect();
                noiseNode = null; // リセット
            }
        }

        // 1. フライト情報をURLに変換してQRを表示
        function shareFlight(id) {
            const f = flights.find(x => x.id === id);
            if (!f) return;

            // データを圧縮してURLパラメータを作成
            const data = `${f.from},${f.to},${f.date},${f.time},${f.duration},${f.boardingClass},${f.seat},${f.weatherCity || ''}`;
            const shareUrl = `${window.location.origin}${window.location.pathname}?add=${btoa(data)}`;

            // QRコードの生成
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = ""; // 前のQRをクリア
            new QRCode(qrContainer, {
                text: shareUrl,
                width: 200,
                height: 200
            });

            document.getElementById('qrModal').style.display = 'flex';
        }

        // 2. ページ読み込み時にURLパラメータを確認（受け取り側）
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const addData = params.get('add');
            if (addData) {
                try {
                    // Base64デコードして配列に戻す
                    const decoded = atob(addData).split(',');

                    // データの順番をQR生成時と完全に一致させる
                    // 0:from, 1:to, 2:date, 3:time, 4:duration, 5:class, 6:seat
                    const fromAp = airports.find(a => a.code === decoded[0]);
                    const toAp = airports.find(a => a.code === decoded[1]);

                    const newFlight = {
                        id: Date.now(),
                        from: decoded[0],
                        fromName: fromAp ? fromAp.name : '',
                        to: decoded[1],
                        toName: toAp ? toAp.name : '',
                        date: decoded[2],
                        time: decoded[3],
                        duration: parseInt(decoded[4]),
                        boardingClass: decoded[5] || 'ECONOMY',
                        seat: decoded[6] || 'ANY',
                        checkedIn: false
                    };

                    // 重複チェック（同じ出発地・目的地・時刻なら追加しない）
                    const isDuplicate = flights.some(f => f.from === newFlight.from && f.time === newFlight.time && f.date === newFlight.date);

                    if (!isDuplicate) {
                        flights.push(newFlight);
                        localStorage.setItem('ana_flights_final', JSON.stringify(flights));
                        render();
                        alert("✈️ 共有されたフライトを追加しました！");
                    }

                    // URLからパラメータを消してスッキリさせる
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) {
                    console.error("共有データの読み込みに失敗しました:", e);
                }
            }
        });

        let videoStream = null;

        function startScan() {
            const video = document.getElementById("video");
            const modal = document.getElementById("scanModal");
            document.querySelector('.my-app-bottom-nav').style.display = 'none';
            modal.style.display = "flex";

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
                videoStream = stream;
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                requestAnimationFrame(tick);
            });
        }

        function stopScan() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById("scanModal").style.display = "none";
            document.querySelector('.my-app-bottom-nav').style.display = 'flex';
        }

        function tick() {
            const video = document.getElementById("video");
            const canvasElement = document.getElementById("canvas");
            const canvas = canvasElement.getContext("2d");

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code) {
                    // QRコードの中にURL（?add=...）が含まれているかチェック
                    if (code.data.includes("?add=")) {
                        const url = new URL(code.data);
                        const addData = url.searchParams.get('add');
                        if (addData) {
                            processAddData(addData); // 既存の取り込みロジックへ
                            stopScan();
                            alert("フライトを取り込みました！");
                            return;
                        }
                    }
                }
            }
            if (document.getElementById("scanModal").style.display === "flex") {
                requestAnimationFrame(tick);
            }
        }

        // 受け取りロジックを共通化
        function processAddData(addData) {
            try {
                const decoded = atob(addData).split(',');
                const newFlight = {
                    id: Date.now(),
                    from: decoded[0], to: decoded[1],
                    weatherCity: decoded[7] || '',
                    date: decoded[2], time: decoded[3],
                    duration: parseInt(decoded[4]),
                    boardingClass: decoded[5] || 'ECONOMY',
                    seat: decoded[6] || 'ANY',
                    checkedIn: false
                };
                flights.push(newFlight);
                localStorage.setItem('ana_flights_final', JSON.stringify(flights));
                render();
            } catch (e) { console.error("Invalid QR Data"); }
        }

        setInterval(() => {
            render();
            checkNotifications();
        }, 30000);


        // 集中モード用のメモ機能ロジック
        document.addEventListener('DOMContentLoaded', () => {
            const focusTextarea = document.getElementById('focus-textarea');
            const toggleNoteBtn = document.getElementById('toggle-note');
            const noteContainer = document.getElementById('focus-note-container');

            // 1. 保存されたメモを復元
            const savedNote = localStorage.getItem('ana_inflight_memo');
            if (savedNote) {
                focusTextarea.value = savedNote;
            }

            // 2. 入力するたびに自動保存
            focusTextarea.addEventListener('input', (e) => {
                localStorage.setItem('ana_inflight_memo', e.target.value);
            });

            // 3. メモ帳の表示/非表示切り替え（景色を見たい時用）
            toggleNoteBtn.addEventListener('click', () => {
                if (focusTextarea.style.display === 'none') {
                    focusTextarea.style.display = 'block';
                    toggleNoteBtn.textContent = 'Hide';
                    noteContainer.style.height = 'auto';
                } else {
                    focusTextarea.style.display = 'none';
                    toggleNoteBtn.textContent = 'Show Memo';
                    noteContainer.style.height = '40px';
                }
            });
        });

        // --- Focus Mode Task List Logic (per-flight) ---
        let focusTasks = [];
        let isTaskPanelOpen = false;

        function loadTasksForFlight(flightId) {
            const allFlightTasks = JSON.parse(localStorage.getItem('ana_flight_tasks') || '{}');
            focusTasks = allFlightTasks[flightId] || [];
        }

        function saveTasks() {
            const flightId = window.currentFocusFlightId;
            if (!flightId) return;
            const allFlightTasks = JSON.parse(localStorage.getItem('ana_flight_tasks') || '{}');
            allFlightTasks[flightId] = focusTasks;
            localStorage.setItem('ana_flight_tasks', JSON.stringify(allFlightTasks));
        }

        function toggleNotePanel() {
            const panel = document.getElementById('focus-task-panel');
            isTaskPanelOpen = !isTaskPanelOpen;
            if (isTaskPanelOpen) {
                panel.style.right = '0';
                renderTasks();
            } else {
                panel.style.right = '-350px';
            }
        }

        function addTask() {
            const input = document.getElementById('new-task-input');
            const text = input.value.trim();
            if (!text) return;

            focusTasks.push({
                id: Date.now(),
                text: text,
                done: false
            });
            saveTasks();
            renderTasks();
            input.value = '';
        }

        function toggleTask(id) {
            const task = focusTasks.find(t => t.id === id);
            if (task) {
                task.done = !task.done;
                saveTasks();
                renderTasks();
            }
        }

        function deleteTask(id) {
            focusTasks = focusTasks.filter(t => t.id !== id);
            saveTasks();
            renderTasks();
        }

        // 履歴カードにフライトのタスクとメモを表示
        function getFlightNotesHtml(flightId) {
            const allFlightTasks = JSON.parse(localStorage.getItem('ana_flight_tasks') || '{}');
            const tasks = allFlightTasks[flightId];
            if (!tasks || tasks.length === 0) return '';

            const taskItems = tasks.map(t => `
                <div style="display:flex; align-items:center; gap:8px; padding:4px 0;">
                    <span style="font-size:0.9rem;">${t.done ? '✅' : '⬜'}</span>
                    <span style="font-size:0.75rem; ${t.done ? 'text-decoration:line-through; opacity:0.6;' : ''}">${t.text}</span>
                </div>
            `).join('');

            return `
                <div style="margin-top:10px; padding:10px; background:rgba(255,255,255,0.1); border-radius:8px; border:1px solid rgba(255,255,255,0.15);">
                    <div style="font-size:0.65rem; color:rgba(255,255,255,0.7); font-weight:bold; letter-spacing:1px; margin-bottom:6px;">📝 IN-FLIGHT NOTES</div>
                    ${taskItems}
                </div>
            `;
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            if (!list) return;
            const html = focusTasks.map(t => `
                <li style="background:rgba(255,255,255,0.1); margin-bottom:8px; padding:10px; border-radius:4px; display:flex; align-items:center; justify-content:space-between;">
                    <div style="display:flex; align-items:center; flex:1; cursor:pointer;" onclick="toggleTask(${t.id})">
                        <span style="font-size:1.2rem; margin-right:10px;">${t.done ? '☑️' : '⬜'}</span>
                        <span style="${t.done ? 'text-decoration:line-through; color:#aaa;' : 'color:white;'}">${t.text}</span>
                    </div>
                    <button onclick="deleteTask(${t.id})" style="background:none; border:none; color:#ff6b6b; cursor:pointer; font-weight:bold;">✕</button>
                </li>
            `).join('');
            list.innerHTML = html;
        }

        // --- Sound Control Logic ---
        let isMuted = false;

        function toggleSound() {
            isMuted = !isMuted;
            const btn = document.getElementById('btn-sound');

            if (isMuted) {
                if (gainNode) gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                btn.innerText = '🔇';
            } else {
                if (gainNode) gainNode.gain.setValueAtTime(1, audioCtx.currentTime);
                btn.innerText = '🔊';
            }
        }

        /* Legacy Memo Code Removed */


        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.style.top = '20px';

            setTimeout(() => {
                toast.style.top = '-100px';
            }, 4000);
        }

        function checkNotifications() {
            const now = new Date();

            flights.forEach(f => {
                const [h, m] = f.time.split(':').map(Number);
                const dep = new Date();
                dep.setHours(h, m, 0, 0);

                const diffMin = Math.floor((dep - now) / 60000);

                // Check-in Open（10分前）
                if (
                    diffMin === 10 &&
                    !f.notifiedCheckIn &&
                    !f.checkedIn
                ) {
                    showToast(`✈️ Check-in Open ${f.from} → ${f.to}`);
                    f.notifiedCheckIn = true;
                }

                // Last Call（2分前）
                if (
                    diffMin === 2 &&
                    !f.notifiedLastCall &&
                    !f.checkedIn
                ) {
                    showToast(`⚠️ Last Call ${f.from} → ${f.to}`);
                    f.notifiedLastCall = true;
                }
            });

            localStorage.setItem('ana_flights_v5', JSON.stringify(flights));
        }

        function playCheckInFeedback() {

            // 振動（対応端末のみ）
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        let audioUnlocked = false;

        function unlockAudio() {
            if (audioUnlocked) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            ctx.resume();
            audioUnlocked = true;
        }

        function playCheckInBeep() {
            if (localStorage.getItem('ana_sound_enabled') === 'false') return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const t = ctx.currentTime;

            // リバーブ用のConvolver作成
            const convolver = ctx.createConvolver();
            const rate = ctx.sampleRate;
            const length = rate * 2.5; // 2.5秒の残響
            const impulse = ctx.createBuffer(2, length, rate);
            for (let ch = 0; ch < 2; ch++) {
                const data = impulse.getChannelData(ch);
                for (let i = 0; i < length; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2.5);
                }
            }
            convolver.buffer = impulse;

            // ドライ・ウェット ミックス
            const dryGain = ctx.createGain();
            dryGain.gain.value = 0.4;
            const wetGain = ctx.createGain();
            wetGain.gain.value = 0.5;
            convolver.connect(wetGain);
            dryGain.connect(ctx.destination);
            wetGain.connect(ctx.destination);

            // 和音チャイム（C6 → E6 → G6 → C7 のアルペジオ）
            const notes = [1046.5, 1318.5, 1568, 2093];
            const delays = [0, 0.12, 0.24, 0.48];

            notes.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = freq;

                // 倍音を少し加える
                const osc2 = ctx.createOscillator();
                osc2.type = 'sine';
                osc2.frequency.value = freq * 2;

                const noteGain = ctx.createGain();
                noteGain.gain.value = 0.0001;

                const harmGain = ctx.createGain();
                harmGain.gain.value = 0.0001;

                osc.connect(noteGain);
                osc2.connect(harmGain);
                noteGain.connect(dryGain);
                noteGain.connect(convolver);
                harmGain.connect(dryGain);
                harmGain.connect(convolver);

                const start = t + delays[i];
                const vol = i === notes.length - 1 ? 0.25 : 0.18;
                const harmVol = vol * 0.08;

                // ソフトなアタック
                noteGain.gain.setValueAtTime(0.0001, start);
                noteGain.gain.exponentialRampToValueAtTime(vol, start + 0.04);
                noteGain.gain.exponentialRampToValueAtTime(vol * 0.6, start + 0.15);
                noteGain.gain.exponentialRampToValueAtTime(0.0001, start + 1.8);

                harmGain.gain.setValueAtTime(0.0001, start);
                harmGain.gain.exponentialRampToValueAtTime(harmVol, start + 0.04);
                harmGain.gain.exponentialRampToValueAtTime(0.0001, start + 1.0);

                osc.start(start);
                osc.stop(start + 2.5);
                osc2.start(start);
                osc2.stop(start + 1.5);
            });
        }

        function getFidsStatus(f, isArrival = false) {
            if (f.external) {
                // 外部データの場合はマッピング
                const s = f.status.toUpperCase();
                const map = {
                    'ARRIVED': { jp: '到着済', en: 'ARRIVED', color: 'color-arrived' },
                    'LANDED': { jp: '着陸済', en: 'LANDED', color: 'color-arrived' },
                    'DELAYED': { jp: '遅延', en: 'DELAYED', color: 'color-delayed' },
                    'SCHEDULED': { jp: '定刻', en: 'SCHEDULED', color: 'color-scheduled' },
                    'BOARDING': { jp: '搭乗中', en: 'BOARDING', color: 'color-boarding blink' },
                    'LAST CALL': { jp: '最終案内', en: 'LAST CALL', color: 'color-last-call blink' }
                };
                return map[s] || { jp: s, en: s, color: 'color-scheduled' };
            }

            // 自便の場合は時刻ベースで計算
            const now = new Date();
            const [h, m] = f.time.split(':').map(Number);
            const depT = new Date();
            depT.setHours(h, m, 0, 0);
            const diff = (depT - now) / 60000;

            const status = getStatus(f);
            if (status === 'ARRIVED') return { jp: '到着済', en: 'ARRIVED', color: 'color-arrived' };
            if (status === 'INFLIGHT') return { jp: isArrival ? '着陸済' : '飛行中', en: isArrival ? 'LANDED' : 'IN-FLIGHT', color: 'color-boarding' };

            if (diff > 60) return { jp: '定刻', en: 'SCHEDULED', color: 'color-scheduled' };
            if (diff > 20) return { jp: '手続き中', en: 'CHECK-IN', color: 'color-checkin' };
            if (diff > 10) return { jp: '搭乗中', en: 'BOARDING', color: 'color-boarding blink' };
            if (diff > 3) return { jp: '最終案内', en: 'LAST CALL', color: 'color-last-call blink' };
            return { jp: 'ゲート締切', en: 'GATE CLOSED', color: 'color-closed' };
        }

        function toggleBoardMode() {
            boardMode = !boardMode;
            render();
        }

        function toggleFidsType() {
            fidsType = (fidsType === 'DEPARTURES' ? 'ARRIVALS' : 'DEPARTURES');
            render();
        }

        function renderFidsBoard() {
            const list = document.getElementById('flightList');
            const now = new Date();
            const nowMin = getNowMinutes();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

            const isArrivals = fidsType === 'ARRIVALS';

            // ① 古い便を削除
            if (isArrivals) {
                externalArrivals = externalArrivals.filter(f => timeToMinutes(f.time) >= nowMin - 30);
                while (externalArrivals.length < EXTERNAL_FLIGHT_TARGET) {
                    externalArrivals.push(...generateExternalFlights(1, true));
                }
            } else {
                externalFlights = externalFlights.filter(f => timeToMinutes(f.time) >= nowMin);
                replenishExternalFlights();
            }

            // ③ 統合データ作成
            let allFlights = [];
            if (isArrivals) {
                allFlights = externalArrivals;
            } else {
                allFlights = [
                    ...flights.map(f => ({ ...f, flight: getFlightNumber(f), airline: 'TASK AIR', external: false })),
                    ...externalFlights
                ];
            }
            allFlights.sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));

            list.innerHTML = `
                <div class="board-frame">
                    <div class="board">
                        <div class="board-header-fids">
                            <div class="board-title-fids">${fidsType} / ${fidsType === 'DEPARTURES' ? '出発案内' : '到着案内'}</div>
                            <div class="board-clock-fids">${timeStr}</div>
                        </div>
                        
                        <div class="board-table-header">
                            <span>TIME</span>
                            <span>FLIGHT</span>
                            <span>${isArrivals ? 'FROM' : 'TO'}</span>
                            <span>GATE</span>
                            <span style="text-align:right">STATUS</span>
                        </div>

                        ${allFlights.map(f => {
                const gate = getGateForFlight(f.flight);
                const sObj = getFidsStatus(f, isArrivals);
                const cityName = formatAirport(isArrivals ? f.from : f.to, f.external);
                const airportCode = isArrivals ? f.from : f.to;

                return `
                            <div class="board-row-fids ${!f.external ? 'my-flight' : ''}">
                                <div class="fids-time">${f.time}</div>
                                <div>
                                    <div class="fids-airline-code">${f.airline || 'TA'} ${f.flight.replace(/[^0-9]/g, '')}</div>
                                </div>
                                <div class="fids-city-group">
                                    <div class="fids-city-name-jp">${cityName}</div>
                                    <div class="fids-city-name-en">${airportCode}</div>
                                </div>
                                <div class="fids-gate">${gate}</div>
                                <div class="fids-status-cell ${sObj.color}">
                                    <div class="fids-status-jp">${sObj.jp}</div>
                                    <div class="fids-status-en">${sObj.en}</div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }



        function cleanupFinishedFlights() {
            flights = flights.filter(f => {
                const status = getStatus(f);
                return status !== 'ARRIVED' && status !== 'NOSHOW';
            });
            localStorage.setItem('ana_flights_v5', JSON.stringify(flights));
        }

        function getFlightNumber(f) {
            return 'TA' + String(f.id).slice(-4);
        }


        function generateExternalFlights(count = 1, forceArrival = false) {
            const now = new Date();

            return Array.from({ length: count }).map(() => {
                const base = externalFlightsPool[
                    Math.floor(Math.random() * externalFlightsPool.length)
                ];

                const minutesDiff = forceArrival ? (Math.floor(Math.random() * 60) - 10) : (Math.floor(Math.random() * 180) + 5);
                const eventTime = new Date(now.getTime() + minutesDiff * 60000);
                const time =
                    eventTime.getHours().toString().padStart(2, '0') + ':' +
                    eventTime.getMinutes().toString().padStart(2, '0');

                const statusPool = forceArrival ? ['ARRIVED', 'LANDED', 'DELAYED', 'SCHEDULED'] : ['SCHEDULED', 'BOARDING', 'DELAYED', 'LAST CALL'];
                const status = statusPool[Math.floor(Math.random() * statusPool.length)];

                return {
                    external: true,
                    airline: base.airline,
                    flight: base.code + (Math.floor(Math.random() * 900) + 100),
                    from: base.from,
                    to: base.to,
                    time,
                    status: status
                };
            });
        }


        function timeToMinutes(t) {
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        }

        function getNowMinutes() {
            const now = new Date();
            return now.getHours() * 60 + now.getMinutes();
        }

        function replenishExternalFlights() {
            while (externalFlights.length < EXTERNAL_FLIGHT_TARGET) {
                externalFlights.push(...generateExternalFlights(1));
            }
        }

        function formatFlightDisplay(f) {
            if (f.external && f.airline) {
                return `${f.airline} ${f.flight.slice(2)}`;
            }
            return f.flight; // TASK Airline 等
        }

        function formatAirport(code, isExternal) {
            let name = "";
            if (!isExternal) {
                name = getMyAirportName(code);
                // ユーザー設定にない場合は定数マップ（羽田など）を確認
                if (name === code) {
                    name = airportNameMap[code] || code;
                }
            } else {
                name = airportNameMap[code] || code;
            }
            return name;
        }

        function getMyAirportName(code) {
            const a = airports.find(a => a.code === code);
            return a ? a.name : code;
        }

        
        async function enableNotifications() {
    const permission = await Notification.requestPermission();

    if (permission !== "granted") {
        alert("通知が許可されていません");
        return;
    }

    await registerPush();
    alert("通知を有効化しました ✈");
}



async function registerPush() {
    const reg = await navigator.serviceWorker.ready;

    const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array("BGHmKETXx2roUDR4uEvPxoa-Np52KVLYkxGB0sGKtWfLEafMsMjcuttnnC4q9A4BCWFX8ai6d_IqglaDZdHbIQk")
    });

    localStorage.setItem("pushSub", JSON.stringify(sub));
}

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');

    const rawData = atob(base64);
    return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
}
    </script>



</body>

</html>
