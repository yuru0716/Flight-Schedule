<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Schedule</title>
    <style>
        :root {
            --ana-blue-dark: #002D5A;
            --ana-blue-main: #004482;
            --ana-blue-sky: #0076cb;
            --ana-gradient: linear-gradient(135deg, #004482 0%, #0076cb 100%);
            --bg-gray: #f2f4f7;
            --plane-body: #ffffff;
            --plane-wing: #dce1e6;
            --text-main: #333;
            --danger: #d93025;
            --success: #1e8e3e;
            --gold: #d4af37;
            --diamond: #b9f2ff;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg-gray);
            margin: 0; padding: 0; color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        header {
            background-color: var(--ana-blue-dark);
            color: white; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header-left { display: flex; flex-direction: column; }
        .header-title { font-size: 1.2rem; font-weight: bold; }
        .mile-display { font-size: 0.8rem; color: var(--gold); font-weight: bold; margin-top: 2px; }
        .status-badge-header { font-size: 0.6rem; padding: 1px 5px; border-radius: 3px; margin-left: 5px; vertical-align: middle; }
        .st-BRONZE { background: #cd7f32; color: white; }
        .st-SAPPHIRE { background: #0f52ba; color: white; }
        .st-DIAMOND { background: var(--diamond); color: #004482; }
        .header-icon { font-size: 1.5rem; cursor: pointer; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

        /* Flight Card */
        .flight-card {
            background: white; border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative;
            overflow: hidden; border-top: 4px solid var(--ana-blue-main);
        }

        .noshow-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.7); display: flex;
            justify-content: center; align-items: center; z-index: 5; pointer-events: none;
        }
        .noshow-stamp {
            border: 4px solid var(--danger); color: var(--danger);
            padding: 10px 30px; font-size: 2rem; font-weight: 900;
            transform: rotate(-15deg); border-radius: 8px; background: white;
        }

        .card-inner { padding: 15px; }
        .route-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .city-box { text-align: center; width: 80px; }
        .city-code { font-size: 2rem; font-weight: 800; color: var(--ana-blue-dark); letter-spacing: 1px; line-height: 1; }
        .city-name { font-size: 0.7rem; color: #777; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .time-row {
            display: flex; justify-content: space-between; 
            background: #f4f7fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;
        }
        .time-box { text-align: center; flex: 1; }
        .time-label { font-size: 0.7rem; color: #666; font-weight: bold; }
        .time-value { font-size: 1.2rem; font-weight: bold; color: #333; }
        .duration-center { font-size: 0.8rem; color: #999; align-self: center; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; color: white; background: #999; }
        .badge-reserved { background: var(--ana-blue-sky); }
        .badge-checkin { background: var(--success); }
        .badge-noshow { background: var(--danger); }
        .badge-inflight { background: var(--ana-blue-main); animation: pulse 2s infinite; }
        .badge-arrived { background: var(--gold); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .boarding-pass { background: #f9f9f9; border-top: 1px dashed #ddd; padding: 12px; font-size: 0.8rem; }
        .mile-tag { color: var(--gold); font-weight: bold; font-size: 0.7rem; text-align: right; margin-top: 5px; }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 45, 90, 0.85); z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #f0f3f6; width: 95%; max-width: 480px; height: auto; max-height: 90vh;
            margin: 5vh auto; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;
        }
        .modal-header-ana { background: var(--ana-gradient); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .modal-footer { background: white; padding: 15px; border-top: 1px solid #ddd; }

        /* Inputs */
        .form-group { margin-bottom: 15px; background: white; padding: 15px; border-radius: 8px; }
        .form-group label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 8px; }
        select, input { 
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; 
            box-sizing: border-box; font-size: 1rem; background: #fff;
            -webkit-appearance: none; appearance: none;
        }

        /* Settings List */
        .airport-list { list-style: none; padding: 0; margin: 0; }
        .airport-item { 
            background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .airport-code-tag { background: var(--ana-blue-sky); color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; margin-right: 10px; }
        .delete-btn { color: var(--danger); background: none; border: none; font-size: 1.2rem; cursor: pointer; }

        /* Seat Map Elements */
        .plane-wrapper { position: relative; width: 280px; margin: 20px auto; padding-top: 60px; padding-bottom: 60px; }
        .fuselage { background: var(--plane-body); width: 100%; height: 100%; border-radius: 140px 140px 80px 80px; position: absolute; top: 0; left: 0; z-index: 1; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; }
        .cockpit { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); width: 50px; height: 20px; background: linear-gradient(to bottom, #333, #666); border-radius: 40% 40% 50% 50%; z-index: 2; }
        .wing-left, .wing-right { position: absolute; top: 300px; width: 100px; height: 180px; background: var(--plane-wing); z-index: 0; border: 1px solid #ccc; }
        .wing-left { left: -80px; transform: skewY(15deg); border-radius: 10% 0 0 80%; }
        .wing-right { right: -80px; transform: skewY(-15deg); border-radius: 0 10% 80% 0; }
        .seat-map-container { position: relative; z-index: 10; padding: 20px 10px; }
        .seat-row { display: flex; justify-content: center; gap: 5px; margin-bottom: 6px; }
        .aisle-gap { width: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #ccc; }
        .seat { width: 28px; height: 28px; background: #eef2f6; border: 1px solid #ccd1d6; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #666; cursor: pointer; }
        .seat.selected { background: var(--ana-blue-main); color: white; }

        /* Buttons */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; text-align: center; }
        .btn-save { background: var(--ana-blue-dark); color: white; }
        .btn-add { background: var(--success); color: white; margin-top: 10px; }
        .btn-checkin { background: var(--success); color: white; padding: 10px; border-radius: 8px; margin-top: 10px; width: 100%; }
        .btn-disabled { background: #ccc !important; cursor: not-allowed; }

        .fab { position: fixed; bottom: 30px; right: 25px; width: 65px; height: 65px; background: var(--ana-gradient); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2.2rem; box-shadow: 0 8px 20px rgba(0,68,130,0.4); border: none; cursor: pointer; z-index: 90; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <div class="header-title">Flight Schedule <span id="statusLabel" class="status-badge-header"></span></div>
        <div class="mile-display">✈ <span id="totalMiles">0</span> MILES</div>
    </div>
    <div class="header-icon" onclick="openAirportModal()">⚙️</div>
</header>

<div class="container" id="flightList"></div>

<button class="fab" onclick="openNewFlightModal()">+</button>

<div id="newFlightModal" class="modal">
    <div class="modal-content">
        <div class="modal-header-ana">
            <strong>フライト予約</strong>
            <span onclick="closeModal('newFlightModal')" style="cursor:pointer; font-size:1.5rem">×</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>搭乗クラス (ステータス別)</label>
                <select id="classSelect">
                    <option value="ECONOMY">普通席 (Economy)</option>
                    <option value="BUSINESS" id="optPremium" disabled>ビジネスクラス (Sapphire以上)</option>
                    <option value="FIRST" id="optFirst" disabled>ファーストクラス (Diamond限定)</option>
                </select>
            </div>
            <div class="form-group">
                <label>区間選択</label>
                <div style="display:flex; gap:10px; align-items: center;">
                    <div style="flex:1"><label style="font-size:0.6rem">FROM</label><select id="fromSelect"></select></div>
                    <div style="color:var(--ana-blue-sky)">✈</div>
                    <div style="flex:1"><label style="font-size:0.6rem">TO</label><select id="toSelect"></select></div>
                </div>
            </div>
            <div class="form-group">
                <label>スケジュール</label>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label style="font-size:0.6rem">出発時刻</label><input type="time" id="timeInput"></div>
                    <div style="flex:1"><label style="font-size:0.6rem">所要時間 (分)</label><input type="number" id="durationInput" value="60"></div>
                </div>
            </div>
            <div class="form-group" onclick="openSeatMap()" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                <div><label>座席指定</label><span id="seatLabel" style="font-weight:bold; color:var(--ana-blue-main);">未指定</span></div>
                <div style="color:var(--ana-blue-sky)">選択 &gt;</div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-save" onclick="saveFlight()">予約確定</button></div>
    </div>
</div>

<div id="airportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header-ana"><strong>マイ空港設定</strong><span onclick="closeModal('airportModal')" style="cursor:pointer; font-size:1.5rem">×</span></div>
        <div class="modal-body">
            <div class="form-group">
                <div style="display:flex; gap:10px;"><input type="text" id="newAirportCode" placeholder="3レター" maxlength="3" style="flex:1; text-transform:uppercase;"><input type="text" id="newAirportName" placeholder="名称" style="flex:2;"></div>
                <button class="btn btn-add" onclick="addAirport()">追加登録</button>
            </div>
            <ul class="airport-list" id="airportListUi"></ul>
        </div>
    </div>
</div>

<div id="seatModal" class="modal">
    <div class="modal-content" style="height:90vh;">
        <div class="modal-header-ana"><strong>座席指定</strong><span onclick="confirmSeat()" style="cursor:pointer">決定</span></div>
        <div class="modal-body" style="background: #dce1e6;">
            <div class="plane-wrapper" id="planeWrapper"><div class="wing-left"></div><div class="wing-right"></div><div class="fuselage"><div class="cockpit"></div></div><div class="seat-map-container" id="seatGrid"></div></div>
        </div>
    </div>
</div>

<script>
    const defaultAirports = [{code: 'HME', name: '自宅'}, {code: 'WRK', name: '仕事'}, {code: 'CFE', name: 'カフェ'}];
    let airports = JSON.parse(localStorage.getItem('my_airports') || JSON.stringify(defaultAirports));
    let flights = JSON.parse(localStorage.getItem('ana_flights_final') || '[]');
    let tempSeat = null;

    // --- Status & Mile Logic ---
    function getStatusInfo() {
        const total = flights.reduce((acc, f) => getStatus(f) === 'ARRIVED' ? acc + (f.duration || 0) : acc, 0);
        let status = 'BRONZE';
        if (total >= 3000) status = 'DIAMOND';
        else if (total >= 1000) status = 'SAPPHIRE';
        return { total, status };
    }

    function updateHeader() {
        const info = getStatusInfo();
        document.getElementById('totalMiles').innerText = info.total.toLocaleString();
        const label = document.getElementById('statusLabel');
        label.innerText = info.status;
        label.className = 'status-badge-header st-' + info.status;

        // クラス制限の更新
        document.getElementById('optPremium').disabled = info.total < 1000;
        document.getElementById('optFirst').disabled = info.total < 3000;
    }

    // --- Core Logic ---
    function getStatus(f) {
        const now = new Date();
        const [h, m] = f.time.split(':').map(Number);
        const dep = new Date(); dep.setHours(h, m, 0, 0);
        const arr = new Date(dep.getTime() + f.duration * 60000); 

        if (now > dep && !f.checkedIn) return 'NOSHOW';
        if (now > arr) return 'ARRIVED';
        if (now > dep && f.checkedIn) return 'INFLIGHT';
        return f.checkedIn ? 'CHECKEDIN' : 'RESERVED';
    }

    function isCheckInOpen(f) {
        const now = new Date();
        const [h, m] = f.time.split(':').map(Number);
        const dep = new Date(); dep.setHours(h, m, 0, 0);
        const openTime = new Date(dep.getTime() - 10 * 60000); // 10分前
        return now >= openTime && now <= dep;
    }

    function render() {
        updateHeader();
        const list = document.getElementById('flightList');
        if(flights.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px">予約がありません</div>';
            return;
        }
        flights.sort((a,b) => a.time.localeCompare(b.time));

        list.innerHTML = flights.map(f => {
            const status = getStatus(f);
            const canCheckIn = isCheckInOpen(f);
            const isNoShow = status === 'NOSHOW';
            
            const [h, m] = f.time.split(':').map(Number);
            const depDate = new Date(); depDate.setHours(h, m, 0, 0);
            const arrDate = new Date(depDate.getTime() + f.duration * 60000);
            const arrTimeStr = arrDate.getHours().toString().padStart(2,'0') + ':' + arrDate.getMinutes().toString().padStart(2,'0');

            return `
                <div class="flight-card">
                    ${isNoShow ? '<div class="noshow-overlay"><div class="noshow-stamp">NO SHOW</div></div>' : ''}
                    <div class="card-inner">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span class="status-badge badge-${status.toLowerCase()}">${status}</span>
                            <span style="font-size:0.8rem; color:#999">#${String(f.id).slice(-4)}</span>
                        </div>
                        <div class="route-row">
                            <div class="city-box"><div class="city-code">${f.from}</div><div class="city-name">${f.fromName}</div></div>
                            <div style="color:var(--ana-blue-sky)">✈</div>
                            <div class="city-box"><div class="city-code">${f.to}</div><div class="city-name">${f.toName}</div></div>
                        </div>
                        <div class="time-row">
                            <div class="time-box"><div class="time-label">DEP</div><div class="time-value">${f.time}</div></div>
                            <div class="duration-center">⎯ ${f.duration}min ⎯</div>
                            <div class="time-box"><div class="time-label">ARR</div><div class="time-value">${arrTimeStr}</div></div>
                        </div>
                        ${status === 'ARRIVED' ? `<div class="mile-tag">+${f.duration} MILES</div>` : ''}
                        ${(status === 'RESERVED') ? `
                            <button class="btn btn-checkin ${!canCheckIn ? 'btn-disabled' : ''}" 
                                    onclick="${canCheckIn ? `doCheckIn(${f.id})` : ''}">
                                ${canCheckIn ? 'オンラインチェックイン' : 'チェックイン開始までお待ちください'}
                            </button>
                        ` : ''}
                    </div>
                    ${(f.checkedIn && status !== 'ARRIVED' && !isNoShow) ? `
                        <div class="boarding-pass">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div><div style="font-size:0.7rem; color:#666">SEAT</div><div style="font-size:1.5rem; font-weight:bold; color:var(--ana-blue-main)">${f.seat}</div></div>
                                <div><div style="font-size:0.7rem; color:#666">CLASS</div><div style="font-size:1rem; font-weight:bold;">${f.boardingClass || 'ECONOMY'}</div></div>
                                <div style="text-align:right"><div style="font-size:0.7rem; color:#666">GROUP</div><div style="font-size:1.2rem; font-weight:bold;">3</div></div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    // --- Interaction Logic (Restored) ---
    function saveFlight() {
        const fromCode = document.getElementById('fromSelect').value;
        const toCode = document.getElementById('toSelect').value;
        const fromAp = airports.find(a => a.code === fromCode);
        const toAp = airports.find(a => a.code === toCode);
        const f = {
            id: Date.now(),
            from: fromCode, fromName: fromAp ? fromAp.name : '',
            to: toCode, toName: toAp ? toAp.name : '',
            time: document.getElementById('timeInput').value,
            duration: parseInt(document.getElementById('durationInput').value) || 60,
            seat: tempSeat || 'ANY',
            boardingClass: document.getElementById('classSelect').value,
            checkedIn: false
        };
        if(!f.time) return alert('出発時刻を入力してください');
        flights.push(f);
        localStorage.setItem('ana_flights_final', JSON.stringify(flights));
        closeModal('newFlightModal');
        render();
    }

    function doCheckIn(id) {
        flights = flights.map(f => f.id === id ? {...f, checkedIn: true} : f);
        localStorage.setItem('ana_flights_final', JSON.stringify(flights));
        render();
    }

    // Modal/UI Helpers
    function openNewFlightModal() { tempSeat = null; document.getElementById('seatLabel').innerText = '未指定'; updateHeader(); updateSelectOptions(); document.getElementById('newFlightModal').style.display = 'block'; }
    function openAirportModal() { renderAirportList(); document.getElementById('airportModal').style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openSeatMap() { initSeatMap(); document.getElementById('seatModal').style.display = 'block'; }
    function confirmSeat() { if(tempSeat) document.getElementById('seatLabel').innerText = tempSeat; closeModal('seatModal'); }
    function updateSelectOptions() {
        const html = airports.map(a => `<option value="${a.code}">${a.code} - ${a.name}</option>`).join('');
        document.getElementById('fromSelect').innerHTML = html;
        document.getElementById('toSelect').innerHTML = html;
        if(airports.length > 1) document.getElementById('toSelect').selectedIndex = 1;
    }
    function renderAirportList() {
        document.getElementById('airportListUi').innerHTML = airports.map((a, i) => `<li class="airport-item"><span class="airport-code-tag">${a.code}</span><strong>${a.name}</strong><button class="delete-btn" onclick="deleteAirport(${i})">×</button></li>`).join('');
    }
    function addAirport() {
        const c = document.getElementById('newAirportCode').value.toUpperCase();
        const n = document.getElementById('newAirportName').value;
        if(c && n) { airports.push({code:c, name:n}); localStorage.setItem('my_airports', JSON.stringify(airports)); renderAirportList(); }
    }
    function deleteAirport(i) { airports.splice(i, 1); localStorage.setItem('my_airports', JSON.stringify(airports)); renderAirportList(); }
    function initSeatMap() {
        const grid = document.getElementById('seatGrid'); grid.innerHTML = '';
        for (let r = 1; r <= 15; r++) {
            const row = document.createElement('div'); row.className = 'seat-row';
            ['A','B','C'].forEach(c => createSeat(row, r, c));
            const aisle = document.createElement('div'); aisle.className='aisle-gap'; aisle.innerText=r; row.appendChild(aisle);
            ['H','J','K'].forEach(c => createSeat(row, r, c));
            grid.appendChild(row);
        }
    }
    function createSeat(container, r, c) {
        const s = document.createElement('div'); s.className = 'seat'; s.innerText = c;
        s.onclick = () => { document.querySelectorAll('.seat').forEach(x=>x.classList.remove('selected')); s.classList.add('selected'); tempSeat = r+c; };
        container.appendChild(s);
    }

    render();
    setInterval(render, 15000);

    function initSeatMap() {
        const grid = document.getElementById('seatGrid'); 
        grid.innerHTML = '';
        const selectedClass = document.getElementById('classSelect').value;

        for (let r = 1; r <= 20; r++) {
            // 列ごとのクラス判定
            let rowClass = 'ECONOMY';
            if (r <= 2) rowClass = 'FIRST';
            else if (r <= 7) rowClass = 'BUSINESS';

            const isLocked = (rowClass !== selectedClass);

            const row = document.createElement('div'); 
            row.className = 'seat-row';
            if (isLocked) row.style.opacity = "0.3"; // 選択不可の列を薄くする

            // 左側座席
            ['A','B','C'].forEach(c => createSeat(row, r, c, isLocked, rowClass));
            
            // 通路
            const aisle = document.createElement('div'); 
            aisle.className='aisle-gap'; 
            aisle.innerText = r; 
            row.appendChild(aisle);
            
            // 右側座席
            ['H','J','K'].forEach(c => createSeat(row, r, c, isLocked, rowClass));
            
            grid.appendChild(row);
        }
    }

    function createSeat(container, r, c, isLocked, rowClass) {
        const s = document.createElement('div'); 
        s.className = 'seat'; 
        s.innerText = c;
        
        // クラスに応じた色分け（視認性向上）
        if (rowClass === 'FIRST') s.style.borderColor = "var(--diamond)";
        if (rowClass === 'BUSINESS') s.style.borderColor = "var(--ana-blue-sky)";

        if (isLocked) {
            s.style.cursor = 'not-allowed';
            s.style.background = '#ddd';
        } else {
            s.onclick = () => { 
                document.querySelectorAll('.seat').forEach(x => x.classList.remove('selected')); 
                s.classList.add('selected'); 
                tempSeat = r + c; 
            };
        }
        container.appendChild(s);
    }
</script>

</body>
</html>
