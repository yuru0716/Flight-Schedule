<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#002D5A">
    <title>Flight Schedule</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root {
            /* JAL-like Blue Theme (Solid & Sharp) */
            --ana-blue-dark: #002D5A;
            /* Deep Navy */
            --ana-blue-main: #002D5A;
            /* Primary Brand Color */
            --ana-blue-sky: #0055A4;
            /* Brighter accent blue */
            --ana-gradient: #002D5A;
            /* Solid color, no gradient */
            --bg-gray: #f2f2f2;
            /* Lighter, starker gray */
            --plane-body: #ffffff;
            --plane-wing: #dce1e6;
            --text-main: #111111;
            /* Darker black for high contrast */
            --danger: #d93025;
            --success: #1e8e3e;
            --gold: #c5a065;
            --diamond: #b9f2ff;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #001a3a 0%, #003366 40%, #004c99 100%);
            color: white;
            padding: 16px 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0, 20, 60, 0.25);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-left {
            display: flex;
            flex-direction: column;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 0.03em;
        }

        .mile-display {
            font-size: 0.75rem;
            color: var(--gold);
            font-weight: bold;
            margin-top: 3px;
            letter-spacing: 0.05em;
        }

        .status-badge-header {
            font-size: 0.6rem;
            padding: 1px 5px;
            border-radius: 3px;
            margin-left: 5px;
            vertical-align: middle;
        }

        .st-BRONZE {
            background: #cd7f32;
            color: white;
        }

        .st-SAPPHIRE {
            background: #0f52ba;
            color: white;
        }

        .st-DIAMOND {
            background: var(--diamond);
            color: #004482;
        }

        .header-icon {
            font-size: 1.5rem;
            cursor: pointer;
        }

        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        /* Flight Card */
        /* Flight Card */
        /* Flight Card */
        .flight-card {
            background: white;
            border-radius: 12px;
            /* Adding roundness back */
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            /* Softer, deeper shadow */
            position: relative;
            overflow: hidden;
            border-left: 6px solid var(--ana-blue-main);
        }

        .noshow-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            pointer-events: none;
        }

        .noshow-stamp {
            border: 4px solid var(--danger);
            color: var(--danger);
            padding: 10px 30px;
            font-size: 2rem;
            font-weight: 900;
            transform: rotate(-15deg);
            border-radius: 8px;
            background: white;
        }

        .card-inner {
            padding: 15px;
        }

        .route-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .city-box {
            text-align: center;
            width: 80px;
        }

        .city-code {
            font-size: 2rem;
            font-weight: 800;
            color: var(--ana-blue-dark);
            letter-spacing: 1px;
            line-height: 1;
        }

        .city-name {
            font-size: 0.7rem;
            color: #777;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .time-row {
            display: flex;
            justify-content: space-between;
            background: #f4f7fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .time-box {
            text-align: center;
            flex: 1;
        }

        .time-label {
            font-size: 0.7rem;
            color: #666;
            font-weight: bold;
        }

        .time-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .duration-center {
            font-size: 0.8rem;
            color: #999;
            align-self: center;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 2px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            background: #999;
        }

        .badge-reserved {
            background: var(--ana-blue-sky);
        }

        .badge-checkin {
            background: var(--success);
        }

        .badge-noshow {
            background: var(--danger);
        }

        .badge-inflight {
            background: var(--ana-blue-main);
            animation: pulse 2s infinite;
        }

        .badge-arrived {
            background: var(--gold);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .boarding-pass {
            background: #f9f9f9;
            border-top: 1px dashed #ddd;
            padding: 12px;
            font-size: 0.8rem;
        }

        .mile-tag {
            color: var(--gold);
            font-weight: bold;
            font-size: 0.7rem;
            text-align: right;
            margin-top: 5px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 45, 90, 0.85);
            z-index: 1000;
            z-index: 1000;
            backdrop-filter: blur(5px);
            /* Flex centering */
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #fff;
            width: 95%;
            max-width: 550px;
            /* Slightly wider */
            height: auto;
            min-height: 45vh;
            /* Reduced height */
            max-height: 85vh;
            /* Keep some margin at bottom */
            margin: auto;
            /* Move lower */
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header-ana {
            background: var(--ana-blue-main);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .modal-footer {
            background: white;
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        /* Inputs */
        .form-group {
            margin-bottom: 15px;
            background: white;
            padding: 15px;
            border-radius: 2px;
            border: 1px solid #eee;
        }

        .form-group label {
            display: block;
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 8px;
        }

        select,
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 2px;
            box-sizing: border-box;
            font-size: 1rem;
            background: #fff;
            -webkit-appearance: none;
            appearance: none;
        }

        /* Settings List */
        .airport-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .airport-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 2px;
            border-left: 4px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .airport-code-tag {
            background: var(--ana-blue-sky);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 10px;
        }

        .delete-btn {
            color: var(--danger);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Improved Seat Map */
        .plane-wrapper {
            position: relative;
            width: 320px;
            /* Slightly wider */
            margin: 30px auto;
            padding-top: 80px;
            padding-bottom: 80px;
            /* No more external shapes, we will style the container itself as the fuselage interior */
        }

        .fuselage {
            background: #fdfdfd;
            width: 100%;
            height: 100%;
            border-radius: 150px 150px 90px 90px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            box-shadow:
                0 20px 50px rgba(0, 0, 0, 0.15),
                inset 0 0 40px rgba(0, 0, 0, 0.05);
            /* Inner shadow for depth */
            border: 8px solid #eee;
            /* Thicker walls */
        }

        .cockpit {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 35px;
            background: linear-gradient(180deg, #333, #555);
            border-radius: 8px 8px 40% 40%;
            z-index: 2;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid #aaa;
        }

        .wing-left,
        .wing-right {
            display: none;
            /* Simplify visuals inside modal */
        }

        .seat-map-container {
            position: relative;
            z-index: 10;
            padding: 20px 14px;
        }

        .seat-row {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 12px;
            /* More legroom visually */
            align-items: center;
        }

        .row-number {
            width: 20px;
            font-size: 0.7rem;
            color: #aaa;
            text-align: center;
            font-weight: bold;
        }

        .aisle-gap {
            width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #ccc;
        }

        .seat {
            width: 38px;
            height: 48px;
            border: none;
            border-radius: 6px 6px 10px 10px;
            /* Chair shape */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            box-shadow:
                0 4px 6px rgba(0, 0, 0, 0.05),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1);
            /* Bottom thickness */
            position: relative;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        /* Headrest */
        .seat::before {
            content: '';
            position: absolute;
            top: -4px;
            width: 80%;
            height: 8px;
            background: inherit;
            border-radius: 4px;
            opacity: 0.8;
        }

        .seat:active {
            transform: scale(0.95);
        }

        .seat.selected {
            background: var(--ana-blue-main);
            color: white;
            box-shadow:
                0 4px 10px rgba(0, 45, 90, 0.3),
                inset 0 -3px 0 rgba(0, 0, 0, 0.2);
        }

        /* Class specific seat colors */
        .seat-first {
            background: #fffcf0;
            border: 1px solid #e3c880;
            color: #8a6d3b;
        }

        .seat-business {
            background: #f0f8ff;
            border: 1px solid #bce0fd;
            color: #31708f;
        }

        .seat-economy {
            background: #fff;
            border: 1px solid #ddd;
            color: #555;
        }

        .seat.selected.seat-first {
            background: #d4af37;
            color: white;
            border-color: transparent;
        }

        .seat.selected.seat-business {
            background: #0055A4;
            color: white;
            border-color: transparent;
        }


        /* Buttons */
        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            /* Softer buttons */
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .btn:active {
            transform: scale(0.98);
            box-shadow: none;
        }

        .btn-save {
            background: var(--ana-blue-dark);
            color: white;
        }

        .btn-add {
            background: var(--success);
            color: white;
            margin-top: 10px;
        }

        .btn-checkin {
            background: var(--success);
            color: white;
            padding: 10px;
            border-radius: 2px;
            margin-top: 10px;
            width: 100%;
        }

        .btn-disabled {
            background: #ccc !important;
            cursor: not-allowed;
        }

        .fab {
            position: fixed;
            bottom: 30px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: var(--ana-blue-main);
            color: white;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: none;
            cursor: pointer;
            z-index: 90;
        }

        .in-app-banner {
            position: fixed;
            top: -100px;
            left: 0;
            width: 100%;
            background: var(--ana-blue-main);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
        }

        .in-app-banner.show {
            top: 0;
        }

        .swipe-container {
            position: relative;
            width: 100%;
            height: 50px;
            background: #eee;
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .swipe-handle {
            position: absolute;
            left: 0;
            top: 0;
            width: 60px;
            height: 50px;
            background: var(--ana-blue-main);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            z-index: 10;
            cursor: grab;
            touch-action: none;
        }

        /* 切り離しアニメーション */
        .stub-tear {
            animation: tear-off 0.6s forwards ease-out;
        }

        @keyframes tear-off {
            0% {
                transform: rotate(0deg) translateY(0);
                opacity: 1;
            }

            30% {
                transform: rotate(5deg) translateY(10px);
                opacity: 1;
            }

            100% {
                transform: rotate(15deg) translateY(100px);
                opacity: 0;
            }
        }

        /* タブメニュー全体のスタイル */
        .tab-container {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 60px;
            /* ヘッダーの高さに合わせて調整 */
            z-index: 99;
            /* ヘッダー(100)のすぐ下 */
        }

        .tab-btn {
            flex: 1;
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--ana-blue-main);
            border-bottom: 3px solid var(--ana-blue-main);
            background: rgba(0, 45, 90, 0.05);
        }

        /* 過去のチケット用スタイル */
        .flight-card.history {
            border-top: 4px solid #999;
            /* 履歴は青ではなくグレーの線に */
        }

        /* 履歴カード内の特定の要素だけを白黒・薄くする */
        .flight-card.history .city-code,
        .flight-card.history .time-value,
        .flight-card.history .route-row,
        .flight-card.history .time-row {
            filter: grayscale(1);
            opacity: 0.6;
        }

        .boarding-pass {
            background: white;
            color: #333;
            border-radius: 2px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 1px solid #eee;
        }

        /* 2次元バーコード（ダミー） */
        .qr-placeholder {
            width: 140px;
            height: 140px;
            background: #f5f5f5;
            margin: 10px auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 2px;
        }

        /* 情報表示レイアウト */
        .pass-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* 2列にして大きく見せる */
            gap: 20px;
            text-align: center;
            border-top: 1px dashed #ccc;
            padding-top: 20px;
        }

        .pass-label {
            font-size: 0.65rem;
            color: #888;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .pass-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #000;
        }

        /* グループ番号の強調 */
        .group-badge {
            background: #000;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .seat-highlight {
            font-size: 2.5rem;
            /* かなり大きく */
            font-weight: bold;
            color: var(--ana-blue-main);
            line-height: 1;
            margin: 10px 0;
        }

        /* 搭乗券のコンテナ（最初は隠す） */
        .boarding-pass-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 開いた時の状態 */
        .boarding-pass-container.open {
            max-height: 500px;
            /* 十分な高さを指定 */
        }

        /* 開閉ボタンのスタイル */
        .toggle-pass-btn {
            width: 100%;
            background: #f8f9fa;
            border: 1px dashed var(--ana-blue-main);
            color: var(--ana-blue-main);
            padding: 10px;
            border-radius: 2px;
            margin-top: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .toggle-pass-btn::after {
            content: '▼';
            font-size: 0.6rem;
            transition: transform 0.3s;
        }

        .toggle-pass-btn.active::after {
            transform: rotate(180deg);
        }

        .focus-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            /* 背景を少しぼかす */
            z-index: 900;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
        }

        .focus-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* 搭乗券がフォーカスされた時の強調 */
        .boarding-pass-container.open {
            position: relative;
            z-index: 1000;
            /* 暗幕より上に表示 */
        }

        .boarding-pass-container.open .boarding-pass {
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
            /* ほんの少しだけ大きくして浮遊感を出す */
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 15px 0;
            position: relative;
            overflow: visible;
        }

        /* 実際に伸びるバー */
        .progress-bar {
            height: 100%;
            background: var(--ana-gradient);
            border-radius: 3px;
            transition: width 1s linear;
        }

        /* バーの先端で飛ぶ飛行機アイコン */
        .progress-plane {
            position: absolute;
            top: -8px;
            transform: translateX(-50%);
            font-size: 1.2rem;
            transition: left 1s linear;
        }

        /* 進捗バーと一緒に <style> に追加 */
        .pulse {
            color: #e60012;
            /* ANAの機材トラブル表示ではなく、ライブ状態を示す赤 */
            animation: blink 1.5s infinite;
            margin-right: 4px;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 1;
            }
        }

        /* 時間帯ごとの背景パターン */
        .bg-day {
            background: linear-gradient(135deg, #4da3ff 0%, #0056b3 100%);
        }

        /* 昼：青空 */
        .bg-sunset {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
        }

        /* 夕方：茜色 */
        .bg-night {
            background: linear-gradient(135deg, #001f3f 0%, #000814 100%);
        }

        /* 夜：星空 */
        .bg-dawn {
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
        }

        /* 明け方：薄明 */

        /* カードの文字が見やすいように調整 */
        .flight-card.dynamic-bg {
            color: white !important;
            border: none !important;
        }

        .flight-card.dynamic-bg .city-code,
        .flight-card.dynamic-bg .time-value {
            color: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            /* 影を少し強めて視認性アップ */
            font-weight: 800;
        }

        .flight-card.dynamic-bg .city-name,
        .flight-card.dynamic-bg .time-label,
        .flight-card.dynamic-bg .duration-center {
            color: rgba(255, 255, 255, 0.85) !important;
        }

        .flight-card.dynamic-bg .time-row {
            background: rgba(255, 255, 255, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 進捗バーの背景も少し白くして見やすくする */
        .flight-card.dynamic-bg .progress-container {
            background: rgba(255, 255, 255, 0.25) !important;
        }

        .flight-card.dynamic-bg .progress-plane {
            color: #ffffff;
        }

        /* チェックイン後のメインエリア（縦並び） */
        .flight-main-content {
            display: flex;
            flex-direction: column;
            /* 縦並びに設定 */
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
        }

        /* 表面の窓スタイル */
        .card-window-wrapper {
            width: 60px;
            height: 80px;
            background: #000;
            border: 4px solid #e0e0e0;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* シェード（初期は半分閉じ） */
        .card-window-shade {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            background: linear-gradient(to bottom, #d1d1d1, #a0a0a0);
            border-bottom: 2px solid #777;
            z-index: 5;
            transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 飛行中にシェードを開ける */
        .status-inflight .card-window-shade {
            transform: translateY(-100%);
        }

        /* 雲の動き */
        .cloud-particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            filter: blur(4px);
            opacity: 0.5;
            animation: particles-move 15s linear infinite;
        }

        @keyframes particles-move {
            from {
                transform: translateX(80px);
            }

            to {
                transform: translateX(-60px);
            }
        }

        /* 表面の窓スタイル */
        .card-window-wrapper {
            width: 60px;
            height: 80px;
            background: #000;
            border: 4px solid #e0e0e0;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .card-window-shade {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            background: linear-gradient(to bottom, #d1d1d1, #a0a0a0);
            border-bottom: 2px solid #777;
            z-index: 5;
            transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* INFLIGHT状態の時だけシェードを上げる */
        .dynamic-bg.bg-inflight .card-window-shade,
        .dynamic-bg[class*="status-inflight"] .card-window-shade {
            transform: translateY(-100%);
        }

        /* 空の色 */
        .sky-morning {
            background: linear-gradient(to bottom, #4a90e2, #f5a623);
        }

        .sky-day {
            background: linear-gradient(to bottom, #1e90ff, #87ceeb);
        }

        .sky-evening {
            background: linear-gradient(to bottom, #2c3e50, #ff7e5f);
        }

        .sky-night {
            background: linear-gradient(to bottom, #00000c, #000050);
        }

        .card-window-shade {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #d1d1d1, #a0a0a0);
            border-bottom: 3px solid #777;
            z-index: 5;
            /* 1秒かけて動く設定 */
            transition: transform 1.0s cubic-bezier(0.45, 0.05, 0.55, 0.95);
            transform: translateY(-100%);
            /* 基本は開いている */
        }

        /* 窓の中の景色（地上と空の切り替え用） */
        .window-view-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        /* 地上の景色の簡易表現 */
        .ground-view {
            background: linear-gradient(to bottom, #87ceeb 0%, #87ceeb 50%, #91b33e 50%, #91b33e 100%);
            width: 100%;
            height: 100%;
        }

        /* フォーカスモード用のスタイル */
        .focus-active body {
            overflow: hidden;
            /* スクロール禁止 */
        }

        .focus-overlay-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .focus-overlay-screen.active {
            display: flex;
            animation: fadeIn 0.8s ease;
        }

        .focus-exit-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .runway-loader {
            width: 80%;
            max-width: 400px;
            height: 30px;
            border-bottom: 2px dashed rgba(255, 255, 255, 0.3);
            position: relative;
            margin: 20px auto;
        }

        .plane-icon-progress {
            position: absolute;
            bottom: -10px;
            font-size: 1.5rem;
            transition: left 1s linear;
        }

        /* アナウンスのテロップ風アニメーション */
        .announcement-bar {
            background: rgba(0, 68, 130, 0.8);
            color: white;
            padding: 10px;
            width: 100%;
            position: absolute;
            top: 80px;
            font-size: 0.8rem;
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
        }

        /* 雲の流れるアニメーション */
        @keyframes cloudFlow {
            from {
                left: 120%;
            }

            to {
                left: -120%;
            }
        }

        .real-cloud {
            position: absolute;
            width: 100px;
            height: 30px;
            background: #fff;
            border-radius: 50%;
            filter: blur(8px);
            opacity: 0.8;
            animation: cloudFlow linear infinite;
            box-shadow:
                /* 複数の円をずらして重ねることでモコモコ感を出す */
                40px 10px 0 10px #fff,
                -30px 5px 0 5px #fff,
                15px -15px 0 15px #fff;
        }

        /* 夜間用の雲の色調整（オプション） */
        .focus-active .real-cloud {
            background: #ccddee;
            /* 少し青みがかった白 */
        }

        /* 外枠：機体の壁面 */
        .window-outer-frame {
            width: 320px;
            height: 440px;
            margin: 0 auto;
            /* 航空機の内壁のようなオフホワイト */
            background: #f1f3f5;
            border-radius: 130px;
            padding: 20px;
            /* 窓が壁に埋め込まれているような深みのある影 */
            box-shadow:
                0 30px 60px rgba(0, 0, 0, 0.3),
                inset 0 2px 10px rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #d1d5db;
        }

        /* 窓枠の内側：奥行き */
        .window-inner-frame {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 105px;
            border: 10px solid #cbd5e1;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 10px 30px rgba(0, 0, 0, 0.5);
            cursor: pointer;
        }

        /* シェード：色をハッキリさせ、手前に配置 */
        #window-shade {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            /* ★ここが修正ポイント：模様とグラデーションを1行で重ねる */
            background-image:
                /* 1層目：蛇腹のテクスチャ（隙間が透明） */
                repeating-linear-gradient(0deg,
                    rgba(255, 255, 255, 0.9) 0px,
                    rgba(255, 255, 255, 0.9) 1px,
                    transparent 1px,
                    transparent 15px),
                /* 2層目：ベースの色（不透明なグラデーション） */
                linear-gradient(to bottom, #f3f4f6 0%, #d1d5db 100%) !important;

            /* 万が一画像が読み込めない場合の不透明色 */
            background-color: #f3f4f6 !important;

            /* 景色の手前に表示 */
            z-index: 10 !important;

            /* アニメーション設定 */
            transition: transform 1.2s cubic-bezier(0.45, 0.05, 0.55, 0.95);
            transform: translateY(-100%);
            /* 初期状態は上（開いている） */

            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 25px;
            pointer-events: none;
            /* クリックを親要素に通す */
        }

        /* シェードが閉じた状態 */
        #window-shade.shade-closed {
            transform: translateY(-5%) !important;
        }

        /* つまみ */
        .shade-handle {
            width: 70px;
            height: 8px;
            background: #6b7280;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        #focusModeScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            /* デフォルト：明るい機内の色 */
            background: radial-gradient(circle at center, #e6e9ed 0%, #bdc3c7 100%);

            /* 常にザラついた質感を出すための画像（あれば） */
            /* background-image: url('...'); */

            z-index: 9999;
            display: none;
            /* 通常は非表示 */
            flex-direction: column;
            align-items: center;
            justify-content: center;

            /* 色がゆっくり変わるようにアニメーションを設定 */
            transition: background 1.5s ease;
        }

        #focusContent::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            pointer-events: none;
            background-image: url('https://www.transparenttextures.com/patterns/asfalt-light.png');
        }

        #focusModeScreen.active {
            display: flex;
        }

        #focus-window-body {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8), 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #focus-timer-text {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9);
            background: rgba(0, 0, 0, 0.2);
            /* わずかに背景を暗くして浮かび上がらせる */
            padding: 5px 15px;
            border-radius: 10px;
            display: inline-block;
        }

        /* 飛行ルート（都市名）の強調 */
        .focus-route {
            font-size: 2.2rem;
            font-weight: bold;
            letter-spacing: 2px;
            margin-top: 30px;
            filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.7));
        }

        .info-glass-panel {
            background: rgba(0, 0, 0, 0.3);
            /* 薄い黒の背景 */
            backdrop-filter: blur(8px);
            /* ★ここが重要：背景をぼかす */
            -webkit-backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 20px;
            margin: 20px auto;
            width: 320px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* 文字にしっかりとした影を追加 */
        .focus-text-bold {
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
            font-weight: bold;
        }

        /* ルート情報の文字をさらに強調 */
        .focus-route {
            font-size: 2rem;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        /* タイマー文字のスタイル */
        #focus-timer-text {
            font-size: 1.6rem;
            color: #ffcc00;
            /* より視認性の高いゴールドイエロー */
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* モバイル対応：画面が小さい場合に要素を少し縮小する */
        @media screen and (max-height: 750px) {
            .window-outer-frame {
                transform: scale(0.75);
                /* 窓を75%に縮小 */
                margin: -30px auto !important;
            }

            .info-glass-panel {
                transform: scale(0.85);
                /* パネルを85%に縮小 */
                margin: 0 auto !important;
                padding: 15px !important;
            }

            #focus-window-body>div:first-child {
                margin-bottom: 5px !important;
                /* "CRUISING"の余白を詰める */
            }
        }

        /* さらに画面が小さい場合 */
        @media screen and (max-height: 600px) {
            .window-outer-frame {
                transform: scale(0.6);
            }

            .info-glass-panel {
                transform: scale(0.75);
            }
        }

        /* リアルな空のレイヤー */
        .sky.bg-day {
            background: linear-gradient(to bottom, #003366 0%, #0076cb 60%, #add8e6 100%);
        }

        .sky.bg-night {
            background: linear-gradient(to bottom, #00050a 0%, #001a33 70%, #003366 100%);
        }

        .sky.bg-morning {
            background: linear-gradient(to bottom, #001a33 0%, #4b0082 40%, #ff8c00 80%, #ffd700 100%);
        }

        .sky.bg-evening {
            background: linear-gradient(to bottom, #001a33 0%, #800080 30%, #ff4500 70%, #ff8c00 100%);
        }

        /* 窓の奥行き感を出すガラスの反射 */
        .window-frame::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 50%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
            border-radius: 40% 40% 45% 45%;
        }

        .focus-note-container {
            position: absolute;
            bottom: 40px;
            width: 80%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.9);
            /* 半透明の紙質 */
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .note-header {
            background: var(--ana-blue-dark);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            letter-spacing: 1px;
        }

        #focus-textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: none;
            background: repeating-linear-gradient(white, white 24px, #e5e5e5 25px);
            /* 罫線 */
            line-height: 25px;
            font-family: inherit;
            resize: none;
            color: var(--text-main);
            outline: none;
        }

        #toggle-note {
            background: transparent;
            border: 1px solid white;
            color: white;
            font-size: 10px;
            cursor: pointer;
            padding: 2px 5px;
        }

        /* 最小化状態 */
        .focus-note-container.minimized {
            height: 35px;
        }

        .focus-note-container.minimized #focus-textarea {
            display: none;
        }

        /* レイアウトの基本設定 */
        .focus-layout-container {
            display: flex;
            flex-direction: row;
            /* PCは横並び */
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            gap: 30px;
            padding: 20px;
        }

        .focus-window-area {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        #focus-note-panel {
            width: 350px;
            /* PCでの幅 */
            height: 500px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #focus-textarea-box {
            flex: 1;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        /* スマホ用スタイル (1024px以下) */
        @media screen and (max-width: 1024px) {
            .focus-layout-container {
                flex-direction: column;
            }

            #focus-note-panel {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                z-index: 10000;
                border-radius: 0;
                transform: translateY(100%);
                /* 最初は下に隠す */
                opacity: 0;
                display: none;
            }

            #focus-note-panel.memo-open {
                display: flex;
                transform: translateY(0);
                opacity: 1;
            }

            .mobile-memo-trigger {
                position: fixed;
                bottom: 100px;
                right: 20px;
                background: var(--ana-gradient);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 30px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                z-index: 9999;
            }

            .mobile-only-btn {
                background: white;
                color: var(--ana-blue-dark);
                border: none;
                padding: 5px 15px;
                border-radius: 20px;
                font-weight: bold;
            }
        }

        /* PCではスマホ用ボタンを隠す */
        @media screen and (min-width: 1025px) {

            .mobile-memo-trigger,
            .mobile-only-btn {
                display: none;
            }
        }

        /* レイアウトの外枠：中央寄せ用 */
        .focus-layout-outer {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .focus-layout-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 1000px;
            /* ここを調整して窓とメモの距離を縮める */
            gap: 40px;
            /* 窓とメモ帳の間の距離 */
            padding: 20px;
        }

        .focus-window-area {
            flex: 0 0 auto;
            /* 窓のサイズを固定気味にする */
        }

        #focus-note-panel {
            flex: 1;
            /* メモ帳が残りのスペースを埋める */
            max-width: 450px;
            /* メモ帳が大きくなりすぎないように */
            height: 500px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #focus-textarea-box {
            flex: 1;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            box-sizing: border-box;
        }

        /* スマホ用設定 (1024px以下) */
        @media screen and (max-width: 1024px) {
            .focus-layout-container {
                flex-direction: column;
                width: 100%;
                max-width: none;
                gap: 0;
            }

            #focus-note-panel {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                max-width: none;
                z-index: 10000;
                border-radius: 0;
                transform: translateY(100%);
                opacity: 0;
                display: none;
            }

            #focus-note-panel.memo-open {
                display: flex;
                transform: translateY(0);
                opacity: 1;
            }

            .mobile-memo-trigger {
                position: fixed;
                bottom: 40px;
                right: 20px;
                background: var(--ana-gradient);
                color: white;
                border: none;
                padding: 15px 25px;
                border-radius: 30px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
                z-index: 9999;
                font-weight: bold;
            }
        }

        /* PC用ボタン非表示 */
        @media screen and (min-width: 1025px) {

            .mobile-memo-trigger,
            .mobile-only-btn {
                display: none;
            }
        }

        /* --- ボトムメニュー用CSS --- */
        .my-app-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 75px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eeeeee;
            z-index: 9999;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .my-app-nav-link {
            text-decoration: none;
            color: #999999;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            flex: 1;
            transition: color 0.2s;
            cursor: pointer;
        }

        .my-app-nav-icon-text {
            font-size: 22px;
            margin-bottom: 2px;
        }

        .my-app-nav-link-center {
            position: relative;
        }

        .my-app-plus-circle {
            background-color: var(--ana-blue-main);
            color: #ffffff;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            margin-top: -35px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: transform 0.1s;
        }

        .my-app-plus-circle:active {
            transform: scale(0.92);
        }

        .my-app-nav-link-active {
            color: var(--ana-blue-main);
            font-weight: bold;
        }

        .board {
            background: rgba(5, 15, 30, 0.9);
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            font-size: 16px;
            backdrop-filter: blur(2px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow:
                0 0 0 1px rgba(0, 0, 0, 0.6),
                0 20px 40px rgba(0, 0, 0, 0.8);
        }

        /* 行アイテム */
        .board-row {
            display: grid;
            grid-template-columns: 1.3fr 0.8fr 0.8fr 1.1fr 1.8fr;
            gap: 6px;
            font-size: 1rem;
            /* ほんの少し小さめ */
            letter-spacing: 0.06em;
            line-height: 1.4;
            padding: 6px 10px;
        }

        /* 見出し行 */
        .board-row.header {
            color: #94a3b8;
            text-shadow: 0 0 4px rgba(148, 163, 184, 0.4);
            font-size: 0.85rem;
            letter-spacing: 0.08em;
        }

        /* 境目なし＋行間すっきり */
        .board-row:not(.header) {
            border-bottom: 1px solid #111;
        }

        /* 自分便は白く */
        .board-row:not(.external)>span {
            color: #fff;
        }

        /* 外部便は薄め */
        .board-row.external>span {
            color: #777;
        }

        /* 状態文字の強調 */
        .board-row span:nth-child(5) {
            font-weight: bold;
            text-align: right;
            letter-spacing: 0.08em;
        }

        /* 状態ごとの色 */
        .status-boarding {
            color: #22c55e;
            text-shadow: 0 0 6px rgba(34, 197, 94, 0.6);
        }

        .status-checkinopen {
            color: #38bdf8;
            text-shadow: 0 0 6px rgba(56, 189, 248, 0.6);
        }

        .status-lastcall {
            color: #fb7185;
            text-shadow: 0 0 6px rgba(251, 113, 133, 0.6);
        }

        .status-delayed {
            color: #f97316;
            text-shadow: 0 0 6px rgba(249, 115, 22, 0.6);
        }

        .status-scheduled {
            color: #eee;
        }

        /* ホバーで少し明るく */
        .board-row:hover:not(.header)>span {
            color: #fff;
        }

        .board-frame {
            background: linear-gradient(180deg,
                    #0b1d33 0%,
                    #050b14 100%);
        }

        .board-title {
            background: #1a1a1a;
            color: #ccc;
            font-size: 0.7rem;
            letter-spacing: 0.3em;
            text-align: center;
            padding: 6px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 6px;
        }

        .board,
        .board-frame,
        .board-row {
            border-radius: 0 !important;
        }

        .board-row span:nth-child(1) {
            color: #7dd3fc;
            /* 空色 */
            font-weight: bold;
        }

        .board-row span:nth-child(2),
        .board-row span:nth-child(3) {
            color: #e5e7eb;
        }

        .board-row span:nth-child(4) {
            color: #facc15;
            /* 黄 */
            font-weight: bold;
            font-size: 1.1rem;
        }

        .board-row:not(.header):hover {
            background: rgba(56, 189, 248, 0.05);
        }
    </style>
</head>

<body>
    <div id="scanModal" class="modal"
        style="display:none; position:fixed; z-index:5000; left:0; top:0; width:100%; height:100%; background:#000; flex-direction:column; align-items:center; justify-content:center;">
        <div style="color:white; margin-bottom:20px; font-weight:bold;">QRコードをスキャン</div>
        <div
            style="position:relative; width:80%; max-width:300px; aspect-ratio:1/1; border:2px solid var(--ana-blue-sky); border-radius:4px; overflow:hidden;">
            <video id="video" style="width:100%; height:100%; object-fit:cover;"></video>
            <div
                style="position:absolute; top:10%; left:10%; right:10%; bottom:10%; border:1px dashed rgba(255,255,255,0.5);">
            </div>
        </div>
        <button onclick="stopScan()"
            style="margin-top:30px; padding:12px 40px; border-radius:2px; border:none; background:white; color:black; font-weight:bold;">キャンセル</button>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>
    <audio id="cabinNoise" loop src="https://www.soundjay.com/transportation/airplane-cabin-white-noise-01.mp3"></audio>

    <div id="focusModeScreen" class="focus-overlay-screen">
        <button class="focus-exit-btn" onclick="exitFocusMode()">Exit</button>

        <div class="focus-layout-outer">
            <div class="focus-layout-container">
                <div id="focusContent" class="focus-window-area"></div>

                <div id="focus-note-panel" class="info-glass-panel">
                    <div class="memo-header">
                        <span class="focus-text-bold">INFLIGHT MEMO</span>
                        <button id="close-memo-mobile" class="mobile-only-btn"
                            onclick="toggleMobileMemo()">Done</button>
                    </div>
                    <textarea id="focus-textarea-box" placeholder="機内でのひらめきをメモ..."></textarea>
                </div>
            </div>
        </div>

        <button id="open-memo-mobile" class="mobile-memo-trigger" onclick="toggleMobileMemo()">
            ✎ Memo
        </button>
    </div>


    <nav class="my-app-bottom-nav">
        <a class="my-app-nav-link my-app-nav-link-active" onclick="switchTab('upcoming', this)">
            <span class="material-icons" class="my-app-nav-icon-text">flight_takeoff</span>
            <span>予定</span>
        </a>

        <a class="my-app-nav-link" onclick="switchTab('history', this)">
            <span class="material-icons" class="my-app-nav-icon-text">flight_land</span>
            <span>履歴</span>
        </a>

        <a class="my-app-nav-link my-app-nav-link-center" onclick="openNewFlightModal()">
            <div class="my-app-plus-circle">+</div>
            <span>予約</span>
        </a>

        <a class="my-app-nav-link" onclick="openAirportModal()">
            <span class="material-icons" class="my-app-nav-icon-text">settings</span>
            <span>設定</span>
        </a>

        <a class="my-app-nav-link" onclick="startScan()">
            <span class="material-icons" class="my-app-nav-icon-text">qr_code_scanner</span>
            <span>QR</span>
        </a>
    </nav>


    <div id="focusOverlay" class="focus-overlay" onclick="closeAllPasses()"></div>
    <div id="qrModal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()" style="text-align: center;">
            <h3 style="color: var(--ana-blue-main);">SHARE FLIGHT</h3>
            <p style="font-size: 0.8rem; color: #666;">このQRコードをスキャンして共有</p>
            <div id="qrcode" style="display: flex; justify-content: center; margin: 20px 0;"></div>
            <button onclick="document.getElementById('qrModal').style.display='none'"
                style="width: 100%; padding: 10px; background: #eee; border: none; border-radius: 8px;">閉じる</button>
        </div>
    </div>
    <header>
        <div class="header-left">
            <div class="header-title">Flight Schedule <span id="statusLabel" class="status-badge-header"></span></div>
            <div class="mile-display">✈ <span id="totalMiles">0</span> MILES</div>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div class="header-icon" onclick="toggleBoardMode()">🛫</div>
            <span id="notifBtn" onclick="requestNotification()"
                style="cursor:pointer; font-size:1.2rem; filter:grayscale(1);">🔔</span>
            <div class="header-icon" onclick="openAirportModal()">⚙️</div>
        </div>
        <div id="notifBanner" class="in-app-banner" onclick="hideBanner()">
            <span>✈</span> <span id="notifText">搭乗手続きが可能な便があります</span>
        </div>
    </header>
    <!-- Removed JAL button because we are changing the entire theme to JAL-like -->


    <div class="container" id="flightList"></div>



    <div id="newFlightModal" class="modal">
        <div class="modal-content"
            style="height: auto; min-height: 480px; transition: height 0.3s; background:#f9f9f9;">
            <div class="modal-header-ana">
                <strong id="modalTitle">フライト予約 (1/3)</strong>
                <span onclick="closeModal('newFlightModal')" style="cursor:pointer; font-size:1.5rem">×</span>
            </div>

            <div class="modal-body" style="position: relative; overflow-x: hidden; padding:20px;">
                <!-- Step 1: Route -->
                <div id="booking-step-1" class="booking-step-container">
                    <div class="form-group" style="padding:20px; border:none; box-shadow:none; background:transparent;">
                        <label
                            style="font-weight:bold; font-size:1.1rem; color:#333; margin-bottom:25px; display:block; text-align:center;">ご希望の区間を選択してください</label>
                        <div style="display:flex; flex-direction:column; gap:20px;">
                            <div
                                style="background:white; padding:15px; border-radius:4px; border-left:5px solid var(--ana-blue-main); box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                <label style="color:var(--ana-blue-main); font-weight:bold; font-size:0.8rem;">FROM
                                    (出発地)</label>
                                <select id="fromSelect"
                                    style="padding:10px; font-size:1.2rem; border:none; border-bottom:1px solid #ddd; outline:none; width:100%; font-weight:bold;"></select>
                            </div>
                            <div style="text-align:center; color:#ccc; font-size:1.5rem;">▼</div>
                            <div
                                style="background:white; padding:15px; border-radius:4px; border-left:5px solid var(--ana-blue-sky); box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                <label style="color:var(--ana-blue-sky); font-weight:bold; font-size:0.8rem;">TO
                                    (到着地)</label>
                                <select id="toSelect"
                                    style="padding:10px; font-size:1.2rem; border:none; border-bottom:1px solid #ddd; outline:none; width:100%; font-weight:bold;"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Schedule -->
                <div id="booking-step-2" class="booking-step-container" style="display:none;">
                    <div class="form-group" style="padding:20px; border:none; box-shadow:none; background:transparent;">
                        <label
                            style="font-weight:bold; font-size:1.1rem; color:#333; margin-bottom:20px; display:block; text-align:center;">日時を選択してください</label>

                        <div
                            style="background:white; padding:20px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:20px;">
                            <label style="font-size:0.8rem; color:#666; font-weight:bold;">DATE</label>
                            <input type="date" id="flightDate"
                                style="padding:10px; font-size:1.1rem; border:1px solid #eee; width:100%; margin-top:5px;">
                        </div>

                        <div style="display:flex; gap:15px;">
                            <div
                                style="flex:1; background:white; padding:20px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                <label style="font-size:0.8rem; color:#666; font-weight:bold;">TIME</label>
                                <input type="time" id="timeInput"
                                    style="padding:10px; font-size:1.1rem; border:1px solid #eee; width:100%; margin-top:5px;">
                            </div>
                            <div
                                style="flex:1; background:white; padding:20px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                <label style="font-size:0.8rem; color:#666; font-weight:bold;">MIN</label>
                                <input type="number" id="durationInput" value="60"
                                    style="padding:10px; font-size:1.1rem; border:1px solid #eee; width:100%; margin-top:5px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Seat & Class -->
                <div id="booking-step-3" class="booking-step-container" style="display:none;">
                    <div class="form-group" style="padding:10px; border:none; box-shadow:none; background:transparent;">
                        <label
                            style="font-weight:bold; font-size:1.1rem; color:#333; margin-bottom:20px; display:block; text-align:center;">座席・クラス指定</label>

                        <div
                            style="background:white; padding:15px; border-radius:4px; margin-bottom:20px; border-top: 3px solid #333;">
                            <label style="font-size:0.8rem; font-weight:bold; color:#333;">CLASS</label>
                            <select id="classSelect"
                                style="margin-top:10px; padding:10px; border:1px solid #eee; font-weight:bold;">
                                <option value="ECONOMY">普通席 (Economy)</option>
                                <option value="BUSINESS" id="optPremium" disabled>ビジネスクラス (Sapphire以上)</option>
                                <option value="FIRST" id="optFirst" disabled>ファーストクラス (Diamond限定)</option>
                            </select>
                        </div>

                        <div onclick="openSeatMap()"
                            style="border:1px dashed #999; padding:25px; border-radius:4px; text-align:center; cursor:pointer; background:white; transition:background 0.2s;">
                            <div style="font-size:0.8rem; color:#666; font-weight:bold;">SEAT SELECTION</div>
                            <div id="seatLabel"
                                style="font-size:2rem; font-weight:bold; color:var(--ana-blue-main); margin:10px 0; font-family:monospace;">
                                未指定</div>
                            <div
                                style="display:inline-block; background:var(--ana-blue-sky); color:white; padding:5px 15px; border-radius:20px; font-size:0.7rem; font-weight:bold;">
                                シートマップを開く</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer"
                style="display:flex; justify-content:space-between; gap:10px; padding:20px; background:white; border-top:1px solid #eee;">
                <button id="btn-back" class="btn" onclick="prevBookingStep()"
                    style="background:#e0e0e0; color:#333; width:30%; display:none; border-radius:2px;">戻る</button>
                <button id="btn-next" class="btn btn-save" onclick="nextBookingStep()"
                    style="width:100%; border-radius:2px;">次へ</button>
                <button id="btn-confirm" class="btn btn-save" onclick="saveFlight()"
                    style="width:100%; display:none; border-radius:2px; background:var(--danger);">予約を確定する</button>
            </div>
        </div>
    </div>

    <div id="airportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header-ana"><strong>マイ空港(やること)設定</strong><span onclick="closeModal('airportModal')"
                    style="cursor:pointer; font-size:1.5rem">×</span></div>
            <div class="modal-body">
                <div class="form-group">
                    <div style="display:flex; gap:10px;"><input type="text" id="newAirportCode" placeholder="3レター"
                            maxlength="3" style="flex:1; text-transform:uppercase;"><input type="text"
                            id="newAirportName" placeholder="名称" style="flex:2;"></div>
                    <button class="btn btn-add" onclick="addAirport()">追加登録</button>
                </div>
                <ul class="airport-list" id="airportListUi"></ul>
            </div>
        </div>
    </div>

    <div id="seatModal" class="modal">
        <div class="modal-content" style="height:90vh;">
            <div class="modal-header-ana"><strong>座席指定</strong><span onclick="confirmSeat()"
                    style="cursor:pointer">決定</span></div>
            <div class="modal-body" style="background: #dce1e6;">
                <div class="plane-wrapper" id="planeWrapper">
                    <div class="wing-left"></div>
                    <div class="wing-right"></div>
                    <div class="fuselage">
                        <div class="cockpit"></div>
                    </div>
                    <div class="seat-map-container" id="seatGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" style="
  position: fixed;
  top: -100px;
  left: 50%;
  transform: translateX(-50%);
  background: #002D5A;
  color: white;
  padding: 14px 20px;
  border-radius: 4px;
  font-weight: bold;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  transition: top 0.4s ease;
  z-index: 2000;
"></div>

    <script>
        const defaultAirports = [{ code: 'HME', name: '自宅' }, { code: 'WRK', name: '仕事' }, { code: 'CFE', name: 'カフェ' }];
        let airports = JSON.parse(localStorage.getItem('my_airports') || JSON.stringify(defaultAirports));
        let flights = JSON.parse(localStorage.getItem('ana_flights_final') || '[]');
        let externalFlights = [];
        const EXTERNAL_FLIGHT_TARGET = 12;
        let tempSeat = null;
        let notifiedFlights = new Set();
        let bannerShownFor = new Set();
        let boardMode = false;

        // スワイプ用変数
        let startX = 0;
        let currentX = 0;
        let isDragging = false;
        let currentTab = 'upcoming'; // タブ状態の管理

        const externalFlightsPool = [
            { airline: 'ANB', code: 'NH', from: 'HND', to: 'ITM' },
            { airline: 'ANB', code: 'NH', from: 'HND', to: 'NGO' },
            { airline: 'JAM', code: 'JL', from: 'HND', to: 'FUK' },
            { airline: 'JAM', code: 'JL', from: 'CTS', to: 'KIX' },
            { airline: 'JAM', code: 'JL', from: 'HND', to: 'FUK' },
            { airline: 'SKZ', code: 'BC', from: 'HND', to: 'CTS' },
            { airline: 'SKZ', code: 'BC', from: 'FUK', to: 'NRT' },
            { airline: 'Peaci', code: 'MM', from: 'NRT', to: 'OKA' },
            { airline: 'Jetstas', code: 'GK', from: 'NRT', to: 'KIX' },
            { airline: 'AIRDP', code: 'HD', from: 'HND', to: 'CTS' }
        ];
        const airportNameMap = {
            HND: '羽田',
            NRT: '成田',
            NGO: '中部',
            NKM: '小牧',
            ITM: '伊丹',
            KIX: '関西',
            CTS: '新千歳',
            FUK: '福岡',
            OKA: '那覇',
        }

        // --- Status & Mile Logic ---
        function getStatusInfo() {
            const total = flights.reduce((acc, f) => getStatus(f) === 'ARRIVED' ? acc + (f.duration || 0) : acc, 0);
            let status = 'BRONZE';
            if (total >= 3000) status = 'DIAMOND';
            else if (total >= 1000) status = 'SAPPHIRE';
            return { total, status };
        }

        function updateHeader() {
            const info = getStatusInfo();
            document.getElementById('totalMiles').innerText = info.total.toLocaleString();
            const label = document.getElementById('statusLabel');
            label.innerText = info.status;
            label.className = 'status-badge-header st-' + info.status;
            document.getElementById('optPremium').disabled = info.total < 1000;
            document.getElementById('optFirst').disabled = info.total < 3000;
        }

        function getStatus(f) {
            const now = new Date();
            // f.date (2026-02-03) と f.time (19:30) を組み合わせて Date オブジェクトを作成
            const [y, m, d] = (f.date || new Date().toISOString().split('T')[0]).split('-').map(Number);
            const [hh, mm] = f.time.split(':').map(Number);

            const dep = new Date(y, m - 1, d, hh, mm);
            const arr = new Date(dep.getTime() + (f.duration || 60) * 60000);

            if (now > arr) return 'ARRIVED';
            if (now > dep && !f.checkedIn) return 'NOSHOW';
            if (now > dep && f.checkedIn) return 'INFLIGHT';
            return f.checkedIn ? 'CHECKEDIN' : 'RESERVED';
        }

        function isCheckInOpen(f) {
            const now = new Date();
            const [y, m, d] = (f.date || new Date().toISOString().split('T')[0]).split('-').map(Number);
            const [hh, mm] = f.time.split(':').map(Number);

            const dep = new Date(y, m - 1, d, hh, mm);
            const openTime = new Date(dep.getTime() - 10 * 60000); // 10分前
            return now >= openTime && now <= dep;
        }

        // --- Tab Switching ---
        function switchTab(tab, el) {
            currentTab = tab;

            // すべてのボタンからアクティブ色を外す
            document.querySelectorAll('.my-app-nav-link').forEach(n => {
                n.classList.remove('my-app-nav-link-active');
            });

            // クリックされたボタンだけに色をつける
            if (el) {
                el.classList.add('my-app-nav-link-active');
            }

            // リストを再描画
            render();
        }

        // --- Swipe UI Logic ---
        function getCheckInUI(f, canCheckIn) {
            if (!canCheckIn) {
                return `<div class="swipe-container" style="opacity:0.5; background:#ccc; color:#666">出発10分前から受付開始</div>`;
            }
            return `
            <div class="swipe-container" id="swipeContainer-${f.id}">
                <div class="swipe-handle" 
                     onmousedown="handleSwipeStart(event, ${f.id})"
                     ontouchstart="handleSwipeStart(event, ${f.id})">✈</div>
                スワイプしてチェックイン
            </div>
        `;
        }

        function handleSwipeStart(e, id) {
            unlockAudio();
            startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            isDragging = true;
            const handle = e.target;
            handle.style.transition = 'none';

            const moveHandler = (ev) => handleSwipeMove(ev, id);
            const endHandler = () => {
                handleSwipeEnd(id);
                window.removeEventListener('mousemove', moveHandler);
                window.removeEventListener('touchmove', moveHandler);
                window.removeEventListener('mouseup', endHandler);
                window.removeEventListener('touchend', endHandler);
            };

            window.addEventListener('mousemove', moveHandler);
            window.addEventListener('touchmove', moveHandler, { passive: false });
            window.addEventListener('mouseup', endHandler);
            window.addEventListener('touchend', endHandler);
        }

        function handleSwipeMove(e, id) {
            if (!isDragging) return;
            if (e.cancelable) e.preventDefault();
            const container = document.getElementById(`swipeContainer-${id}`);
            const handle = container.querySelector('.swipe-handle');
            const maxMove = container.offsetWidth - handle.offsetWidth;
            const x = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            currentX = x - startX;
            if (currentX < 0) currentX = 0;
            if (currentX > maxMove) currentX = maxMove;
            handle.style.transform = `translateX(${currentX}px)`;
            container.style.background = `rgba(0, 68, 130, ${0.1 + (currentX / maxMove) * 0.2})`;
        }

        function handleSwipeEnd(id) {
            if (!isDragging) return;
            isDragging = false;
            const container = document.getElementById(`swipeContainer-${id}`);
            const handle = container.querySelector('.swipe-handle');
            const maxMove = container.offsetWidth - handle.offsetWidth;
            if (currentX >= maxMove * 0.9) {
                handle.style.transition = 'transform 0.2s';
                handle.style.transform = `translateX(${maxMove}px)`;
                setTimeout(() => {
                    playCheckInFeedback();
                    playCheckInBeep();
                    doCheckIn(id);
                }, 200);
            } else {
                handle.style.transition = 'transform 0.3s ease';
                handle.style.transform = 'translateX(0)';
                container.style.background = '#eee';
            }
            currentX = 0;
        }

        // --- Render ---
        function render() {
            updateHeader();
            cleanupFinishedFlights();

            if (boardMode) {
                renderDepartureBoard();
                return;
            }

            const list = document.getElementById('flightList');

            const displayFlights = flights.filter(f => {
                const status = getStatus(f);
                const isHistory = (status === 'ARRIVED' || status === 'NOSHOW');
                return currentTab === 'upcoming' ? !isHistory : isHistory;
            });



            let summaryHtml = '';
            if (currentTab === 'history' && displayFlights.length > 0) {
                const totalFlights = displayFlights.length;
                const arrivedCount = displayFlights.filter(f => getStatus(f) === 'ARRIVED').length;
                const totalMinutes = displayFlights
                    .filter(f => getStatus(f) === 'ARRIVED')
                    .reduce((sum, f) => sum + Number(f.duration), 0);

                const days = Math.floor(totalMinutes / 1440);
                const hours = Math.floor((totalMinutes % 1440) / 60);
                const mins = totalMinutes % 60;

                let timeStr = "";
                if (days > 0) timeStr += `${days}d `;
                timeStr += `${hours}h ${mins}m`;

                let rankTitle = "BEGINNER";
                let rankColor = "#fff";
                if (totalMinutes >= 6000) { rankTitle = "SKY LEGEND"; rankColor = "var(--gold)"; }
                else if (totalMinutes >= 1440) { rankTitle = "CLOUD DWELLER"; rankColor = "#e5e4e2"; }
                else if (totalMinutes >= 600) { rankTitle = "SKY RUNNER"; rankColor = "#87ceeb"; }

                summaryHtml = `
            <div style="background: var(--ana-gradient); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,68,130,0.2); position: relative; overflow: hidden;">
                <div style="position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.1; transform: rotate(-20deg);">✈</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <div style="font-size: 0.75rem; opacity: 0.8; letter-spacing: 1.5px;">TOTAL AIR TIME</div>
                    <div style="font-size: 0.7rem; font-weight: bold; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; color: ${rankColor}; border: 1px solid ${rankColor}55;">${rankTitle}</div>
                </div>
                <div style="font-size: 2.2rem; font-weight: bold; font-family: sans-serif; margin-bottom: 15px;">${timeStr}</div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
                    <div><div style="font-size: 0.7rem; opacity: 0.8;">搭乗回数</div><div style="font-size: 1.1rem; font-weight: bold;">${totalFlights} <span style="font-size: 0.7rem;">回</span></div></div>
                    <div style="text-align: center;"><div style="font-size: 0.7rem; opacity: 0.8;">定時搭乗率</div><div style="font-size: 1.1rem; font-weight: bold;">${Math.round((arrivedCount / totalFlights) * 100)}%</div></div>
                    <div style="text-align: right;"><div style="font-size: 0.7rem; opacity: 0.8;">累計マイル</div><div style="font-size: 1.1rem; font-weight: bold; color: var(--gold);">${totalMinutes.toLocaleString()}</div></div>
                </div>
            </div>`;
            }

            if (displayFlights.length === 0) {
                list.innerHTML = summaryHtml + `<div style="text-align:center; color:#999; margin-top:50px">${currentTab === 'upcoming' ? 'これからの予定はありません' : '搭乗履歴はありません'}</div>`;
                return;
            }

            // 3. 並び替え
            displayFlights.sort((a, b) => {
                // 日付と時刻を結合して正確な比較用オブジェクトを作る
                const dateTimeA = new Date(`${a.date}T${a.time}`).getTime();
                const dateTimeB = new Date(`${b.date}T${b.time}`).getTime();

                if (currentTab === 'upcoming') {
                    // 【Upcoming】出発が近いもの（時刻が早い順）を上に
                    return dateTimeA - dateTimeB;
                } else {
                    // 【History】最近乗ったもの（時刻が遅い順）を上に
                    return dateTimeB - dateTimeA;
                }
            });



            // 4. 描画
            // 4. 描画
            list.innerHTML = summaryHtml + displayFlights.map(f => {
                const status = getStatus(f);
                const canCheckIn = isCheckInOpen(f);
                const isHistory = (status === 'ARRIVED' || status === 'NOSHOW');

                const dateObj = new Date(f.date || new Date());
                const dateStr = dateObj.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', weekday: 'short' });
                const [h, m] = f.time.split(':').map(Number);
                const depDate = new Date(dateObj); depDate.setHours(h, m, 0, 0);
                const arrDate = new Date(depDate.getTime() + f.duration * 60000);
                const arrTimeStr = arrDate.getHours().toString().padStart(2, '0') + ':' + arrDate.getMinutes().toString().padStart(2, '0');
                const bgClass = getBgClass(f.time);
                const skyClass = bgClass.replace('bg-', 'sky-');

                // --- カウントダウンの計算 ---
                let countdownHtml = '';
                if (status === 'RESERVED' || status === 'CHECKEDIN') {
                    const now = new Date();
                    const diffMs = depDate - now; // 出発までのミリ秒

                    if (diffMs > 0) {
                        const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                        let countdownText = diffHrs > 0 ? `${diffHrs}h${diffMins}m` : `${diffMins}m`;

                        countdownHtml = `
                    <div style="background: rgba(255,255,255,0.15); border-radius: 6px; padding: 4px 10px; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 0.7rem; letter-spacing: 1px; opacity: 0.8;">DEPARTURE IN</span>
                        <span style="font-size: 0.9rem; font-weight: bold; color: var(--diamond);">${countdownText}</span>
                    </div>
                `;
                    }
                }

                let inflightExtra = "";
                if (status === 'INFLIGHT') {
                    inflightExtra = `
                <div class="airplane-window">
                    <div class="sky-view ${skyClass}">
                        <div class="cloud-particle" style="width:50px; height:20px; top:20%;"></div>
                        <div class="cloud-particle" style="width:70px; height:25px; top:50%; animation-delay:-5s;"></div>
                        <div class="cloud-particle" style="width:40px; height:15px; top:75%; animation-delay:-10s;"></div>
                    </div>
                </div>
                <div style="text-align:center; font-size:0.6rem; color:rgba(255,255,255,0.7); margin-bottom:10px;">
                    Cruising at 35,000ft
                </div>`;
                }

                const priorityGroup = (f.boardingClass === 'FIRST') ? 1 : (f.boardingClass === 'BUSINESS') ? 2 : 3;
                const gateLabel = f.from.charAt(0).toUpperCase() + (String(f.id).slice(-1));
                const getWorkStyle = (seat) => {
                    if (!seat || seat === 'ANY') return 'Style: Undefined';
                    const letter = seat.slice(-1);
                    if (['A', 'K'].includes(letter)) return 'Deep（集中）';
                    if (['C', 'H'].includes(letter)) return 'Light（気軽）';
                    return 'Normal（標準）';
                };

                // --- 進捗バーの計算 ---
                let progressHtml = '';
                let telemetryHtml = '';
                if (f.checkedIn && !isHistory) {
                    const now = new Date().getTime();
                    const totalDuration = f.duration * 60000;
                    const elapsed = now - depDate.getTime();
                    const percent = Math.min(Math.max((elapsed / totalDuration) * 100, 0), 100);

                    // --- 高度と速度のシミュレーションロジック ---
                    let altitude = 0;
                    let speed = 0;

                    // 景色の定義
                    let windowContent = '';
                    if (status === 'INFLIGHT') {

                        if (percent < 15) {
                            // 上昇中（最初の15%）
                            altitude = Math.floor((percent / 15) * 35000);
                            speed = Math.floor(150 + (percent / 15) * 350);
                        } else if (percent > 85) {
                            // 降下中（最後の15%）
                            altitude = Math.floor(((100 - percent) / 15) * 35000);
                            speed = Math.floor(150 + ((100 - percent) / 15) * 350);
                        } else {
                            // 巡航中
                            altitude = 35000 + Math.floor(Math.random() * 100); // 少し揺らぎを出す
                            speed = 500 + Math.floor(Math.random() * 10);
                        }

                        telemetryHtml = `
            <div style="display: flex; justify-content: space-around; width: 100%; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                <div style="text-align: center;">
                    <div style="font-size: 0.6rem; opacity: 0.7;">ALTITUDE</div>
                    <div style="font-size: 0.9rem; font-weight: bold; font-family: monospace;">${altitude.toLocaleString()} <span style="font-size: 0.6rem;">ft</span></div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 0.6rem; opacity: 0.7;">GROUND SPEED</div>
                    <div style="font-size: 0.9rem; font-weight: bold; font-family: monospace;">${speed} <span style="font-size: 0.6rem;">kts</span></div>
                </div>
            </div>
        `;


                        // 【飛行中】上空の景色
                        windowContent = `
                    <div class="sky-view ${skyClass}" style="width:100%; height:100%;">
                        <div class="cloud-particle" style="top:25%; width:30px; height:10px; left:10%;"></div>
                        <div class="cloud-particle" style="top:55%; width:40px; height:15px; left:40%; animation-delay:-5s;"></div>
                    </div>`;
                    } else {
                        // 【出発前】深みのある地上の景色
                        windowContent = `
                    <div style="width: 100%; height: 100%; background: linear-gradient(to bottom, 
                        #4a90e2 0%,      /* 空の高いところ */
                        #87ceeb 45%,     /* 地平線付近の明るい空 */
                        #cfe2f3 54%,     /* 地平線の霞み */
                        #7da438 56%,     /* 遠くの緑（少し薄い） */
                        #5a8226 100%     /* 手前の緑（濃い） */
                    );">
                        <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%); pointer-events:none;"></div>
                    </div>`;
                    }

                    // 演出：出発の瞬間（0%〜2.5%）はシェードを閉じる(0%)、それ以外は開ける(-100%)
                    const shadeTransform = (status === 'INFLIGHT' && percent < 2.5)
                        ? 'translateY(0%)'
                        : 'translateY(-100%)';

                    progressHtml = `
                <div class="flight-main-content" style="display: flex; flex-direction: column; align-items: center; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                    <div style="width: 100%; margin-top: 5px;">
                        <div class="progress-container" style="width:100%; height:4px; background: rgba(255,255,255,0.2); border-radius:2px; position:relative;">
                            <div class="progress-bar" style="width: ${percent}%; height:100%; background: white;"></div>
                            <div class="progress-plane" style="position:absolute; left: ${percent}%; top:-8px; transform:translateX(-50%); color: white; font-size:12px;">✈</div>
                        </div>
                    </div>
                    ${telemetryHtml}
                </div>`;
                }

                return `
    <div class="flight-card ${isHistory ? 'history' : ''} dynamic-bg ${bgClass}" data-id="${f.id}">
        ${status === 'NOSHOW' ? '<div class="noshow-overlay"><div class="noshow-stamp">NO SHOW</div></div>' : ''}
        ${status === 'ARRIVED' ? '<div class="noshow-overlay"><div class="noshow-stamp" style="border-color:var(--gold); color:var(--gold);">ARRIVED</div></div>' : ''}
        
        <div class="card-inner">
            <button class="status-badge" onclick="toggleFocusMode(${f.id})" style="margin-top: 10px; width: 100%; background: rgba(0,0,0,0.8); color: white; border: 1px solid white; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;">集中モードを起動</button>
            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px;">
                <span style="font-size: 0.9rem;">📅</span> ${dateStr}
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span class="status-badge badge-${status.toLowerCase()}">${status}</span>
                <span style="font-size:0.8rem; color:rgba(255,255,255,0.5)">#${String(f.id).slice(-4)}</span>
            </div>
            <div class="route-row">
                <div class="city-box"><div class="city-code" style="color:white !important;">${f.from}</div><div class="city-name" style="color:rgba(255,255,255,0.8) !important;">${f.fromName}</div></div>
                <div style="color:rgba(255,255,255,0.8)">✈</div>
                <div class="city-box"><div class="city-code" style="color:white !important;">${f.to}</div><div class="city-name" style="color:rgba(255,255,255,0.8) !important;">${f.toName}</div></div>
            </div>
            <div class="time-row" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);">
                <div class="time-box"><div class="time-label" style="color:rgba(255,255,255,0.7) !important;">DEP</div><div class="time-value" style="color:white !important; font-size:1.4rem;">${f.time}${countdownHtml}</div></div>
                <div class="duration-center" style="color:rgba(255,255,255,0.6)">⎯ ${f.duration}m ⎯</div>
                <div class="time-box"><div class="time-label" style="color:rgba(255,255,255,0.7) !important;">ARR</div><div class="time-value" style="color:white !important; font-size:1.4rem;">${arrTimeStr}</div></div>
            </div>

            ${progressHtml}

            ${isHistory ? `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.3);">
                    <div style="font-size:0.75rem; font-weight:bold; color:${status === 'ARRIVED' ? 'var(--gold)' : 'rgba(255,255,255,0.5)'}">
                        ${status === 'ARRIVED' ? `1. LOGGED: +${f.duration} MILES` : '0 MILES (NO SHOW)'}
                    </div>
                    <button onclick='repeatFlight(${JSON.stringify(f)})' style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; cursor: pointer;">再予約 ✈</button>
                </div>` : ''}

            ${(status === 'RESERVED' && currentTab === 'upcoming') ? getCheckInUI(f, canCheckIn) : ''}
            ${(status === 'CHECKEDIN' && currentTab === 'upcoming') ? `<div style="text-align:center; color:white; font-size:0.8rem; margin-top:10px; font-weight:bold;">✓ チェックイン済み</div>` : ''}
        </div>

        ${(f.checkedIn && !isHistory) ? `
            <button class="toggle-pass-btn" onclick="toggleBoardingPass(this)" style="background: rgba(255,255,255,0.15); border: 1px dashed rgba(255,255,255,0.5); color: white;">搭乗券を表示</button>
            <div class="boarding-pass-container">
                <div class="boarding-pass" style="padding:0; overflow:hidden; border-radius:15px; position:relative;">
                    <div style="background: var(--ana-blue-main); color: white; padding: 10px; text-align: center; font-size: 0.7rem; font-weight: bold; letter-spacing: 2px;">
                        THE AIRLINE BOARDING PASS
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">TASK LOCATION</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--ana-blue-main);">${f.from} → ${f.to}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">TASK CLASS</div>
                                <div style="font-size: 0.9rem; font-weight: bold;">${f.boardingClass || 'ECONOMY'}</div>
                            </div>
                        </div>

                        <div class="boarding-pass-inner" style="position: relative; background: white; padding: 20px 15px; border-radius: 12px; border: 1px dashed #ccc; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div id="qrcode-${f.id}" style="background: white; padding: 5px; display: flex; justify-content: center;"></div>
                            <div style="font-size: 0.6rem; color: #999; margin-top: 8px; letter-spacing: 1px;">SCAN TO SHARE</div>
                            
                            <div style="position: absolute; width: 20px; height: 20px; background: #eee; border-radius: 50%; top: 50%; left: -11px; transform: translateY(-50%); border: 1px dashed #ccc;"></div>
                            <div style="position: absolute; width: 20px; height: 20px; background: #eee; border-radius: 50%; top: 50%; right: -11px; transform: translateY(-50%); border: 1px dashed #ccc;"></div>
                        </div>
                        
                        <div style="text-align: center; padding: 20px 0 10px 0;">
                            <div style="font-size: 0.65rem; color: #888; font-weight: bold;">ASSIGNED WORK STYLE</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--ana-blue-main); line-height: 1.2;">
                                ${getWorkStyle(f.seat)}<br>
                                <span style="font-size: 0.8rem; color: #888; font-weight: normal;">SEAT: ${f.seat}</span>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; border-top: 1px dashed #ccc; padding-top: 15px;">
                            <div>
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">PRIORITY</div>
                                <div style="font-size: 1.2rem; font-weight: bold;"><span style="background: #000; color: #fff; padding: 2px 8px; border-radius: 4px;">${priorityGroup}</span></div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: #888; font-weight: bold;">GATE (SPOT)</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">${gateLabel}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>` : ''}
    </div>`;
            }).join('');

            displayFlights.forEach(f => {
                const qrContainer = document.getElementById(`qrcode-${f.id}`);
                if (qrContainer) {
                    // データをURL化（btoaでエンコード）
                    // render関数の最後のループ内
                    const data = `${f.from},${f.to},${f.date},${f.time},${f.duration},${f.boardingClass},${f.seat}`;
                    const shareUrl = `${window.location.origin}${window.location.pathname}?add=${btoa(data)}`;

                    qrContainer.innerHTML = ""; // 重複防止
                    new QRCode(qrContainer, {
                        text: shareUrl,
                        width: 80,  // 搭乗券に収まるサイズ
                        height: 80,
                        colorDark: "#000000", // ANAブルー
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }
            });



        }

        // --- Other Functions ---
        function doCheckIn(id) {
            flights = flights.map(f => f.id === id ? { ...f, checkedIn: true } : f);
            localStorage.setItem('ana_flights_final', JSON.stringify(flights));
            render();
        }

        function saveFlight() {
            // HTMLのIDと一致させる (dateInput → flightDate)
            const fromCode = document.getElementById('fromSelect').value;
            const toCode = document.getElementById('toSelect').value;
            const dateVal = document.getElementById('flightDate').value;
            const timeVal = document.getElementById('timeInput').value;
            const durationVal = parseInt(document.getElementById('durationInput').value) || 60;
            const classVal = document.getElementById('classSelect').value;

            const fromAp = airports.find(a => a.code === fromCode);
            const toAp = airports.find(a => a.code === toCode);

            // バリデーション
            if (!dateVal || !timeVal) {
                alert('日付と時刻を入力してください');
                return;
            }

            const f = {
                id: Date.now(),
                date: dateVal,
                from: fromCode,
                fromName: fromAp ? fromAp.name : '',
                to: toCode,
                toName: toAp ? toAp.name : '',
                time: timeVal,
                duration: durationVal,
                seat: tempSeat || 'ANY',
                boardingClass: classVal,
                checkedIn: false,
                notifiedCheckIn: false,
                notifiedLastCall: false
            };

            flights.push(f);
            localStorage.setItem('ana_flights_final', JSON.stringify(flights));
            closeModal('newFlightModal');
            render();
        }

        function initSeatMap() {
            const grid = document.getElementById('seatGrid');
            grid.innerHTML = '';

            const selectedClass = document.getElementById('classSelect').value;

            for (let r = 1; r <= 20; r++) {
                let rowClass = (r <= 2) ? 'FIRST' : (r <= 7) ? 'BUSINESS' : 'ECONOMY';
                const isLocked = (rowClass !== selectedClass);
                const row = document.createElement('div');
                row.className = 'seat-row';
                if (isLocked) row.style.opacity = "0.3";
                ['A', 'B', 'C'].forEach(c => createSeat(row, r, c, isLocked, rowClass));
                const aisle = document.createElement('div'); aisle.className = 'aisle-gap'; aisle.innerText = r; row.appendChild(aisle);
                ['H', 'J', 'K'].forEach(c => createSeat(row, r, c, isLocked, rowClass));
                grid.appendChild(row);
            }
        }

        function createSeat(container, r, c, isLocked, rowClass) {
            const s = document.createElement('div');
            s.className = `seat seat-${rowClass.toLowerCase()}`;

            // スタイル判定省略、CSSクラスで制御

            s.innerHTML = `<span style="font-size:0.8rem; font-weight:bold;">${c}</span>`;

            if (isLocked) {
                s.style.cursor = 'not-allowed';
                s.style.background = '#e5e5e5';
                s.style.color = '#ccc';
                s.style.boxShadow = 'none';
                s.style.border = '1px solid #ddd';
                s.style.opacity = '0.6';
            } else {
                s.onclick = () => {
                    if (isLocked) return;
                    document.querySelectorAll('.seat').forEach(x => x.classList.remove('selected'));
                    s.classList.add('selected');
                    tempSeat = r + c;

                    // Add subtle haptic feedback visual
                    s.style.transform = "scale(0.9)";
                    setTimeout(() => s.style.transform = "scale(1)", 150);
                };
            }
            container.appendChild(s);
        }

        function requestNotification() {
            if (!("Notification" in window)) return alert("非対応ブラウザです");
            Notification.requestPermission().then(p => {
                if (p === "granted") {
                    document.getElementById('notifBtn').style.filter = "none";
                    new Notification("通知設定完了", { body: "準備が整いました。" });
                }
            });
        }

        function sendNotification(f) {
            if (Notification.permission === "granted" && !notifiedFlights.has(f.id)) {
                new Notification("搭乗手続きのご案内", { body: `${f.from} ✈ ${f.to} 便の受付が始まりました。` });
                notifiedFlights.add(f.id);
            }
        }

        function showInAppBanner(f) {
            if (bannerShownFor.has(f.id)) return;
            const banner = document.getElementById('notifBanner');
            document.getElementById('notifText').innerText = `搭乗手続きのご案内: ${f.from} ✈ ${f.to}`;
            banner.classList.add('show');
            setTimeout(hideBanner, 8000);
            bannerShownFor.add(f.id);
        }

        function hideBanner() { document.getElementById('notifBanner').classList.remove('show'); }

        function mainLoop() {
            render(); // 10秒おきにステータスをチェックして自動振り分け
            flights.forEach(f => {
                if (getStatus(f) === 'RESERVED' && isCheckInOpen(f)) {
                    sendNotification(f);
                    showInAppBanner(f);
                }
            });
        }

        let currentBookingStep = 1;

        function openNewFlightModal() {
            tempSeat = null;
            document.getElementById('seatLabel').innerText = '未指定';
            updateHeader();
            updateSelectOptions();

            // Step Reset
            currentBookingStep = 1;

            // Set default date if empty
            if (!document.getElementById('flightDate').value) {
                document.getElementById('flightDate').value = new Date().toISOString().split('T')[0];
            }

            updateBookingStepUI();
            document.getElementById('newFlightModal').style.display = 'flex';
        }

        function updateBookingStepUI() {
            // Hide all
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`booking-step-${i}`).style.display = 'none';
            }

            // Show current
            document.getElementById(`booking-step-${currentBookingStep}`).style.display = 'block';

            // Update Buttons
            const btnBack = document.getElementById('btn-back');
            const btnNext = document.getElementById('btn-next');
            const btnConfirm = document.getElementById('btn-confirm');
            const modalTitle = document.getElementById('modalTitle');

            if (currentBookingStep === 1) {
                btnBack.style.display = 'none';
                btnNext.style.display = 'block';
                btnNext.style.width = '100%';
                btnConfirm.style.display = 'none';
                modalTitle.innerText = "フライト予約 (1/3)";
            } else if (currentBookingStep === 2) {
                btnBack.style.display = 'block';
                btnNext.style.display = 'block';
                btnNext.style.width = '65%';
                btnConfirm.style.display = 'none';
                modalTitle.innerText = "フライト予約 (2/3)";
            } else {
                btnBack.style.display = 'block';
                btnNext.style.display = 'none';
                btnConfirm.style.display = 'block';
                btnConfirm.style.width = '65%';
                modalTitle.innerText = "フライト予約 (3/3)";
            }
        }

        function nextBookingStep() {
            // Validation
            if (currentBookingStep === 1) {
                const f = document.getElementById('fromSelect').value;
                const t = document.getElementById('toSelect').value;
                if (!f || !t) { alert('出発地と到着地を選択してください'); return; }
                if (f === t) { alert('出発地と到着地は異なる場所を選択してください'); return; }
            } else if (currentBookingStep === 2) {
                const d = document.getElementById('flightDate').value;
                const time = document.getElementById('timeInput').value;
                if (!d || !time) { alert('日時を入力してください'); return; }
            }

            if (currentBookingStep < 3) {
                currentBookingStep++;
                updateBookingStepUI();
            }
        }

        function prevBookingStep() {
            if (currentBookingStep > 1) {
                currentBookingStep--;
                updateBookingStepUI();
            }
        }
        function openAirportModal() { renderAirportList(); document.getElementById('airportModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openSeatMap() { initSeatMap(); document.getElementById('seatModal').style.display = 'flex'; }
        function confirmSeat() { if (tempSeat) document.getElementById('seatLabel').innerText = tempSeat; closeModal('seatModal'); }
        function updateSelectOptions() {
            const html = airports.map(a => `<option value="${a.code}">${a.code} - ${a.name}</option>`).join('');
            document.getElementById('fromSelect').innerHTML = html;
            document.getElementById('toSelect').innerHTML = html;
            if (airports.length > 1) document.getElementById('toSelect').selectedIndex = 1;
        }
        function renderAirportList() {
            document.getElementById('airportListUi').innerHTML = airports.map((a, i) => `<li class="airport-item"><span class="airport-code-tag">${a.code}</span><strong>${a.name}</strong><button class="delete-btn" onclick="deleteAirport(${i})">×</button></li>`).join('');
        }
        function addAirport() {
            const c = document.getElementById('newAirportCode').value.toUpperCase();
            const n = document.getElementById('newAirportName').value;
            if (c && n) { airports.push({ code: c, name: n }); localStorage.setItem('my_airports', JSON.stringify(airports)); renderAirportList(); }
        }
        function deleteAirport(i) { airports.splice(i, 1); localStorage.setItem('my_airports', JSON.stringify(airports)); renderAirportList(); }

        if (Notification.permission === "granted") document.getElementById('notifBtn').style.filter = "none";
        render();
        setInterval(mainLoop, 10000);

        function repeatFlight(f) {
            switchTab('upcoming');
            openNewFlightModal();

            setTimeout(() => {
                document.getElementById('fromSelect').value = f.from;
                document.getElementById('toSelect').value = f.to;
                document.getElementById('durationInput').value = f.duration;
                document.getElementById('classSelect').value = f.boardingClass || 'ECONOMY';

                // IDを修正: dateInput → flightDate
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('flightDate').value = today;

                tempSeat = null;
                document.getElementById('seatLabel').innerText = `未指定 (前回: ${f.seat})`;

                const now = new Date();
                now.setMinutes(now.getMinutes() + 10);
                const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                document.getElementById('timeInput').value = timeStr;
            }, 100);
        }

        function toggleBoardingPass(btn) {
            const container = btn.nextElementSibling;
            const overlay = document.getElementById('focusOverlay');
            const isOpen = container.classList.toggle('open');

            btn.classList.toggle('active');
            btn.textContent = isOpen ? '搭乗券を閉じる' : '搭乗券を表示';

            if (isOpen) {
                overlay.classList.add('active');
                // 他の要素が重ならないようにカードを最前面へ
                btn.parentElement.style.zIndex = "1001";
            } else {
                overlay.classList.remove('active');
                btn.parentElement.style.zIndex = "";
            }
        }

        // 背景をタップした時に閉じる用
        function closeAllPasses() {
            const openPasses = document.querySelectorAll('.boarding-pass-container.open');
            openPasses.forEach(container => {
                const btn = container.previousElementSibling;
                container.classList.remove('open');
                btn.classList.remove('active');
                btn.textContent = '搭乗券を表示';
                btn.parentElement.style.zIndex = "";
            });
            document.getElementById('focusOverlay').classList.remove('active');
        }

        function getBgClass(timeStr) {
            const hour = parseInt(timeStr.split(':')[0]);
            if (hour >= 5 && hour < 10) return 'bg-dawn';   // 5:00 - 9:59
            if (hour >= 10 && hour < 16) return 'bg-day';   // 10:00 - 15:59
            if (hour >= 16 && hour < 19) return 'bg-sunset'; // 16:00 - 18:59
            return 'bg-night';                               // それ以外（夜）
        }

        let isFocusMode = false;
        const cabinAudio = document.getElementById('cabinNoise');

        function toggleFocusMode() {
            const screen = document.getElementById('focusModeScreen');
            const content = document.getElementById('focusContent');
            const announcement = document.getElementById('announcementBar');
            const annText = document.getElementById('announcementText');

            isFocusMode = !isFocusMode;

            if (isFocusMode) {
                const activeFlight = flights.find(f => getStatus(f) === 'INFLIGHT');

                // テスト用：もし飛行中の便がなければ、強制的にダミーデータで起動させる場合はここをコメントアウト解除
                /*
                if (!activeFlight) {
                     alert("現在飛行中のフライトが必要です");
                     isFocusMode = false; return;
                }
                */

                // 本番用チェック（もしダミーを使わないならこのまま）
                if (!activeFlight) {
                    alert("現在飛行中のフライトが必要です");
                    isFocusMode = false; return;
                }

                startCabinNoise();
                document.querySelector('.my-app-bottom-nav').style.display = 'none';

                // ★修正ポイント：background:#000 を transparent に変更！
                content.innerHTML = `
    <div id="focus-wrapper" style="position:relative; width:100%; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; background: transparent; overflow:hidden;">
        
        <div id="focus-dynamic-content"></div>

        <button onclick="toggleFocusMode()" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); border:1px solid rgba(255,255,255,0.3); color:#fff; padding:10px 25px; border-radius:30px; font-size:14px; font-weight:bold; cursor:pointer; z-index:10001;">
            CLOSE WINDOW
        </button>
    </div>
`;

                const dynamicPart = document.getElementById('focus-dynamic-content');
                updateFocusUI(activeFlight, dynamicPart);
                window.focusTimer = setInterval(() => updateFocusUI(activeFlight, dynamicPart), 1000);

                screen.classList.add('active');
                document.body.classList.add('focus-active');
            } else {
                stopCabinNoise();
                clearInterval(window.focusTimer);
                screen.classList.remove('active');
                document.body.classList.remove('focus-active');
                document.querySelector('.my-app-bottom-nav').style.display = 'flex';
            }
        }

        function updateFocusUI(f, container) {
            const now = new Date().getTime();
            const [h, m] = f.time.split(':').map(Number);
            const depT = new Date(f.date).setHours(h, m);
            const elapsed = now - depT;
            const totalMs = f.duration * 60000;
            const percent = Math.min(Math.max((elapsed / totalMs) * 100, 0), 100);
            const remainingMins = Math.max(0, f.duration - Math.floor(elapsed / 60000));

            if (!document.getElementById('focus-window-body')) {
                const hour = new Date().getHours();
                let skyGradient = 'linear-gradient(to bottom, #1e90ff 0%, #87ceeb 100%)';
                if (hour >= 18 || hour < 6) skyGradient = 'linear-gradient(to bottom, #001a33 0%, #004482 100%)';

                container.innerHTML = `
    <div id="focus-window-body" style="text-align:center;">
        <div style="font-size: 0.8rem; letter-spacing: 4px; color: white; opacity: 0.9; margin-bottom: 20px; text-shadow: 0 2px 4px black;">CRUISING</div>
        
        <div class="window-outer-frame">
            <div class="window-inner-frame" onclick="toggleShade()" style="position:relative;">
                <div class="sky-background" style="background: ${skyGradient}; position:absolute; top:0; left:0; width:100%; height:100%; z-index:1;">
                    <div class="real-cloud" style="top:25%; transform:scale(0.5); animation-duration: 12s; opacity: 0.5;"></div>
                    <div class="real-cloud" style="top:45%; transform:scale(1.2); animation-duration: 25s; animation-delay: -5s;"></div>
                    <div class="real-cloud" style="top:75%; transform:scale(1.8); animation-duration: 40s; animation-delay: -15s; filter: blur(12px); opacity: 0.4;"></div>
                </div>
                <div id="window-shade">
                    <div class="shade-handle"></div>
                </div>
            </div>
        </div>

        <div class="info-glass-panel">
            <div class="focus-text-bold focus-route">${f.from} ✈ ${f.to}</div>
            
            <div style="width:100%; height:2px; background:rgba(255,255,255,0.2); margin:20px auto; position:relative;">
                <div style="position:absolute; width:100%; height:100%; background-image: linear-gradient(to right, white 50%, transparent 50%); background-size: 15px 100%; opacity: 0.3;"></div>
                <div id="focus-plane" style="position:absolute; top:-10px; font-size:16px; transition: left 1s linear; color:white;">✈</div>
            </div>

            <div id="focus-timer-text"></div>
        </div>

        <div style="font-size: 0.75rem; color: white; opacity: 0.8; margin-top: 20px; font-style: italic; text-shadow: 0 1px 3px black;">
            "Enjoy your flight over the clouds."
        </div>
    </div>
`;
            }

            // 数値と飛行機の位置を更新
            const plane = document.getElementById('focus-plane');
            if (plane) plane.style.left = `calc(${percent}% - 9px)`; // アイコンの半分ずらして中心に合わせる

            const timerText = document.getElementById('focus-timer-text');
            if (timerText) timerText.innerText = `到着まで: ${remainingMins} 分`;
        }

        function toggleShade() {
            const shade = document.getElementById('window-shade');
            const screen = document.getElementById('focusModeScreen'); // ★ここを修正

            if (shade && screen) {
                const isClosing = shade.classList.toggle('shade-closed');

                if (isClosing) {
                    // 閉じた時：機内を暗くする（夜間飛行モード）
                    screen.style.background = "radial-gradient(circle at center, #2c3e50 0%, #000 100%)";
                } else {
                    // 開いた時：機内を明るくする
                    screen.style.background = "radial-gradient(circle at center, #e6e9ed 0%, #bdc3c7 100%)";
                }
            }
        }

        let audioCtx = null;
        let noiseNode = null;
        let filterNode = null;

        function startCabinNoise() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            if (noiseNode) return;

            const bufferSize = 2 * audioCtx.sampleRate;
            const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }

            noiseNode = audioCtx.createBufferSource();
            noiseNode.buffer = noiseBuffer;
            noiseNode.loop = true;

            // 低音を強調するフィルター設定
            filterNode = audioCtx.createBiquadFilter();
            filterNode.type = 'lowpass';
            // 150から200に少し上げると、音に厚みが出ます
            filterNode.frequency.setValueAtTime(200, audioCtx.currentTime);

            const gainNode = audioCtx.createGain();
            // ★ここを 0.1 から 0.4 に変更（4倍の音量）
            gainNode.gain.setValueAtTime(1, audioCtx.currentTime);

            noiseNode.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            noiseNode.start();
        }

        function stopCabinNoise() {
            if (noiseNode) {
                noiseNode.stop();
                noiseNode.disconnect();
                noiseNode = null; // リセット
            }
        }

        // 1. フライト情報をURLに変換してQRを表示
        function shareFlight(id) {
            const f = flights.find(x => x.id === id);
            if (!f) return;

            // データを圧縮してURLパラメータを作成
            const data = `${f.from},${f.to},${f.date},${f.time},${f.duration}`;
            const shareUrl = `${window.location.origin}${window.location.pathname}?add=${btoa(data)}`;

            // QRコードの生成
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = ""; // 前のQRをクリア
            new QRCode(qrContainer, {
                text: shareUrl,
                width: 200,
                height: 200
            });

            document.getElementById('qrModal').style.display = 'flex';
        }

        // 2. ページ読み込み時にURLパラメータを確認（受け取り側）
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const addData = params.get('add');
            if (addData) {
                try {
                    // Base64デコードして配列に戻す
                    const decoded = atob(addData).split(',');

                    // データの順番をQR生成時と完全に一致させる
                    // 0:from, 1:to, 2:date, 3:time, 4:duration, 5:class, 6:seat
                    const fromAp = airports.find(a => a.code === decoded[0]);
                    const toAp = airports.find(a => a.code === decoded[1]);

                    const newFlight = {
                        id: Date.now(),
                        from: decoded[0],
                        fromName: fromAp ? fromAp.name : '',
                        to: decoded[1],
                        toName: toAp ? toAp.name : '',
                        date: decoded[2],
                        time: decoded[3],
                        duration: parseInt(decoded[4]),
                        boardingClass: decoded[5] || 'ECONOMY',
                        seat: decoded[6] || 'ANY',
                        checkedIn: false
                    };

                    // 重複チェック（同じ出発地・目的地・時刻なら追加しない）
                    const isDuplicate = flights.some(f => f.from === newFlight.from && f.time === newFlight.time && f.date === newFlight.date);

                    if (!isDuplicate) {
                        flights.push(newFlight);
                        localStorage.setItem('ana_flights_final', JSON.stringify(flights));
                        render();
                        alert("✈️ 共有されたフライトを追加しました！");
                    }

                    // URLからパラメータを消してスッキリさせる
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) {
                    console.error("共有データの読み込みに失敗しました:", e);
                }
            }
        });

        let videoStream = null;

        function startScan() {
            const video = document.getElementById("video");
            const modal = document.getElementById("scanModal");
            document.querySelector('.my-app-bottom-nav').style.display = 'none';
            modal.style.display = "flex";

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
                videoStream = stream;
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                requestAnimationFrame(tick);
            });
        }

        function stopScan() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById("scanModal").style.display = "none";
            document.querySelector('.my-app-bottom-nav').style.display = 'flex';
        }

        function tick() {
            const video = document.getElementById("video");
            const canvasElement = document.getElementById("canvas");
            const canvas = canvasElement.getContext("2d");

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code) {
                    // QRコードの中にURL（?add=...）が含まれているかチェック
                    if (code.data.includes("?add=")) {
                        const url = new URL(code.data);
                        const addData = url.searchParams.get('add');
                        if (addData) {
                            processAddData(addData); // 既存の取り込みロジックへ
                            stopScan();
                            alert("フライトを取り込みました！");
                            return;
                        }
                    }
                }
            }
            if (document.getElementById("scanModal").style.display === "flex") {
                requestAnimationFrame(tick);
            }
        }

        // 受け取りロジックを共通化
        function processAddData(addData) {
            try {
                const decoded = atob(addData).split(',');
                const newFlight = {
                    id: Date.now(),
                    from: decoded[0], to: decoded[1],
                    date: decoded[2], time: decoded[3],
                    duration: parseInt(decoded[4]),
                    boardingClass: decoded[5] || 'ECONOMY',
                    seat: decoded[6] || 'ANY',
                    checkedIn: false
                };
                flights.push(newFlight);
                localStorage.setItem('ana_flights_final', JSON.stringify(flights));
                render();
            } catch (e) { console.error("Invalid QR Data"); }
        }

        setInterval(() => {
            render();
            checkNotifications();
        }, 30000);


        // 集中モード用のメモ機能ロジック
        document.addEventListener('DOMContentLoaded', () => {
            const focusTextarea = document.getElementById('focus-textarea');
            const toggleNoteBtn = document.getElementById('toggle-note');
            const noteContainer = document.getElementById('focus-note-container');

            // 1. 保存されたメモを復元
            const savedNote = localStorage.getItem('ana_inflight_memo');
            if (savedNote) {
                focusTextarea.value = savedNote;
            }

            // 2. 入力するたびに自動保存
            focusTextarea.addEventListener('input', (e) => {
                localStorage.setItem('ana_inflight_memo', e.target.value);
            });

            // 3. メモ帳の表示/非表示切り替え（景色を見たい時用）
            toggleNoteBtn.addEventListener('click', () => {
                if (focusTextarea.style.display === 'none') {
                    focusTextarea.style.display = 'block';
                    toggleNoteBtn.textContent = 'Hide';
                    noteContainer.style.height = 'auto';
                } else {
                    focusTextarea.style.display = 'none';
                    toggleNoteBtn.textContent = 'Show Memo';
                    noteContainer.style.height = '40px';
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const focusMemo = document.getElementById('focus-textarea-box');
            const toggleBtn = document.getElementById('toggle-note-btn');
            const memoContainer = document.getElementById('focus-note-container');

            // 1. ローカルストレージから復元
            const saved = localStorage.getItem('ana_inflight_memo');
            if (saved) focusMemo.value = saved;

            // 2. 入力するたびに保存
            focusMemo.addEventListener('input', (e) => {
                localStorage.setItem('ana_inflight_memo', e.target.value);
            });

            // 3. 表示・非表示の切り替えロジック
            toggleBtn.addEventListener('click', () => {
                if (focusMemo.style.display === 'none') {
                    focusMemo.style.display = 'block';
                    toggleBtn.textContent = 'Hide';
                    memoContainer.style.height = 'auto';
                } else {
                    focusMemo.style.display = 'none';
                    toggleBtn.textContent = 'Show Memo';
                    memoContainer.style.height = '45px';
                }
            });
        });

        function toggleMobileMemo() {
            const panel = document.getElementById('focus-note-panel');
            panel.classList.toggle('memo-open');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('focus-textarea-box');

            // 保存されたメモを読み込み
            const saved = localStorage.getItem('ana_inflight_memo');
            if (saved) textarea.value = saved;

            // 入力ごとに保存
            textarea.addEventListener('input', (e) => {
                localStorage.setItem('ana_inflight_memo', e.target.value);
            });
        });


        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.style.top = '20px';

            setTimeout(() => {
                toast.style.top = '-100px';
            }, 4000);
        }

        function checkNotifications() {
            const now = new Date();

            flights.forEach(f => {
                const [h, m] = f.time.split(':').map(Number);
                const dep = new Date();
                dep.setHours(h, m, 0, 0);

                const diffMin = Math.floor((dep - now) / 60000);

                // Check-in Open（10分前）
                if (
                    diffMin === 10 &&
                    !f.notifiedCheckIn &&
                    !f.checkedIn
                ) {
                    showToast(`✈️ Check-in Open ${f.from} → ${f.to}`);
                    f.notifiedCheckIn = true;
                }

                // Last Call（2分前）
                if (
                    diffMin === 2 &&
                    !f.notifiedLastCall &&
                    !f.checkedIn
                ) {
                    showToast(`⚠️ Last Call ${f.from} → ${f.to}`);
                    f.notifiedLastCall = true;
                }
            });

            localStorage.setItem('ana_flights_v5', JSON.stringify(flights));
        }

        function playCheckInFeedback() {

            // 振動（対応端末のみ）
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        let audioUnlocked = false;

        function unlockAudio() {
            if (audioUnlocked) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            ctx.resume();
            audioUnlocked = true;
        }

        function playCheckInBeep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();

            const gain = ctx.createGain();
            gain.gain.value = 0.0001;
            gain.connect(ctx.destination);

            // メイン音（高音）
            const osc1 = ctx.createOscillator();
            osc1.type = 'sine';
            osc1.frequency.value = 1046; // C6

            // サブ音（厚み）
            const osc2 = ctx.createOscillator();
            osc2.type = 'triangle';
            osc2.frequency.value = 659; // E5

            osc1.connect(gain);
            osc2.connect(gain);

            osc1.start();
            osc2.start();

            // フェードイン（派手）
            gain.gain.exponentialRampToValueAtTime(0.35, ctx.currentTime + 0.1);

            // フェードアウト（余韻）
            gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 2);

            osc1.stop(ctx.currentTime + 3);
            osc2.stop(ctx.currentTime + 3);
        }

        function getBoardStatusLabel(f) {
            const status = getStatus(f);
            switch (status) {
                case 'CHECKEDIN': return 'CHECK-IN';
                case 'INFLIGHT': return 'BOARDING';
                case 'LASTCALL': return 'LAST CALL';
                case 'NOSHOW': return 'NO SHOW';
                default: return 'SCHEDULED';
            }
        }



        function toggleBoardMode() {
            boardMode = !boardMode;
            console.log('boardMode:', boardMode);
            alert('boardMode=' + boardMode);
            render();
        }

        function renderDepartureBoard() {
            const list = document.getElementById('flightList');
            const nowMin = getNowMinutes();

            // ① 時刻を過ぎた外部便を削除
            externalFlights = externalFlights.filter(
                f => timeToMinutes(f.time) >= nowMin
            );

            // ② 減った分を補充
            replenishExternalFlights();

            // ③ 自分の便 + 外部便を統合
            const allFlights = [
                ...flights.map(f => ({
                    flight: getFlightNumber(f),
                    from: f.from,
                    to: f.to,
                    time: f.time,
                    status: getBoardStatusLabel(f),
                    external: false
                })),
                ...externalFlights
            ]
                // ④ 時刻順
                .sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));

            list.innerHTML = `
    <div class="board-frame">
        <div class="board">
            <div class="board-title">DEPARTURES</div>

            <div class="board-row header">
                <span>FLIGHT</span>
                <span>DEP</span>
                <span>TO</span>
                <span>TIME</span>
                <span>STATUS</span>
            </div>

            ${allFlights.map(f => `
                <div class="board-row ${f.external ? 'external' : ''}">
                    <span>${formatFlightDisplay(f)}</span>
                    <span>${formatAirport(f.from, f.external)}</span>
                    <span>${formatAirport(f.to, f.external)}</span>
                    <span>${f.time}</span>
                    <span class="status-${f.status.toLowerCase().replace(' ', '')}">
                        ${f.status}
                    </span>
                </div>
            `).join('')}
        </div>
    </div>
`;
        }



        function cleanupFinishedFlights() {
            flights = flights.filter(f => {
                const status = getStatus(f);
                return status !== 'ARRIVED' && status !== 'NOSHOW';
            });
            localStorage.setItem('ana_flights_v5', JSON.stringify(flights));
        }

        function getFlightNumber(f) {
            return 'TA' + String(f.id).slice(-4);
        }


        function generateExternalFlights(count = 1) {
            const now = new Date();

            return Array.from({ length: count }).map(() => {
                const base = externalFlightsPool[
                    Math.floor(Math.random() * externalFlightsPool.length)
                ];

                const minutesLater = Math.floor(Math.random() * 240) + 5;
                const dep = new Date(now.getTime() + minutesLater * 60000);
                const time =
                    dep.getHours().toString().padStart(2, '0') + ':' +
                    dep.getMinutes().toString().padStart(2, '0');

                return {
                    external: true,
                    airline: base.airline,              // ← 追加
                    flight: base.code + (Math.floor(Math.random() * 900) + 100),
                    from: base.from,
                    to: base.to,
                    time,
                    status: ['SCHEDULED', 'BOARDING', 'DELAYED'][
                        Math.floor(Math.random() * 3)
                    ]
                };
            });
        }


        function timeToMinutes(t) {
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        }

        function getNowMinutes() {
            const now = new Date();
            return now.getHours() * 60 + now.getMinutes();
        }

        function replenishExternalFlights() {
            while (externalFlights.length < EXTERNAL_FLIGHT_TARGET) {
                externalFlights.push(...generateExternalFlights(1));
            }
        }

        function formatFlightDisplay(f) {
            if (f.external && f.airline) {
                return `${f.airline} ${f.flight.slice(2)}`;
            }
            return f.flight; // TASK Airline 等
        }

        function formatAirport(code, isExternal) {
            if (!isExternal) {
                return getMyAirportName(code);
            }
            return airportNameMap[code] || code;
        }

        function getMyAirportName(code) {
            const a = airports.find(a => a.code === code);
            return a ? a.name : code;
        }
    </script>



</body>

</html>
